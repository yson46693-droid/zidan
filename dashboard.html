<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="ูุธุงู ุฅุฏุงุฑุฉ ุดุงูู ููุญูุงุช ุตูุงูุฉ ุงูููุงุชู ุงููุญูููุฉ">
    <meta name="theme-color" content="#2196F3">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ูุญู ุงูุตูุงูู">
    
    <!-- Windows Meta Tags -->
    <meta name="msapplication-TileColor" content="#2196F3">
    <meta name="msapplication-TileImage" content="icons/icon-144x144.png">
    <meta name="msapplication-navbutton-color" content="#2196F3">
    <meta name="msapplication-starturl" content="/index.html">
    <meta name="msapplication-tooltip" content="ูุญู ุตูุงูุฉ ุงูููุงุชู">
    <meta name="msapplication-window" content="width=1024;height=768">
    
    <!-- Meta Tags ูููุชุตูุญุงุช ุงููุฏููุฉ -->
    <meta name="application-name" content="ูุญู ุงูุตูุงูู">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Open Graph (ูููุชุตูุญุงุช ุงููุฏููุฉ) -->
    <meta property="og:title" content="ูุญู ุตูุงูุฉ ุงูููุงุชู">
    <meta property="og:type" content="website">
    <meta property="og:image" content="icons/icon-192x192.png">
    
    <title>ููุญุฉ ุงูุชุญูู - ูุธุงู ุฅุฏุงุฑุฉ ูุญู ุตูุงูุฉ ุงูููุงุชู</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-96x96.png">
    <link rel="shortcut icon" href="favicon.ico">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="icons/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="120x120" href="icons/icon-128x128.png">
    <link rel="apple-touch-icon" sizes="114x114" href="icons/icon-128x128.png">
    <link rel="apple-touch-icon" sizes="76x76" href="icons/icon-96x96.png">
    <link rel="apple-touch-icon" sizes="72x72" href="icons/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="60x60" href="icons/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="57x57" href="icons/icon-72x72.png">
    
    <!-- Bootstrap Icons - ุชุญููู ุบูุฑ ูุชุฒุงูู ูุชุญุณูู ุงูุฃุฏุงุก -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"></noscript>
    
    <!-- Preconnect ููุฎูุงุฏู ุงูุฎุงุฑุฌูุฉ ูุชุญุณูู ุงูุฃุฏุงุก -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    
    <!-- ุชุญููู ููู ุงูุฅุตุฏุงุฑุงุช ุฃููุงู -->
    <script src="js/version.js"></script>
    <script>
        // ุงุณุชุฎุฏุงู ุฑูู ุงูุฅุตุฏุงุฑ ูู window.APP_VERSION (ูุนุฑูู ูู version.js)
        // ูุง ูุนูุฏ ุชุนุฑูู APP_VERSION ูุชุฌูุจ ุฎุทุฃ redeclaration
        (function() {
            // ุงูุชุธุงุฑ ุชุญููู version.js
            const getAppVersion = function() {
                return window.APP_VERSION || 'v' + Date.now();
            };
            
            const VERSION_PARAM = '?v=' + getAppVersion();
            
            // ุฅุถุงูุฉ query parameters ูุฌููุน ูููุงุช CSS/JS ูุถูุงู ุนุฏู ุนุฑุถ ูุงุด ูุฏูู
            document.addEventListener('DOMContentLoaded', function() {
                const version = getAppVersion();
                const versionParam = '?v=' + version;
                
                // ุชุญุฏูุซ ูููุงุช CSS
                const cssLinks = document.querySelectorAll('link[rel="stylesheet"]:not([href^="http"])');
                cssLinks.forEach(link => {
                    if (link.href && !link.href.includes('?')) {
                        link.href = link.href + versionParam;
                    }
                });
                
                // ุชุญุฏูุซ ูููุงุช JS (ุจุงุณุชุซูุงุก version.js)
                const jsScripts = document.querySelectorAll('script[src]:not([src*="version.js"]):not([src^="http"])');
                jsScripts.forEach(script => {
                    if (script.src && !script.src.includes('?')) {
                        script.src = script.src + versionParam;
                    }
                });
            });
        })();
    </script>
    
    <!-- Critical CSS - ุชุญููู ููุฑู -->
    <link rel="stylesheet" href="css/style.css">
    
    <!-- Non-Critical CSS - ุชุญููู ุบูุฑ ูุชุฒุงูู -->
    <link rel="preload" href="css/dark-mode.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="css/dark-mode.css"></noscript>
    
    <link rel="preload" href="css/security.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="css/security.css"></noscript>
    
    <!-- Quagga - ุชุญููู ููุท ุนูุฏ ุงูุญุงุฌุฉ (lazy load) -->
    <script>
        // ุชุญููู Quagga ููุท ุนูุฏ ุงูุญุงุฌุฉ (ุนูุฏ ูุชุญ ูุณู ุงูุจุงุฑููุฏ)
        window.loadQuagga = function() {
            if (window.quaggaLoaded) return Promise.resolve();
            window.quaggaLoaded = true;
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js';
                script.async = true;
                script.onload = () => resolve();
                script.onerror = () => reject(new Error('Failed to load Quagga'));
                document.head.appendChild(script);
            });
        };
    </script>
</head>
<body>
  
    <nav class="mobile-navbar" id="mobileNavbar">
        <div class="mobile-nav-container">
            <a href="#dashboard" class="mobile-nav-item active" onclick="showSection('dashboard')">
                <i class="bi bi-speedometer2"></i>
                <span>ุงูุชุญูู</span>
            </a>
            <a href="#repairs" class="mobile-nav-item" onclick="showSection('repairs')">
                <i class="bi bi-tools"></i>
                <span>ุงูุตูุงูุฉ</span>
            </a>
            <a href="#customers" class="mobile-nav-item" onclick="showSection('customers')">
                <i class="bi bi-people"></i>
                <span>ุงูุนููุงุก</span>
            </a>
            <a href="#inventory" class="mobile-nav-item" onclick="showSection('inventory')">
                <i class="bi bi-box-seam"></i>
                <span>ุงููุฎุฒูู</span>
            </a>
            <a href="pos.html" class="mobile-nav-item">
                <i class="bi bi-cash-register"></i>
                <span>ููุงุท ุงูุจูุน</span>
            </a>
            <a href="#expenses" class="mobile-nav-item" onclick="showSection('expenses')">
                <i class="bi bi-cash-stack"></i>
                <span>ุงููุตุฑููุงุช</span>
            </a>
            <a href="#reports" class="mobile-nav-item" onclick="showSection('reports')" data-permission="manager">
                <i class="bi bi-graph-up"></i>
                <span>ุงูุชูุงุฑูุฑ</span>
            </a>
            <a href="#settings" class="mobile-nav-item" onclick="showSection('settings')" data-permission="manager">
                <i class="bi bi-gear"></i>
                <span>ุงูุฅุนุฏุงุฏุงุช</span>
            </a>
            <a href="#chat.html" class="mobile-nav-item">
                <i class="bi bi-chat-dots"></i>
                <span>ุงูุดุงุช</span>
            </a>
        </div>
    </nav>

    <!-- ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2><i class="bi bi-phone"></i> ูุญู ุงูุตูุงูุฉ</h2>
        </div>
        
        <nav class="sidebar-nav">
            <a href="#dashboard" class="nav-link active" onclick="showSection('dashboard')">
                <i class="bi bi-speedometer2"></i> ููุญุฉ ุงูุชุญูู
            </a>
            <a href="#repairs" class="nav-link" onclick="showSection('repairs')">
                <i class="bi bi-tools"></i> ุนูููุงุช ุงูุตูุงูุฉ
            </a>
            <a href="#customers" class="nav-link" onclick="showSection('customers')">
                <i class="bi bi-people"></i> ุงูุนููุงุก
            </a>
            <a href="#inventory" class="nav-link" onclick="showSection('inventory')">
                <i class="bi bi-box-seam"></i> ุงููุฎุฒูู
            </a>
            <a href="pos.html" class="nav-link">
                <i class="bi bi-cash-register"></i> ููุงุท ุงูุจูุน
            </a>
            <a href="#expenses" class="nav-link" onclick="showSection('expenses')">
                <i class="bi bi-cash-stack"></i> ุงููุตุฑููุงุช
            </a>
            <a href="#reports" class="nav-link" onclick="showSection('reports')" data-permission="manager">
                <i class="bi bi-graph-up"></i> ุงูุชูุงุฑูุฑ ุงููุงููุฉ
            </a>
            <a href="#settings" class="nav-link" onclick="showSection('settings')" data-permission="manager">
                <i class="bi bi-gear"></i> ุงูุฅุนุฏุงุฏุงุช
            </a>
            <a href="chat.html" class="nav-link">
                <i class="bi bi-chat-dots"></i> ุงูุดุงุช ุงูุฌูุงุนู
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-info">
                <p><i class="bi bi-person-circle"></i> <strong id="userName">ุงููุณุชุฎุฏู</strong></p>
                <p><i class="bi bi-shield-check"></i> <span id="userRole">ุงูุฏูุฑ</span></p>
            </div>
            <button onclick="logout()" class="btn btn-danger btn-sm"><i class="bi bi-box-arrow-right"></i> ุชุณุฌูู ุงูุฎุฑูุฌ</button>
        </div>
    </aside>

    <!-- ุงููุญุชูู ุงูุฑุฆูุณู -->
    <main class="main-content">
        <header class="top-bar">
            <button class="btn-menu" onclick="toggleSidebar()"><i class="bi bi-list"></i></button>
            <h1 id="pageTitle">ููุญุฉ ุงูุชุญูู</h1>
            <div class="header-actions">
                <span id="syncIndicator" class="sync-indicator" onclick="syncManager.manualSync()" title="ุงุถุบุท ูููุฒุงููุฉ ูุฏููุงู"><i class="bi bi-arrow-repeat"></i> ุฌุงุฑู ุงูุชุญููู...</span>
                <button onclick="toggleDarkMode()" class="btn btn-icon" title="ุชุจุฏูู ุงููุถุน ุงููููู"><i class="bi bi-moon-stars"></i></button>
                <button onclick="showSection('profile')" class="btn btn-icon profile-btn" id="profileBtn" title="ุงูููู ุงูุดุฎุตู"><i class="bi bi-person-circle"></i></button>
            </div>
            <!-- ูุนูููุงุช ุงููุณุชุฎุฏู ูุฒุฑ ุชุณุฌูู ุงูุฎุฑูุฌ ููููุงุชู -->
            <div class="mobile-top-user-info">
                <div class="mobile-user-info">
                    <p><i class="bi bi-person-circle"></i> <strong id="mobileUserName">ุงููุณุชุฎุฏู</strong></p>
                    <p><i class="bi bi-shield-check"></i> <span id="mobileUserRole">ุงูุฏูุฑ</span></p>
                </div>
                <button onclick="logout()" class="btn btn-danger btn-xs"><i class="bi bi-box-arrow-right"></i> ุชุณุฌูู ุงูุฎุฑูุฌ</button>
            </div>
        </header>

        <div class="content">
            <!-- ููุญุฉ ุงูุชุญูู -->
            <section id="dashboard-section" class="section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="bi bi-receipt-cutoff"></i></div>
                        <div class="stat-info">
                            <h3>ุนูููุงุช ุงูููู</h3>
                            <p class="stat-value" id="todayRepairs">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="bi bi-currency-exchange"></i></div>
                        <div class="stat-info">
                            <h3>ุฅูุฑุงุฏุงุช ุงูููู</h3>
                            <p class="stat-value" id="todayRevenue">0 ุฌ.ู</p>
                            <small style="font-size: 0.75em; color: #999;">ุตุงูู ุฑุจุญ ุงูุนูููุงุช</small>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="bi bi-wallet2"></i></div>
                        <div class="stat-info">
                            <h3>ุงููุตุฑููุงุช ุงููููุฉ</h3>
                            <p class="stat-value" id="todayExpenses">0 ุฌ.ู</p>
                            <small style="font-size: 0.75em; color: #999;">ูุตุฑููุงุช + ูุฎุฒูู</small>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="bi bi-piggy-bank"></i></div>
                        <div class="stat-info">
                            <h3>ุตุงูู ุงูุฑุจุญ ุงูููุงุฆู</h3>
                            <p class="stat-value" id="todayProfit">0 ุฌ.ู</p>
                            <small style="font-size: 0.75em; color: #999;">ุงูุฅูุฑุงุฏุงุช - ุงููุตุฑููุงุช</small>
                        </div>
                    </div>
                </div>

                <div class="section-content">
                    <h2>ุงูุนูููุงุช ุงูุญุงููุฉ</h2>
                    <div class="table-container">
                        <table class="data-table" id="currentRepairsTable">
                            <thead>
                                <tr>
                                    <th>ุฑูู ุงูุนูููุฉ</th>
                                    <th>ุงูุนููู</th>
                                    <th>ุงูุฌูุงุฒ</th>
                                    <th>ุงูุญุงูุฉ</th>
                                    <th>ุงูุชุงุฑูุฎ</th>
                                </tr>
                            </thead>
                            <tbody id="currentRepairsBody">
                                <tr>
                                    <td colspan="5" style="text-align: center;">ูุง ุชูุฌุฏ ุนูููุงุช ุญุงููุฉ</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ุนูููุงุช ุงูุตูุงูุฉ -->
            <section id="repairs-section" class="section"></section>

            <!-- ุงูููู ุงูุดุฎุตู -->
            <section id="profile-section" class="section">
                <div class="section-header">
                    <h2><i class="bi bi-person-circle"></i> ุงูููู ุงูุดุฎุตู</h2>
                </div>
                <div class="section-content" id="profile-content">
                    <p>ุฌุงุฑู ุงูุชุญููู...</p>
                </div>
            </section>

            <!-- ุงูุนููุงุก -->
            <section id="customers-section" class="section"></section>

            <!-- ุงููุฎุฒูู -->
            <section id="inventory-section" class="section"></section>

            <!-- ุงููุตุฑููุงุช -->
            <section id="expenses-section" class="section"></section>

            <!-- ุงูุชูุงุฑูุฑ -->
            <section id="reports-section" class="section"></section>

            <!-- ุงูุฅุนุฏุงุฏุงุช -->
            <section id="settings-section" class="section"></section>
        </div>
    </main>

    <!-- Critical Scripts - ุชุญููู ููุฑู (ูุทููุจุฉ ููุชุดุบูู ุงูุฃุณุงุณู) -->
    <script src="js/api.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js" defer></script>
    
    <!-- Security Scripts - ุชุญููู ุจุฃููููุฉ ุนุงููุฉ (defer ููุชุญููู ุบูุฑ ุงููุชุฒุงูู) -->
    <script src="js/data-protection.js" defer></script>
    <script src="js/security.js" defer></script>
    
    <!-- Core Features - ุชุญููู ูุชุฃุฎุฑ (async) -->
    <script src="js/sync.js" async></script>
    <script src="js/encryption.js" async></script>
    <script src="js/encryption-settings.js" async></script>
    
    <!-- Module Scripts - ุชุญููู ุฏููุงูููู ุนูุฏ ุงูุญุงุฌุฉ (Lazy Loading) -->
    <script>
        // ุชุญููู ุฏููุงูููู ููููููุงุช ุงููุจูุฑุฉ - ุชุญุณูู ุงูุฃุฏุงุก
        (function() {
            const scripts = {
                critical: [
                    { src: 'js/repairs.js', defer: true },
                    { src: 'js/customers.js', defer: true },
                    { src: 'js/inventory.js', defer: true }
                ],
                onDemand: [
                    { src: 'js/barcode.js', id: 'barcode-script' },
                    { src: 'js/small-label.js', id: 'label-script' },
                    { src: 'js/image-management.js', id: 'image-script' },
                    { src: 'js/backup-management.js', id: 'backup-script' },
                    { src: 'js/expenses.js', id: 'expenses-script' },
                    { src: 'js/reports.js', id: 'reports-script' },
                    { src: 'js/settings.js', id: 'settings-script' },
                    { src: 'js/profile.js', id: 'profile-script' },
                    { src: 'js/pwa-install.js', id: 'pwa-script' },
                    { src: 'webauthn/webauthn.js', id: 'webauthn-script' }
                ]
            };
            
            // ุชุญููู Critical Scripts ุจุนุฏ DOMContentLoaded ูุน ุชุฃุฎูุฑ ูุชูููู ุงูุชุญููู ุงูููุฑู
            document.addEventListener('DOMContentLoaded', () => {
                // ุชุฃุฎูุฑ ุชุญููู Critical Scripts ุจููุฏุงุฑ 100ms ูุชูููู ุงูุชุญููู ุงูููุฑู
                setTimeout(() => {
                    scripts.critical.forEach((script, index) => {
                        // ุชุญููู ูู script ูุน ุชุฃุฎูุฑ ุชุฏุฑูุฌู ูุชูููู ุงูุชุญููู ุงููุชุฒุงูู
                        setTimeout(() => {
                            const el = document.createElement('script');
                            el.src = script.src;
                            if (script.defer) el.defer = true;
                            el.async = true; // ุฅุถุงูุฉ async ููุชุญููู ุบูุฑ ุงููุชุฒุงูู
                            document.body.appendChild(el);
                        }, index * 50); // ุชุฃุฎูุฑ 50ms ุจูู ูู script
                    });
                }, 100);
                
                // ุชุญููู On-Demand Scripts ุนูุฏ ุงูุญุงุฌุฉ (Lazy Loading)
                window.loadScriptOnDemand = function(scriptId) {
                    const scriptInfo = scripts.onDemand.find(s => s.id === scriptId);
                    if (!scriptInfo) return Promise.resolve();
                    
                    // ุงูุชุญูู ูู ุนุฏู ุชุญูููู ูุณุจูุงู
                    if (document.getElementById(scriptInfo.id)) {
                        return Promise.resolve();
                    }
                    
                    return new Promise((resolve, reject) => {
                        const el = document.createElement('script');
                        el.id = scriptInfo.id;
                        el.src = scriptInfo.src;
                        el.defer = true;
                        el.onload = () => resolve();
                        el.onerror = () => reject(new Error(`Failed to load ${scriptInfo.src}`));
                        document.body.appendChild(el);
                    });
                };
                
                // Preload scripts ุนูุฏ ุงูุชูุงุนู ุงูุฃูู (passive loading) - ุชุฃุฎูุฑ ุฃูุซุฑ
                // ุชุญููู ููุท ุนูุฏ ุงูุชูุงุนู ุงููุนูู ูุน ุงููุณุชุฎุฏู (ุนูุฏ hover ุฃู click)
                let userInteracted = false;
                const markInteraction = () => {
                    if (userInteracted) return;
                    userInteracted = true;
                    // ุชุญููู ุจุนุถ ุงูููููุงุช ุงูุดุงุฆุนุฉ ุจุนุฏ ุงูุชูุงุนู
                    setTimeout(() => {
                        ['barcode-script', 'label-script'].forEach(id => {
                            window.loadScriptOnDemand(id).catch(() => {});
                        });
                    }, 500);
                };
                
                document.addEventListener('mouseover', markInteraction, { once: true, passive: true });
                document.addEventListener('touchstart', markInteraction, { once: true, passive: true });
            });
        })();
    </script>
    
    <script>
        // ูุนุงูุฌุฉ ุชุญุฏูุซ Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data && event.data.type === 'SW_UPDATED') {
                    console.log('๐ ' + event.data.message, 'Version:', event.data.version);
                    // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ุชููุงุฆูุงู ุนูุฏ ุชุญุฏูุซ Service Worker
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }
            });
            
            // ุงูุชุญูู ูู ุชุญุฏูุซุงุช Service Worker
            navigator.serviceWorker.getRegistration().then(registration => {
                if (registration) {
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        if (newWorker) {
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('๐ Service Worker updated - reloading...');
                                    window.location.reload();
                                }
                            });
                        }
                    });
                }
            });
        }
    </script>
    
    <script>
        let currentSection = 'dashboard';
        
        // ูุธุงู ุญูุธ ูุงุณุชุนุงุฏุฉ ุงูุตูุญุฉ ุงูุญุงููุฉ
        const PAGE_STORAGE_KEY = 'current_page_section';
        const INVENTORY_TAB_STORAGE_KEY = 'current_inventory_tab';
        
        // ุญูุธ ุงูุตูุญุฉ ุงูุญุงููุฉ ูู localStorage
        function saveCurrentPage(section) {
            try {
                localStorage.setItem(PAGE_STORAGE_KEY, section);
                localStorage.setItem(PAGE_STORAGE_KEY + '_timestamp', Date.now().toString());
                console.log('๐พ ุชู ุญูุธ ุงูุตูุญุฉ ุงูุญุงููุฉ:', section);
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุญูุธ ุงูุตูุญุฉ:', error);
            }
        }
        
        // ุงุณุชุนุงุฏุฉ ุงูุตูุญุฉ ุงูุญุงููุฉ ูู localStorage
        function restoreCurrentPage() {
            try {
                const savedSection = localStorage.getItem(PAGE_STORAGE_KEY);
                if (savedSection) {
                    console.log('๐ ุงุณุชุนุงุฏุฉ ุงูุตูุญุฉ ุงูุญุงููุฉ:', savedSection);
                    return savedSection;
                }
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุงุณุชุนุงุฏุฉ ุงูุตูุญุฉ:', error);
            }
            return 'dashboard';
        }

        // ุญูุงูุฉ ุงูุตูุญุฉ - ููุน ุงููุตูู ุจุฏูู ุชุณุฌูู ุฏุฎูู
        // ูุชุบูุฑ ูููุน ุงูุทูุจุงุช ุงููุชูุฑุฑุฉ
        let authCheckInProgress = false;
        let authChecked = false;

        let cachedUser = null;
        
        async function performAuthCheck() {
            // ููุน ุงูุทูุจุงุช ุงููุชูุฑุฑุฉ - ุฅุฐุง ูุงู ููุงู ุทูุจ ููุฏ ุงูุชูููุฐุ ุงูุชุธุฑ
            if (authCheckInProgress) {
                // ุงูุชุธุงุฑ ุญุชู ููุชูู ุงูุทูุจ ุงูุญุงูู (ุจุญุฏ ุฃูุตู 5 ุซูุงู)
                let waitTime = 0;
                while (authCheckInProgress && waitTime < 5000) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    waitTime += 100;
                }
                return cachedUser;
            }
            
            // ุฅุฐุง ุชู ุงูุชุญูู ุจุงููุนู ููุงู ููุงู ูุณุชุฎุฏู ูุญููุธุ ุฃุฑุฌุน ุงููุณุชุฎุฏู
            if (authChecked && cachedUser) {
                return cachedUser;
            }
            
            authCheckInProgress = true;
            try {
                const user = await checkLogin();
                authCheckInProgress = false;
                authChecked = true;
                
                if (!user) {
                    cachedUser = null;
                    localStorage.clear();
                    sessionStorage.clear();
                    showLoginRequiredMessage();
                    return null;
                }
                
                cachedUser = user;
                return user;
            } catch (error) {
                authCheckInProgress = false;
                authChecked = false;
                cachedUser = null;
                console.error('ุฎุทุฃ ูู ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู:', error);
                localStorage.clear();
                sessionStorage.clear();
                showLoginRequiredMessage();
                return null;
            }
        }

        // ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
        window.addEventListener('DOMContentLoaded', async () => {
            const user = await performAuthCheck();
            if (!user) {
                return;
            }
            
            displayUserInfo();
            hideByPermission();
            loadDarkMode();
            setupModalCloseOnClickOutside();
            
            // ุฅุฏุงุฑุฉ ุฒุฑ ุงูุชุซุจูุช
            const initInstallButton = () => {
                const installLink = document.getElementById('installLink');
                if (!installLink) return;
                
                if (typeof pwaInstallManager !== 'undefined') {
                    const installInfo = pwaInstallManager.getInstallInfo();
                    // ุฅุธูุงุฑ ุงูุฒุฑ ุฅุฐุง ูู ููู ูุซุจุชุงู ุฃู ุฅุฐุง ูุงู Chrome Desktop
                    const browser = pwaInstallManager.getBrowser();
                    const isChromeDesktop = browser === 'chrome' && !pwaInstallManager.isAndroid() && !pwaInstallManager.isIOS();
                    
                    if (!installInfo.isInstalled || isChromeDesktop) {
                        installLink.style.display = 'inline-block';
                    }
                } else {
                    // ุชููุฆุฉ PWA Install Manager
                    if (typeof PWAInstallManager !== 'undefined') {
                        window.pwaInstallManager = new PWAInstallManager();
                        const installInfo = window.pwaInstallManager.getInstallInfo();
                        const browser = window.pwaInstallManager.getBrowser();
                        const isChromeDesktop = browser === 'chrome' && !window.pwaInstallManager.isAndroid() && !window.pwaInstallManager.isIOS();
                        
                        if (!installInfo.isInstalled || isChromeDesktop) {
                            installLink.style.display = 'inline-block';
                        }
                    }
                }
            };
            
            // ูุญุงููุฉ ููุฑูุฉ
            initInstallButton();
            
            // ูุญุงููุฉ ุจุนุฏ ุชุญููู PWA Manager
            setTimeout(initInstallButton, 500);
            setTimeout(initInstallButton, 1500);
            
            // ุชุณุฌูู Service Worker
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js', {
                        scope: '/'
                    });
                    console.log('โ Service Worker registered:', registration);
                    
                    // ุงูุชุญูู ูู ุงูุชุญุฏูุซุงุช
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('๐ New Service Worker available. Reload to update.');
                            }
                        });
                    });
                } catch (error) {
                    console.error('โ Service Worker registration failed:', error);
                }
            }
            
            // ุงุณุชุนุงุฏุฉ ุงูุตูุญุฉ ุงูุญุงููุฉ ูู localStorage
            const savedSection = restoreCurrentPage();
            currentSection = savedSection;
            
            // ุชุญุฏูุซ ุงูุนููุงู ุญุณุจ ุงูุตูุญุฉ ุงููุญููุธุฉ
            const titles = {
                'dashboard': 'ููุญุฉ ุงูุชุญูู',
                'repairs': 'ุนูููุงุช ุงูุตูุงูุฉ',
                'customers': 'ุงูุนููุงุก',
                'inventory': 'ุงููุฎุฒูู',
                'expenses': 'ุงููุตุฑููุงุช',
                'reports': 'ุงูุชูุงุฑูุฑ ุงููุงููุฉ',
                'settings': 'ุงูุฅุนุฏุงุฏุงุช'
            };
            if (titles[savedSection]) {
                document.getElementById('pageTitle').textContent = titles[savedSection];
            }
            
            // ุชุญุฏูุซ ุงูุฑูุงุจุท ุญุณุจ ุงูุตูุญุฉ ุงููุญููุธุฉ
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('onclick') && link.getAttribute('onclick').includes(`'${savedSection}'`)) {
                    link.classList.add('active');
                }
            });
            
            // ุชุญุฏูุซ ุงูู navbar ุงูุนุงุฆู
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('onclick') && item.getAttribute('onclick').includes(`'${savedSection}'`)) {
                    item.classList.add('active');
                }
            });
            
            // ุชุญุฏูุซ ุญุงูุฉ ุฒุฑ ุงูููู ุงูุดุฎุตู ูู header-actions
            const profileBtn = document.getElementById('profileBtn');
            if (profileBtn) {
                if (savedSection === 'profile') {
                    profileBtn.classList.add('active');
                } else {
                    profileBtn.classList.remove('active');
                }
            }
            
            // ุฅุฎูุงุก ุฌููุน ุงูุฃูุณุงู ุฃููุงู
            document.querySelectorAll('.section').forEach(sec => {
                sec.classList.remove('active');
            });
            
            // ุนุฑุถ ุงููุณู ุงููุญููุธ ุฃู dashboard ุงูุชุฑุงุถูุงู
            const sectionToShow = savedSection || 'dashboard';
            const sectionElement = document.getElementById(sectionToShow + '-section');
            if (sectionElement) {
                sectionElement.classList.add('active');
            } else if (sectionToShow === 'dashboard') {
                // ุงูุชุฃูุฏ ูู ุนุฑุถ dashboard-section ุฅุฐุง ูุงู ุงููุณู ุงููุทููุจ
                const dashboardSection = document.getElementById('dashboard-section');
                if (dashboardSection) {
                    dashboardSection.classList.add('active');
                }
            }
            
            // ุชุญููู ุงูุจูุงูุงุช ุงูุฃูููุฉ ูููุณู ุงููุทููุจ
            if (sectionToShow === 'dashboard') {
                await loadDashboardData();
                // ุฅุนุงุฏุฉ ุงููุญุงููุฉ ูุฑุฉ ูุงุญุฏุฉ ุฅุฐุง ูุดู ุงูุชุญููู ุงูุฃููู
                setTimeout(async () => {
                    const syncIndicator = document.getElementById('syncIndicator');
                    if (syncIndicator && syncIndicator.style.color === 'var(--danger-color)') {
                        console.log('๐ ุฅุนุงุฏุฉ ูุญุงููุฉ ุชุญููู ุจูุงูุงุช ููุญุฉ ุงูุชุญูู...');
                        await loadDashboardData();
                    }
                }, 3000);
            } else {
                // ุชุญููู ุจูุงูุงุช ุงููุณู ุงููุทููุจ
                await updateSectionData(sectionToShow, true);
            }
            
            // ุชููุฆุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู ุงูุชููุงุฆู
            try {
                if (typeof initializeAutoBackup === 'function') {
                    await initializeAutoBackup();
                }
            } catch (e) {
                console.warn('ุฎุทุฃ ูู ุชููุฆุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู:', e);
            }
            
            // ุชุญููู ูุญุชูู ุงูุฃูุณุงู ุจุดูู ุขูู ูุน ูุนุงูุฌุฉ ุฃูุถู ููุฃุฎุทุงุก
            const loadSectionSafely = async (sectionName, loadFunction) => {
                try {
                    if (typeof loadFunction === 'function') {
                        await loadFunction();
                    } else {
                        console.warn(`ุฏุงูุฉ ุชุญููู ${sectionName} ุบูุฑ ูุชููุฑุฉ`);
                    }
                } catch (e) {
                    console.error(`ุฎุทุฃ ูู ุชุญููู ูุณู ${sectionName}:`, e);
                    // ูุง ูููู ุงูุชูููุฐุ ููุท ูุณุฌู ุงูุฎุทุฃ
                }
            };
            
            // ุชุญููู ุงูุฃูุณุงู ุจุดูู ูุชูุงุฒู ูุชุญุณูู ุงูุฃุฏุงุก
            await Promise.allSettled([
                loadSectionSafely('repairs', loadRepairsSection),
                loadSectionSafely('customers', loadCustomersSection),
                loadSectionSafely('inventory', loadInventorySection),
                loadSectionSafely('expenses', loadExpensesSection),
                loadSectionSafely('reports', loadReportsSection),
                loadSectionSafely('settings', loadSettingsSection)
            ]);
            
            // ุนุฑุถ ุงูุตูุญุฉ ุงููุญููุธุฉ ุจุนุฏ ุชุญููู ุงูุฃูุณุงู
            setTimeout(() => {
                try {
                    showSection(sectionToShow, true); // true = ุจุฏูู ุญูุธ (ูุฃููุง ุงุณุชุนุฏูุงูุง)
                } catch (e) {
                    console.error('Error showing section:', e);
                    // ุฅุฐุง ูุดู ุนุฑุถ ุงููุณูุ ุนุฑุถ dashboard ูุจุฏูู
                    const dashboardSection = document.getElementById('dashboard-section');
                    if (dashboardSection) {
                        dashboardSection.classList.add('active');
                    }
                }
            }, 100);
            
            // ุชููุฆุฉ ูุธุงู ุงููุฒุงููุฉ ูุน ุชุฃุฎูุฑ ูุถูุงู ุชุญููู ูู ุดูุก
            setTimeout(() => {
                if (typeof syncManager !== 'undefined' && !syncManager.isInitialized) {
                    console.log('[Dashboard] ุจุฏุก ุชููุฆุฉ ูุธุงู ุงููุฒุงููุฉ');
                    syncManager.startAutoSync();
                }
            }, 3000);
        });

        // ุฅุฏุงุฑุฉ ุฅุบูุงู ุงูุชุจููุจ
        window.addEventListener('beforeunload', (event) => {
            // ุฅููุงู ูุธุงู ุงููุฒุงููุฉ
            if (typeof syncManager !== 'undefined' && syncManager.isInitialized) {
                console.log('[Dashboard] ุฅููุงู ูุธุงู ุงููุฒุงููุฉ ูุจู ุฅุบูุงู ุงูุชุจููุจ');
                syncManager.stopAutoSync();
            }
            
            // ุฅููุงู ุฌููุน ุงูุนูููุงุช ุงููุนููุฉ
            if (typeof window.currentCameraStream !== 'undefined' && window.currentCameraStream) {
                window.currentCameraStream.getTracks().forEach(track => track.stop());
                window.currentCameraStream = null;
            }
            
            // ุฅููุงู ูุงุฑุฆ ุงูุจุงุฑููุฏ ุฅุฐุง ูุงู ููุชูุญุงู
            if (typeof Quagga !== 'undefined') {
                try {
                    Quagga.stop();
                    Quagga.offDetected();
                } catch (e) {
                    console.log('ุชู ุฅููุงู ูุงุฑุฆ ุงูุจุงุฑููุฏ ุจุงููุนู');
                }
            }
            
            // ุชูุธูู ุงูุฐุงูุฑุฉ
            if (typeof allRepairs !== 'undefined') allRepairs = [];
            if (typeof allCustomers !== 'undefined') allCustomers = [];
            if (typeof allInventory !== 'undefined') allInventory = [];
            if (typeof allExpenses !== 'undefined') allExpenses = [];
            
            // ุฅุฒุงูุฉ ูุณุชูุนู ุงูุฃุญุฏุงุซ
            window.removeEventListener('online', () => {});
            window.removeEventListener('offline', () => {});
            window.removeEventListener('resize', () => {});
            
            // ุฅุฑุณุงู ุฑุณุงูุฉ ุชูุธูู ุฅูู Service Worker
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'CLEANUP'
                });
            }
            
            console.log('[Dashboard] ุชู ุชูุธูู ุงูููุงุฑุฏ ูุจู ุฅุบูุงู ุงูุชุจููุจ');
        });

        // ุฅุฏุงุฑุฉ ุฅุฎูุงุก ุงูุชุจููุจ
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // ุฅููุงู ุงููุฒุงููุฉ ุนูุฏ ุฅุฎูุงุก ุงูุชุจููุจ
                if (typeof syncManager !== 'undefined' && syncManager.isInitialized) {
                    console.log('[Dashboard] ุฅููุงู ุงููุฒุงููุฉ - ุงูุชุจููุจ ูุฎูู');
                    syncManager.stopAutoSync();
                }
            } else {
                // ุฅุนุงุฏุฉ ุชุดุบูู ุงููุฒุงููุฉ ุนูุฏ ุฅุธูุงุฑ ุงูุชุจููุจ
                if (typeof syncManager !== 'undefined' && !syncManager.isInitialized) {
                    console.log('[Dashboard] ุฅุนุงุฏุฉ ุชุดุบูู ุงููุฒุงููุฉ - ุงูุชุจููุจ ูุฑุฆู');
                    syncManager.startAutoSync();
                }
            }
        });

        // ุชุจุฏูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            sidebar.classList.toggle('show');
        }

        // ุนุฑุถ ูุณู ูุนูู
        function showSection(section, skipSave = false) {
            // ุญูุธ ุงูุตูุญุฉ ุงูุญุงููุฉ ูู localStorage (ุฅูุง ุฅุฐุง ูุงู skipSave = true)
            if (!skipSave) {
                saveCurrentPage(section);
            }
            
            // ุฅุฎูุงุก ุฌููุน ุงูุฃูุณุงู
            document.querySelectorAll('.section').forEach(sec => {
                sec.classList.remove('active');
            });
            
            // ุฅุฒุงูุฉ ุงูุชุญุฏูุฏ ูู ุฌููุน ุงูุฑูุงุจุท
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // ุฅุฒุงูุฉ ุงูุชุญุฏูุฏ ูู ุงูู navbar ุงูุนุงุฆู
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // ุนุฑุถ ุงููุณู ุงููุญุฏุฏ
            const targetSection = document.getElementById(`${section}-section`);
            if (targetSection) {
                targetSection.classList.add('active');
            } else {
                console.warn('ุงููุณู ุบูุฑ ููุฌูุฏ:', section);
                // ุฅุนุงุฏุฉ ุชุญููู ุงููุณู ุฅุฐุง ูู ููู ููุฌูุฏุงู
                if (section === 'repairs' && typeof loadRepairsSection === 'function') {
                    loadRepairsSection();
                } else if (section === 'customers' && typeof loadCustomersSection === 'function') {
                    loadCustomersSection();
                } else if (section === 'inventory' && typeof loadInventorySection === 'function') {
                    loadInventorySection();
                } else if (section === 'expenses' && typeof loadExpensesSection === 'function') {
                    loadExpensesSection();
                } else if (section === 'reports' && typeof loadReportsSection === 'function') {
                    loadReportsSection();
                } else if (section === 'settings' && typeof loadSettingsSection === 'function') {
                    loadSettingsSection();
                }
                // ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุจุนุฏ ุชุญููู ุงููุณู
                setTimeout(() => {
                    const retrySection = document.getElementById(`${section}-section`);
                    if (retrySection) {
                        retrySection.classList.add('active');
                    }
                }, 100);
            }
            
            // ุชุญุฏูุฏ ุงูุฑุงุจุท
            if (event && event.target) {
                const navLink = event.target.closest('.nav-link');
                if (navLink) {
                    navLink.classList.add('active');
                }
                const mobileNavItem = event.target.closest('.mobile-nav-item');
                if (mobileNavItem) {
                    mobileNavItem.classList.add('active');
                }
            } else {
                // ุฅุฐุง ูู ููู ููุงู eventุ ูุจุญุซ ุนู ุงูุฑุงุจุท ูุฏููุงู
                document.querySelectorAll('.nav-link').forEach(link => {
                    if (link.getAttribute('onclick') && link.getAttribute('onclick').includes(`'${section}'`)) {
                        link.classList.add('active');
                    }
                });
                document.querySelectorAll('.mobile-nav-item').forEach(item => {
                    if (item.getAttribute('onclick') && item.getAttribute('onclick').includes(`'${section}'`)) {
                        item.classList.add('active');
                    }
                });
            }
            
            // ุชุญุฏูุซ ุนููุงู ุงูุตูุญุฉ
            const titles = {
                'dashboard': 'ููุญุฉ ุงูุชุญูู',
                'repairs': 'ุนูููุงุช ุงูุตูุงูุฉ',
                'customers': 'ุงูุนููุงุก',
                'inventory': 'ุงููุฎุฒูู',
                'expenses': 'ุงููุตุฑููุงุช',
                'reports': 'ุงูุชูุงุฑูุฑ ุงููุงููุฉ',
                'settings': 'ุงูุฅุนุฏุงุฏุงุช',
                'profile': 'ุงูููู ุงูุดุฎุตู'
            };
            if (titles[section]) {
                document.getElementById('pageTitle').textContent = titles[section];
            }
            currentSection = section;
            
            // ุชุญุฏูุซ ุงูุจูุงูุงุช ุนูุฏ ุชุบููุฑ ุงูุชุจููุจุงุช - ูุน ุฅุนุงุฏุฉ ุชุญููู ูุงููุฉ
            updateSectionData(section, true); // true = ุฅุนุงุฏุฉ ุชุญููู ูุงููุฉ
            
            // ุชุญุฏูุซ ุงูู navbar ุงูุนุงุฆู
            updateMobileNavbar(section);
            
            // ุชุญุฏูุซ ุญุงูุฉ ุฒุฑ ุงูููู ุงูุดุฎุตู ูู header-actions
            const profileBtn = document.getElementById('profileBtn');
            if (profileBtn) {
                if (section === 'profile') {
                    profileBtn.classList.add('active');
                } else {
                    profileBtn.classList.remove('active');
                }
            }
            
            // ุฅุบูุงู ุงูู sidebar ูู ูุงุฌูุฉ ุงููุงุชู ุจุนุฏ ุงุฎุชูุงุฑ ุชุจููุจ
            if (window.innerWidth <= 575.98) {
                const sidebar = document.getElementById('sidebar');
                const mobileMenuBtn = document.getElementById('mobileMenuBtn') || document.querySelector('.btn-menu');
                if (sidebar) {
                    sidebar.classList.remove('open');
                }
                if (mobileMenuBtn) {
                    mobileMenuBtn.innerHTML = '<i class="bi bi-list"></i>';
                }
            }
        }

        // ุชุญุฏูุซ ุงูุจูุงูุงุช ุนูุฏ ุชุบููุฑ ุงูุชุจููุจุงุช
        async function updateSectionData(section, forceReload = false) {
            try {
                switch (section) {
                    case 'dashboard':
                        await loadDashboardData();
                        break;
                    case 'repairs':
                        if (typeof loadRepairsSection === 'function') {
                            // ุฅุนุงุฏุฉ ุชุญููู ูุงููุฉ ูููุณู
                            if (forceReload) {
                                console.log('๐ ุฅุนุงุฏุฉ ุชุญููู ูุณู ุนูููุงุช ุงูุตูุงูุฉ...');
                                loadRepairsSection();
                            }
                        }
                        break;
                    case 'customers':
                        if (typeof loadCustomersSection === 'function') {
                            // ุฅุนุงุฏุฉ ุชุญููู ูุงููุฉ ูููุณู
                            if (forceReload) {
                                console.log('๐ ุฅุนุงุฏุฉ ุชุญููู ูุณู ุงูุนููุงุก...');
                                loadCustomersSection();
                            }
                        }
                        break;
                    case 'inventory':
                        if (typeof loadInventorySection === 'function') {
                            // ุฅุนุงุฏุฉ ุชุญููู ูุงููุฉ ูููุณู ูุถูุงู ุนุฑุถ ุงูุนูุงุตุฑ
                            if (forceReload) {
                                console.log('๐ ุฅุนุงุฏุฉ ุชุญููู ูุณู ุงููุฎุฒูู...');
                                loadInventorySection();
                                
                                // ุงุณุชุนุงุฏุฉ ุงูุชุจููุจ ุงููุญููุธ ุจุนุฏ ุชุญููู ุงููุณู
                                setTimeout(() => {
                                    const savedTab = localStorage.getItem('current_inventory_tab');
                                    if (savedTab && typeof switchInventoryTab === 'function') {
                                        const tabElement = document.querySelector(`.inventory-tab[onclick*="'${savedTab}'"]`);
                                        if (tabElement) {
                                            switchInventoryTab(savedTab, tabElement);
                                        }
                                    }
                                }, 200);
                            }
                        }
                        break;
                    case 'expenses':
                        if (typeof loadExpensesSection === 'function') {
                            // ุฅุนุงุฏุฉ ุชุญููู ูุงููุฉ ูููุณู
                            if (forceReload) {
                                console.log('๐ ุฅุนุงุฏุฉ ุชุญููู ูุณู ุงููุตุฑููุงุช...');
                                loadExpensesSection();
                            }
                        }
                        break;
                    case 'reports':
                        if (typeof loadReportsSection === 'function') {
                            // ุฅุนุงุฏุฉ ุชุญููู ูุงููุฉ ูููุณู
                            if (forceReload) {
                                console.log('๐ ุฅุนุงุฏุฉ ุชุญููู ูุณู ุงูุชูุงุฑูุฑ...');
                                loadReportsSection();
                            }
                        }
                        break;
                    case 'settings':
                        if (typeof loadSettingsSection === 'function') {
                            // ุฅุนุงุฏุฉ ุชุญููู ูุงููุฉ ูููุณู
                            if (forceReload) {
                                console.log('๐ ุฅุนุงุฏุฉ ุชุญููู ูุณู ุงูุฅุนุฏุงุฏุงุช...');
                                loadSettingsSection();
                            }
                        }
                        break;
                    case 'profile':
                        if (typeof loadProfileSection === 'function') {
                            // ุฅุนุงุฏุฉ ุชุญููู ูุงููุฉ ูููุณู
                            if (forceReload) {
                                console.log('๐ ุฅุนุงุฏุฉ ุชุญููู ูุณู ุงูููู ุงูุดุฎุตู...');
                                loadProfileSection();
                            }
                        }
                        break;
                }
            } catch (error) {
                console.error(`ุฎุทุฃ ูู ุชุญุฏูุซ ุจูุงูุงุช ${section}:`, error);
            }
        }

        // ุชุญููู ุจูุงูุงุช ููุญุฉ ุงูุชุญูู
        async function loadDashboardData() {
            const syncIndicator = document.getElementById('syncIndicator');
            let hasError = false;
            let errorMessage = '';
            
            try {
                // ุงุณุชุฎุฏุงู getTodayDate ุฅุฐุง ูุงู ูุชุงุญุงู ุฃู fallback
                const getTodayDateFunc = typeof getTodayDate === 'function' ? getTodayDate : () => {
                    const today = new Date();
                    return today.toISOString().split('T')[0];
                };
                const today = getTodayDateFunc();
                
                // ุงุณุชุฎุฏุงู formatCurrency ุฅุฐุง ูุงู ูุชุงุญุงู ุฃู fallback (ุชุนุฑูู ูุงุญุฏ ููุท)
                const formatCurrencyFunc = typeof formatCurrency === 'function' ? formatCurrency : (amount) => {
                    return parseFloat(amount || 0).toFixed(2) + ' ุฌ.ู';
                };
                
                // ุชุญุฏูุซ ูุคุดุฑ ุงูุชุญููู
                if (syncIndicator) {
                    syncIndicator.innerHTML = '<i class="bi bi-arrow-repeat"></i> ุฌุงุฑู ุงูุชุญููู...';
                    syncIndicator.style.color = '';
                }
                
                // ุชุญููู ุชูุฑูุฑ ุงูููู ูุน ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุจุดูู ูููุตู
                let reportData = null;
                try {
                    const result = await API.getReport('daily', today);
                    if (result && result.success && result.data) {
                        reportData = result.data;
                    } else {
                        console.warn('ูุดู ุชุญููู ุชูุฑูุฑ ุงูููู:', result?.message || 'Unknown error');
                        if (result?.message) {
                            errorMessage = result.message;
                            hasError = true;
                        }
                    }
                } catch (reportError) {
                    console.error('ุฎุทุฃ ูู ุชุญููู ุชูุฑูุฑ ุงูููู:', reportError);
                    hasError = true;
                    if (reportError.message) {
                        errorMessage = reportError.message;
                    }
                }
                
                // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช (ุญุชู ูู ูุดู ุงูุชูุฑูุฑุ ูุนุฑุถ ุงูููู ุงูุงูุชุฑุงุถูุฉ)
                const todayRepairsEl = document.getElementById('todayRepairs');
                const todayRevenueEl = document.getElementById('todayRevenue');
                const todayExpensesEl = document.getElementById('todayExpenses');
                const todayProfitEl = document.getElementById('todayProfit');
                
                if (reportData) {
                    if (todayRepairsEl) todayRepairsEl.textContent = reportData.repairs_count || 0;
                    if (todayRevenueEl) todayRevenueEl.textContent = formatCurrencyFunc(reportData.revenue || 0);
                    if (todayExpensesEl) todayExpensesEl.textContent = formatCurrencyFunc(reportData.expenses || 0);
                    if (todayProfitEl) todayProfitEl.textContent = formatCurrencyFunc(reportData.profit || 0);
                } else {
                    // ูู ุญุงูุฉ ุงููุดูุ ุนุฑุถ ุงูููู ุงูุงูุชุฑุงุถูุฉ
                    if (todayRepairsEl) todayRepairsEl.textContent = '0';
                    if (todayRevenueEl) todayRevenueEl.textContent = formatCurrencyFunc(0);
                    if (todayExpensesEl) todayExpensesEl.textContent = formatCurrencyFunc(0);
                    if (todayProfitEl) todayProfitEl.textContent = formatCurrencyFunc(0);
                }
                
                // ุชุญููู ุงูุนูููุงุช ุงูุญุงููุฉ ูุน ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุจุดูู ูููุตู
                try {
                    const repairsResult = await API.getRepairs();
                    if (repairsResult && repairsResult.success && repairsResult.data) {
                        const currentRepairs = repairsResult.data.filter(r => 
                            r && (r.status === 'pending' || r.status === 'in_progress' || r.status === 'ready')
                        );
                        displayCurrentRepairs(currentRepairs);
                    } else {
                        // ุนุฑุถ ุฑุณุงูุฉ "ูุง ุชูุฌุฏ ุนูููุงุช ุญุงููุฉ" ูู ุญุงูุฉ ุงููุดู
                        displayCurrentRepairs([]);
                        if (repairsResult?.message) {
                            console.warn('ูุดู ุชุญููู ุงูุนูููุงุช:', repairsResult.message);
                            if (!errorMessage) {
                                errorMessage = repairsResult.message;
                                hasError = true;
                            }
                        }
                    }
                } catch (repairsError) {
                    console.error('ุฎุทุฃ ูู ุชุญููู ุงูุนูููุงุช:', repairsError);
                    displayCurrentRepairs([]);
                    if (repairsError.message && !errorMessage) {
                        errorMessage = repairsError.message;
                        hasError = true;
                    }
                }
                
                // ุชุญุฏูุซ ูุคุดุฑ ุงูุชุญููู ุญุณุจ ุงููุชูุฌุฉ
                if (syncIndicator) {
                    if (hasError) {
                        syncIndicator.innerHTML = '<i class="bi bi-exclamation-triangle"></i> ุฎุทุฃ ูู ุงูุชุญููู';
                        syncIndicator.style.color = 'var(--danger-color)';
                        syncIndicator.title = errorMessage || 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุจูุงูุงุช';
                    } else {
                        syncIndicator.innerHTML = '<i class="bi bi-check-circle"></i> ูุญุฏุซ';
                        syncIndicator.style.color = 'var(--success-color)';
                        syncIndicator.title = 'ุชู ุชุญุฏูุซ ุงูุจูุงูุงุช ุจูุฌุงุญ';
                        setTimeout(() => {
                            if (syncIndicator) {
                                const now = new Date();
                                const timeStr = now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
                                syncIndicator.innerHTML = `<i class="bi bi-check-circle"></i> ุขุฎุฑ ุชุญุฏูุซ: ${timeStr}`;
                                syncIndicator.title = `ุขุฎุฑ ุชุญุฏูุซ: ${timeStr}`;
                            }
                        }, 1000);
                    }
                }
                
                // ุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ููุท ุฅุฐุง ูุงู ููุงู ุฎุทุฃ ุญูููู
                if (hasError && errorMessage) {
                    // ูุง ูุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ุฅุฐุง ูุงูุช ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ูุญููุฉ (ุญุชู ูู ูุดู ุฌุฒุก ูููุง)
                    if (!reportData) {
                        showMessage('ุฎุทุฃ ูู ุชุญููู ุจุนุถ ุงูุจูุงูุงุช: ' + errorMessage, 'error');
                    }
                }
                
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุชุญููู ุจูุงูุงุช ููุญุฉ ุงูุชุญูู:', error);
                
                // ุชุนููู ุงูููู ุงูุงูุชุฑุงุถูุฉ ูู ุญุงูุฉ ุงูุฎุทุฃ
                const todayRepairsEl = document.getElementById('todayRepairs');
                const todayRevenueEl = document.getElementById('todayRevenue');
                const todayExpensesEl = document.getElementById('todayExpenses');
                const todayProfitEl = document.getElementById('todayProfit');
                
                // ุงุณุชุฎุฏุงู formatCurrency ุฅุฐุง ูุงู ูุชุงุญุงู ุฃู fallback
                const formatCurrencyFunc = typeof formatCurrency === 'function' ? formatCurrency : (amount) => {
                    return parseFloat(amount || 0).toFixed(2) + ' ุฌ.ู';
                };
                
                if (todayRepairsEl) todayRepairsEl.textContent = '0';
                if (todayRevenueEl) todayRevenueEl.textContent = formatCurrencyFunc(0);
                if (todayExpensesEl) todayExpensesEl.textContent = formatCurrencyFunc(0);
                if (todayProfitEl) todayProfitEl.textContent = formatCurrencyFunc(0);
                
                // ุนุฑุถ ุฑุณุงูุฉ ูู ุงูุฌุฏูู
                displayCurrentRepairs([]);
                
                // ุชุญุฏูุซ ูุคุดุฑ ุงูุชุญููู ููุนุฑุถ ุงูุฎุทุฃ
                if (syncIndicator) {
                    syncIndicator.innerHTML = '<i class="bi bi-exclamation-triangle"></i> ุฎุทุฃ ูู ุงูุชุญููู';
                    syncIndicator.style.color = 'var(--danger-color)';
                    syncIndicator.title = error.message || 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุจูุงูุงุช';
                }
                
                // ุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ูููุณุชุฎุฏู
                showMessage('ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช: ' + (error.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'), 'error');
            }
        }

        // ุนุฑุถ ุงูุนูููุงุช ุงูุญุงููุฉ
        function displayCurrentRepairs(repairs) {
            const tbody = document.getElementById('currentRepairsBody');
            if (!tbody) {
                console.warn('currentRepairsBody element not found');
                return;
            }
            
            try {
                // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
                if (!repairs || !Array.isArray(repairs) || repairs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: var(--text-light);">ูุง ุชูุฌุฏ ุนูููุงุช ุญุงููุฉ</td></tr>';
                    return;
                }
                
                // ุงุณุชุฎุฏุงู ุงูุฏูุงู ุงููุชุงุญุฉ ุฃู fallback
                const formatDateFunc = typeof formatDate === 'function' ? formatDate : (date) => {
                    if (!date) return '-';
                    try {
                        return new Date(date).toLocaleDateString('ar-SA');
                    } catch (e) {
                        return '-';
                    }
                };
                const getStatusColorFunc = typeof getStatusColor === 'function' ? getStatusColor : (status) => {
                    const colors = {
                        'pending': '#FFA500',
                        'in_progress': '#2196F3',
                        'ready': '#4CAF50',
                        'delivered': '#4CAF50',
                        'cancelled': '#f44336'
                    };
                    return colors[status] || '#999';
                };
                const getStatusTextFunc = typeof getStatusText === 'function' ? getStatusText : (status) => {
                    const statuses = {
                        'pending': 'ููุฏ ุงูุงูุชุธุงุฑ',
                        'in_progress': 'ููุฏ ุงูุฅุตูุงุญ',
                        'ready': 'ุฌุงูุฒ',
                        'delivered': 'ุชู ุงูุชุณููู',
                        'cancelled': 'ููุบู'
                    };
                    return statuses[status] || status || '-';
                };
                
                // ุจูุงุก HTML ุจุดูู ุขูู
                const rows = repairs.slice(0, 10)
                    .filter(repair => repair && typeof repair === 'object')
                    .map(repair => {
                        try {
                            const repairNumber = (repair.repair_number || '-').toString().trim();
                            const customerName = (repair.customer_name || '-').toString().trim();
                            const deviceType = (repair.device_type || '').toString().trim();
                            const deviceModel = (repair.device_model || '').toString().trim();
                            const deviceInfo = (deviceType + ' ' + deviceModel).trim() || '-';
                            const status = repair.status || '';
                            const statusColor = getStatusColorFunc(status);
                            const statusText = getStatusTextFunc(status);
                            const date = formatDateFunc(repair.created_at || repair.created_date);
                            
                            return `
                                <tr>
                                    <td>${repairNumber}</td>
                                    <td>${customerName}</td>
                                    <td>${deviceInfo}</td>
                                    <td><span class="status-badge" style="background: ${statusColor}">${statusText}</span></td>
                                    <td>${date}</td>
                                </tr>
                            `;
                        } catch (rowError) {
                            console.error('ุฎุทุฃ ูู ูุนุงูุฌุฉ ุตู:', rowError, repair);
                            return '';
                        }
                    })
                    .filter(row => row && row.trim().length > 0);
                
                if (rows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: var(--text-light);">ูุง ุชูุฌุฏ ุนูููุงุช ุญุงููุฉ</td></tr>';
                } else {
                    tbody.innerHTML = rows.join('');
                }
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุนุฑุถ ุงูุนูููุงุช:', error);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: var(--danger-color);">ุฎุทุฃ ูู ุนุฑุถ ุงูุจูุงูุงุช</td></tr>';
            }
        }

        // ุฅุฏุงุฑุฉ ุงููุงุฆูุฉ ุงููุชูููุฉ
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const mobileMenuBtn = document.getElementById('mobileMenuBtn') || document.querySelector('.btn-menu');
            
            if (!sidebar || !mobileMenuBtn) return;
            
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                mobileMenuBtn.innerHTML = '<i class="bi bi-list"></i>';
            } else {
                sidebar.classList.add('open');
                mobileMenuBtn.innerHTML = '<i class="bi bi-x"></i>';
            }
        }

        // ุชุญุฏูุซ ุงูู navbar ุงูุนุงุฆู ุนูุฏ ุชุบููุฑ ุงูุชุจููุจ
        function updateMobileNavbar(activeSection) {
            const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
            mobileNavItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('href') === '#' + activeSection) {
                    item.classList.add('active');
                }
            });
        }

        // ุฅุบูุงู ุงููุงุฆูุฉ ุนูุฏ ุงูููุฑ ุฎุงุฑุฌูุง
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const mobileMenuBtn = document.getElementById('mobileMenuBtn') || document.querySelector('.btn-menu');
            
            if (!sidebar || !mobileMenuBtn) return;
            
            if (window.innerWidth <= 575.98) {
                if (!sidebar.contains(event.target) && !mobileMenuBtn.contains(event.target)) {
                    sidebar.classList.remove('open');
                    if (mobileMenuBtn) {
                        mobileMenuBtn.innerHTML = '<i class="bi bi-list"></i>';
                    }
                }
            }
        });

        // ุฅุบูุงู ุงููุงุฆูุฉ ุนูุฏ ุชุบููุฑ ุญุฌู ุงูุดุงุดุฉ
        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('sidebar');
            const mobileMenuBtn = document.getElementById('mobileMenuBtn') || document.querySelector('.btn-menu');
            
            if (!sidebar || !mobileMenuBtn) return;
            
            if (window.innerWidth > 575.98) {
                sidebar.classList.remove('open');
                mobileMenuBtn.innerHTML = '<i class="bi bi-list"></i>';
            }
        });


    </script>
</body>
</html>


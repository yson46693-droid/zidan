<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø´Ø§Ù…Ù„ Ù„Ù…Ø­Ù„Ø§Øª ØµÙŠØ§Ù†Ø© Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©">
    <meta name="theme-color" content="#2196F3">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Ù…Ø­Ù„ Ø§Ù„ØµÙŠØ§Ù†Ù‡">
    
    <!-- Windows Meta Tags -->
    <meta name="msapplication-TileColor" content="#2196F3">
    <meta name="msapplication-TileImage" content="ico/icon-144x144.png">
    <meta name="msapplication-navbutton-color" content="#2196F3">
    <meta name="msapplication-starturl" content="/index.html">
    <meta name="msapplication-tooltip" content="Ù…Ø­Ù„ ØµÙŠØ§Ù†Ø© Ø§Ù„Ù‡ÙˆØ§ØªÙ">
    <meta name="msapplication-window" content="width=1024;height=768">
    
    <!-- Meta Tags Ù„Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© -->
    <meta name="application-name" content="Ù…Ø­Ù„ Ø§Ù„ØµÙŠØ§Ù†Ù‡">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Open Graph (Ù„Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©) -->
    <meta property="og:title" content="Ù…Ø­Ù„ ØµÙŠØ§Ù†Ø© Ø§Ù„Ù‡ÙˆØ§ØªÙ">
    <meta property="og:type" content="website">
    <meta property="og:image" content="ico/icon-512x512.png">
    
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø­Ù„ ØµÙŠØ§Ù†Ø© Ø§Ù„Ù‡ÙˆØ§ØªÙ</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- ğŸ”§ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡: ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª (3 ÙÙ‚Ø· Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 10+) -->
    <link rel="icon" type="image/png" href="ico/icon-192x192.png">
    <link rel="shortcut icon" href="ico/icon-192x192.png">
    <link rel="apple-touch-icon" href="ico/icon-192x192.png">
    
    <!-- Preconnect Ù„Ù„Ø®ÙˆØ§Ø¯Ù… Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    
    <!-- Google Fonts - Preconnect + async loading Ù…Ø¹ font-display: swap Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- âœ… ØªØ­Ø³ÙŠÙ†: Ø§Ø³ØªØ®Ø¯Ø§Ù… font-display: swap ÙÙŠ CSS Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ØªÙ‚Ù„ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <!-- Removed preload - onload conversion pattern causes warnings -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&family=Tajawal:wght@400;500;600;700;800&display=swap" media="print" onload="this.media='all';this.onload=null">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&family=Tajawal:wght@400;500;600;700;800&display=swap"></noscript>
    <!-- Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… preload Ù„Ù„Ø®Ø·ÙˆØ· Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø£Ù† URLs Ù‚Ø¯ ØªØªØºÙŠØ±ØŒ CSS Ø³ÙŠÙ‚ÙˆÙ… Ø¨ØªØ­Ù…ÙŠÙ„Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ -->
    
    <!-- Bootstrap Icons - ØªØ­Ù…ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ù„ØªØ¬Ù†Ø¨ FOUC Ø¹Ù†Ø¯ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ -->
    <!-- âœ… Ø¥ØµÙ„Ø§Ø­: ØªØ­Ù…ÙŠÙ„ Icons Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯ÙˆÙ† async Ù„ØªØ¬Ù†Ø¨ Ø§Ø®ØªÙØ§Ø¡ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
    <!-- Removed preload - stylesheet is loaded immediately, preload not needed -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" crossorigin="anonymous" media="all">
    <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"></noscript>
    
    <!-- âœ… ØªØ­Ø³ÙŠÙ†: Removed preload for deferred JS files - they won't be used immediately -->
    <!-- JS files are loaded with defer, so preloading them doesn't help and causes warnings -->
    
    <!-- ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ -->
    <script src="js/version.js"></script>
    <!-- Console Manager - Ø¥Ø¯Ø§Ø±Ø© console.log Ù„Ù„Ø¥Ù†ØªØ§Ø¬ -->
    <script src="js/console-manager.js"></script>
    <script>
        // ğŸ”§ Ø­Ù…Ø§ÙŠØ© ÙÙˆØ±ÙŠØ© Ù…Ù† Service Worker reload Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©)
        (function() {
            // Ù…Ù†Ø¹ reload Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø­Ø¯ÙŠØ«
            function shouldPreventReload() {
                try {
                    const justLoggedInTime = sessionStorage.getItem('just_logged_in_time');
                    if (justLoggedInTime) {
                        const timeSinceLogin = Date.now() - parseInt(justLoggedInTime);
                        if (timeSinceLogin < 20000) {
                            console.log('ğŸ›¡ï¸ [Ø­Ù…Ø§ÙŠØ© ÙÙˆØ±ÙŠØ©] Ù…Ù†Ø¹ reload - ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø­Ø¯ÙŠØ« (' + Math.round(timeSinceLogin / 1000) + ' Ø«Ø§Ù†ÙŠØ©)');
                            return true;
                        }
                    }
                    return false;
                } catch (e) {
                    return false;
                }
            }
            
            // Ù…ØªØºÙŠØ± Ø¹Ø§Ù… Ù„Ù…Ù†Ø¹ reload
            window.__PREVENT_SW_RELOAD__ = shouldPreventReload();
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø³Ø§Ø¦Ù„ Service Worker Ù…Ø¨ÙƒØ±Ø§Ù‹ (Ù‚Ø¨Ù„ Ø£ÙŠ ÙƒÙˆØ¯ Ø¢Ø®Ø±)
            if ('serviceWorker' in navigator) {
                // Ø¥Ø¶Ø§ÙØ© listener Ù…Ø¨ÙƒØ±Ø§Ù‹ Ø¬Ø¯Ø§Ù‹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… capture phase
                window.addEventListener('message', function(event) {
                    if (event.data && event.data.type === 'SW_UPDATED') {
                        if (shouldPreventReload()) {
                            console.log('ğŸ›¡ï¸ [Ø­Ù…Ø§ÙŠØ© ÙÙˆØ±ÙŠØ©] ØªÙ… Ø¥Ù„ØºØ§Ø¡ reload Ù…Ù† Ø±Ø³Ø§Ù„Ø© SW_UPDATED');
                            event.stopImmediatePropagation();
                            event.preventDefault();
                            return false;
                        }
                    }
                }, true);
            }
        })();
    </script>
    <script>
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ù…Ù† window.APP_VERSION (Ù…Ø¹Ø±Ù‘Ù ÙÙŠ version.js)
        // Ù„Ø§ Ù†Ø¹ÙŠØ¯ ØªØ¹Ø±ÙŠÙ APP_VERSION Ù„ØªØ¬Ù†Ø¨ Ø®Ø·Ø£ redeclaration
        (function() {
            // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ version.js
            const getAppVersion = function() {
                return window.APP_VERSION || 'v' + Date.now();
            };
            
            const VERSION_PARAM = '?v=' + getAppVersion();
            
            // Ø¥Ø¶Ø§ÙØ© query parameters Ù„Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª CSS/JS Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø¹Ø±Ø¶ ÙƒØ§Ø´ Ù‚Ø¯ÙŠÙ…
            document.addEventListener('DOMContentLoaded', function() {
                const version = getAppVersion();
                const versionParam = '?v=' + version;
                const timestamp = '&t=' + Date.now(); // Ø¥Ø¶Ø§ÙØ© timestamp Ø¥Ø¶Ø§ÙÙŠ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«
                
                // ØªØ­Ø¯ÙŠØ« Ù…Ù„ÙØ§Øª CSS - Ø¥Ø¶Ø§ÙØ© timestamp Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØ±ÙŠ
                const cssLinks = document.querySelectorAll('link[rel="stylesheet"]:not([href^="http"])');
                cssLinks.forEach(link => {
                    if (link.href) {
                        // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ query parameters Ù…ÙˆØ¬ÙˆØ¯Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
                        const hrefWithoutParams = link.href.split('?')[0];
                        link.href = hrefWithoutParams + versionParam + timestamp;
                    }
                });
                
                // ØªØ­Ø¯ÙŠØ« Ù…Ù„ÙØ§Øª JS (Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ version.js)
                const jsScripts = document.querySelectorAll('script[src]:not([src*="version.js"]):not([src^="http"])');
                jsScripts.forEach(script => {
                    if (script.src) {
                        const srcWithoutParams = script.src.split('?')[0];
                        script.src = srcWithoutParams + versionParam + timestamp;
                    }
                });
                
                // âœ… Ø¥ØµÙ„Ø§Ø­ Ø®Ø§Øµ: Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ CSS Ø¨Ø´ÙƒÙ„ Ù‚Ø³Ø±ÙŠ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«
                const mainStylesheet = document.getElementById('main-stylesheet');
                if (mainStylesheet) {
                    const originalHref = mainStylesheet.href.split('?')[0];
                    const forceParam = '&force=' + Date.now();
                    const newHref = originalHref + versionParam + timestamp + forceParam;
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ CSS Ø¨Ø´ÙƒÙ„ Ù‚Ø³Ø±ÙŠ
                    mainStylesheet.media = 'all';
                    const newLink = mainStylesheet.cloneNode(false);
                    newLink.href = newHref;
                    newLink.media = 'all';
                    newLink.id = 'main-stylesheet';
                    mainStylesheet.parentNode.replaceChild(newLink, mainStylesheet);
                    console.log('ğŸ”„ [Cache Bust] ØªÙ… ØªØ­Ø¯ÙŠØ« CSS Ø¨Ø´ÙƒÙ„ Ù‚Ø³Ø±ÙŠ:', newHref);
                }
            });
        })();
    </script>
    
    <!-- ğŸ”§ Ù…Ù†Ø¹ FOUC - Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø­ØªÙ‰ ØªØ­Ù…ÙŠÙ„ CSS -->
    <style id="anti-fouc">
        html:not(.css-loaded) {
            visibility: hidden;
        }
        html.css-loaded {
            visibility: visible;
        }
        body:not(.css-loaded) {
            opacity: 0;
        }
        body.css-loaded {
            opacity: 1;
            transition: opacity 0.2s ease-in;
        }
    </style>
    
    <!-- Critical CSS Inline - Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙÙˆØ±ÙŠ Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø± CSS Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ -->
    <style>
        /* Critical CSS Variables */
        :root{--primary-color:#2196F3;--secondary-color:#64B5F6;--white:#fff;--text-dark:#333;--text-light:#666;--border-color:#ddd;--shadow:0 2px 10px rgba(0,0,0,0.1);--light-bg:#f5f5f5}
        /* Reset & Base */
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Cairo','Tajawal','Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:var(--light-bg);color:var(--text-dark);line-height:1.6;direction:rtl;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
        /* Critical Dashboard Styles */
        .main-content{margin-right:260px;min-height:100vh;transition:margin 0.3s ease}
        .top-bar{background:var(--white);padding:15px 30px;box-shadow:var(--shadow);display:flex;align-items:center;gap:15px}
        .sidebar{position:fixed;right:0;top:0;width:260px;height:100vh;background:var(--white);box-shadow:var(--shadow);z-index:1000}
        .content{padding:30px}
        @media (max-width:767.98px){.main-content{margin-right:0;padding:20px 15px 80px}.sidebar{display:none}.mobile-navbar{display:block}}
    </style>
    
    <!-- âœ… ØªØ­Ø³ÙŠÙ†: Critical CSS - ØªØ­Ù…ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± -->
    <!-- Removed preload - stylesheet is loaded immediately, preload not needed -->
    <link rel="stylesheet" href="css/style.css" id="main-stylesheet" media="all">
    <noscript><link rel="stylesheet" href="css/style.css" id="main-stylesheet-noscript"></noscript>
    
    <!-- CSS Ù„Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª - Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø© Ù„Ù„Ù…ÙˆØ¸Ù -->
    <style id="employee-permissions-style">
        /* Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ */
    </style>
    
    <!-- âœ… ØªØ­Ø³ÙŠÙ†: ØªØ­Ù…ÙŠÙ„ CSS Ø§Ù„Ø­Ø±Ø¬Ø© Ù…Ø¨Ø§Ø´Ø±Ø© (Ø¨Ø¯ÙˆÙ† lazy load) Ù„ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
    <!-- Removed preload - stylesheet is loaded immediately, preload not needed -->
    <link rel="stylesheet" href="css/loading-overlay.css" media="all">
    <noscript><link rel="stylesheet" href="css/loading-overlay.css"></noscript>
    
    <!-- Non-Critical CSS - ØªØ­Ù…ÙŠÙ„ ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù† (lazy load) -->
    <!-- âœ… Removed preload for lazy-loaded CSS - they're not used immediately -->
    <link rel="stylesheet" href="css/dark-mode.css" media="print" onload="this.media='all';this.onload=null">
    <noscript><link rel="stylesheet" href="css/dark-mode.css"></noscript>
    
    <link rel="stylesheet" href="css/security.css" media="print" onload="this.media='all';this.onload=null">
    <noscript><link rel="stylesheet" href="css/security.css"></noscript>
    
    <!-- ğŸ”§ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ CSS - Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù‘Ù†Ø© Ù„Ù„Ø£Ø¯Ø§Ø¡ -->
    <script>
        (function() {
            'use strict';
            let contentShown = false;
            let syncManagerInitialized = false; // Ù…ØªØºÙŠØ± Ø¹Ø§Ù… Ù„ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
            
            function showContent() {
                if (contentShown) return; // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
                contentShown = true;
                
                try {
                    // Ø¥Ø²Ø§Ù„Ø© style tag Ø§Ù„Ù…Ø¶Ø§Ø¯ Ù„Ù€ FOUC
                    const antiFouc = document.getElementById('anti-fouc');
                    if (antiFouc && antiFouc.parentNode) {
                        antiFouc.parentNode.removeChild(antiFouc);
                    }
                    
                    // Ø¥Ø¶Ø§ÙØ© class Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                    if (document.documentElement) {
                        document.documentElement.classList.add('css-loaded');
                    }
                    if (document.body) {
                        document.body.classList.add('css-loaded');
                    } else {
                        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† body Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ø¨Ø¹Ø¯ØŒ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                        const checkBody = setInterval(function() {
                            if (document.body) {
                                document.body.classList.add('css-loaded');
                                clearInterval(checkBody);
                            }
                        }, 10);
                        
                        // Ø¥ÙŠÙ‚Ø§Ù Ø¨Ø¹Ø¯ 500ms
                        setTimeout(function() {
                            clearInterval(checkBody);
                        }, 500);
                    }
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰:', error);
                    // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
                    try {
                        const antiFouc = document.getElementById('anti-fouc');
                        if (antiFouc && antiFouc.parentNode) {
                            antiFouc.parentNode.removeChild(antiFouc);
                        }
                        if (document.documentElement) document.documentElement.classList.add('css-loaded');
                        if (document.body) document.body.classList.add('css-loaded');
                    } catch (e) {
                        console.error('ÙØ´Ù„ ÙÙŠ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰:', e);
                    }
                }
            }
            
            // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ CSS Ùˆ Bootstrap Icons Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ (Ù…Ø­Ø³Ù‘Ù† Ù„Ù„Ø³Ø±Ø¹Ø©)
            function checkCSSLoaded() {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† style.css - ØªØ­Ù‚Ù‚ Ø£Ø³Ø±Ø¹
                const styleSheet = document.querySelector('link[href*="style.css"]');
                const styleLoaded = styleSheet && 
                                   (styleSheet.sheet !== null || styleSheet.href) &&
                                   styleSheet.media !== 'print' && 
                                   styleSheet.getAttribute('media') !== 'print';
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Bootstrap Icons - ØªØ­Ù‚Ù‚ Ø£Ø³Ø±Ø¹
                const bootstrapIcons = document.querySelector('link[href*="bootstrap-icons"]');
                const iconsLoaded = bootstrapIcons && 
                                   (bootstrapIcons.sheet !== null || bootstrapIcons.href) &&
                                   bootstrapIcons.media !== 'print' && 
                                   bootstrapIcons.getAttribute('media') !== 'print';
                
                // âœ… Ø¥Ø°Ø§ ÙƒØ§Ù† style.css Ù…Ø­Ù…Ù‘Ù„ØŒ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙˆØ±Ø§Ù‹ (Bootstrap Icons ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ­Ù…Ù‘Ù„ Ù„Ø§Ø­Ù‚Ø§Ù‹)
                if (styleLoaded) {
                    showContent();
                    // âœ… Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ØµÙ„Ø§Ø­ Bootstrap Icons ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
                    if (!iconsLoaded && typeof ensureCSSAndIconsLoaded === 'function') {
                        setTimeout(() => ensureCSSAndIconsLoaded(), 100);
                    }
                    return true;
                }
                
                // âœ… Ø¥Ø°Ø§ ÙƒØ§Ù† Bootstrap Icons Ù…Ø­Ù…Ù‘Ù„ ÙÙ‚Ø·ØŒ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø£ÙŠØ¶Ø§Ù‹
                if (iconsLoaded) {
                    showContent();
                    // âœ… Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ØµÙ„Ø§Ø­ style.css ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
                    if (!styleLoaded && typeof ensureCSSAndIconsLoaded === 'function') {
                        setTimeout(() => ensureCSSAndIconsLoaded(), 100);
                    }
                    return true;
                }
                
                return false;
            }
            
            // âœ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¹Ù†Ø¯ DOMContentLoaded (Ù…Ø­Ø³Ù‘Ù† Ù„Ù„Ø³Ø±Ø¹Ø©)
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    // Ù…Ø­Ø§ÙˆÙ„Ø© ÙÙˆØ±ÙŠØ©
                    if (!checkCSSLoaded()) {
                        // Ù…Ø­Ø§ÙˆÙ„Ø© Ù…ØªØ¹Ø¯Ø¯Ø© - Ø¹Ø¯Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø£Ù‚Ù„ ÙˆØªØ£Ø®ÙŠØ± Ø£Ù‚Ù„
                        let attempts = 0;
                        const maxAttempts = 10; // ØªÙ‚Ù„ÙŠÙ„ Ù…Ù† 20 Ø¥Ù„Ù‰ 10
                        const checkInterval = setInterval(function() {
                            attempts++;
                            if (checkCSSLoaded() || attempts >= maxAttempts) {
                                clearInterval(checkInterval);
                                if (attempts >= maxAttempts) {
                                    showContent(); // Ø¥Ø¸Ù‡Ø§Ø± Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ CSS
                                }
                            }
                        }, 30); // ØªÙ‚Ù„ÙŠÙ„ Ù…Ù† 50ms Ø¥Ù„Ù‰ 30ms
                    }
                });
            } else {
                // Ø§Ù„ØµÙØ­Ø© Ù…Ø­Ù…Ù‘Ù„Ø© Ø¨Ø§Ù„ÙØ¹Ù„
                if (!checkCSSLoaded()) {
                    showContent(); // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¨Ø§Ø´Ø±Ø©
                }
            }
            
            // âœ… Fallback Ù…Ø­Ø³Ù‘Ù†: Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø´ÙƒÙ„ Ø£Ø³Ø±Ø¹
            setTimeout(function() {
                // âœ… Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ØµÙ„Ø§Ø­ CSS Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø­Ù…Ù‘Ù„
                if (typeof ensureCSSAndIconsLoaded === 'function') {
                    ensureCSSAndIconsLoaded();
                }
                
                // âœ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ CSS (Fallback)
                showContent();
            }, 150); // ØªÙ‚Ù„ÙŠÙ„ Ù…Ù† 500ms Ø¥Ù„Ù‰ 150ms Ù„Ù„Ø³Ø±Ø¹Ø©
        })();
    </script>
    
    <!-- Quagga - ØªØ­Ù…ÙŠÙ„ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© (lazy load) -->
    <script>
        // ØªØ­Ù…ÙŠÙ„ Quagga ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© (Ø¹Ù†Ø¯ ÙØªØ­ Ù‚Ø³Ù… Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯)
        window.loadQuagga = function() {
            if (window.quaggaLoaded) return Promise.resolve();
            window.quaggaLoaded = true;
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js';
                script.async = true;
                script.onload = () => resolve();
                script.onerror = () => reject(new Error('Failed to load Quagga'));
                document.head.appendChild(script);
            });
        };
        
        // Load html5-qrcode library for QR Code scanning (used in product returns)
        window.loadHtml5Qrcode = function() {
            return new Promise((resolve, reject) => {
                if (window.html5QrcodeLoaded) return resolve();
                if (typeof Html5Qrcode !== 'undefined') {
                    window.html5QrcodeLoaded = true;
                    resolve();
                    return;
                }
                window.html5QrcodeLoaded = true;
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js';
                script.async = true;
                script.onload = () => resolve();
                script.onerror = () => {
                    window.html5QrcodeLoaded = false;
                    reject(new Error('Failed to load html5-qrcode'));
                };
                document.head.appendChild(script);
            });
        };
    </script>
</head>
<body>
  
    <nav class="mobile-navbar" id="mobileNavbar">
        <div class="mobile-nav-container">
            <a href="#dashboard" class="mobile-nav-item active" onclick="showSection('dashboard')">
                <i class="bi bi-speedometer2"></i>
                <span>Ø§Ù„ØªØ­ÙƒÙ…</span>
            </a>
            <a href="#repairs" class="mobile-nav-item" onclick="showSection('repairs')">
                <i class="bi bi-tools"></i>
                <span>Ø§Ù„ØµÙŠØ§Ù†Ø©</span>
            </a>
            <a href="#customers" class="mobile-nav-item" onclick="showSection('customers')">
                <i class="bi bi-people"></i>
                <span>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span>
            </a>
            <a href="#inventory" class="mobile-nav-item" onclick="showSection('inventory')">
                <i class="bi bi-box-seam"></i>
                <span>Ø§Ù„Ù…Ø®Ø²Ù†</span>
            </a>
            <a href="pos.html" class="mobile-nav-item">
                <i class="bi bi-cash-coin"></i>
                <span>Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹</span>
            </a>
            <a href="#product-returns" class="mobile-nav-item" onclick="showSection('product-returns')">
                <i class="bi bi-arrow-return-left"></i>
                <span>Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
            </a>
            <a href="chat.html" class="mobile-nav-item" id="chatMobileNavLink">
                <i class="bi bi-chat-dots"></i>
                <span>Ø§Ù„Ø´Ø§Øª</span>
                <span class="nav-badge" id="chatUnreadBadgeMobile" style="display: none;">0</span>
            </a>
            <a href="#expenses" class="mobile-nav-item" onclick="showSection('expenses')">
                <i class="bi bi-cash-stack"></i>
                <span>Ø®Ø²Ù†Ø© Ø§Ù„ÙØ±Ø¹</span>
            </a>
            <a href="#settings" class="mobile-nav-item" onclick="showSection('settings')" data-permission="admin">
                <i class="bi bi-gear"></i>
                <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
            </a>
        </div>
    </nav>

    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="" alt="ALAA ZIDAN Logo" class="sidebar-logo" style="display: block;" loading="lazy" decoding="async" width="150" height="150">
            <h2 style="display: none;"><i class="bi bi-phone"></i> Ù…Ø­Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø©</h2>
        </div>
        
        <nav class="sidebar-nav">
            <a href="#dashboard" class="nav-link active" onclick="showSection('dashboard')">
                <i class="bi bi-speedometer2"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
            </a>
            <a href="#repairs" class="nav-link" onclick="showSection('repairs')">
                <i class="bi bi-tools"></i> Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©
            </a>
            <a href="#customers" class="nav-link" onclick="showSection('customers')">
                <i class="bi bi-people"></i> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
            </a>
            <a href="#inventory" class="nav-link" onclick="showSection('inventory')">
                <i class="bi bi-box-seam"></i> Ø§Ù„Ù…Ø®Ø²Ù†
            </a>
            <a href="pos.html" class="nav-link">
                <i class="bi bi-cash-coin"></i> Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹
            </a>
            <a href="#product-returns" class="nav-link" onclick="showSection('product-returns')">
                <i class="bi bi-arrow-return-left"></i> Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            </a>
            <a href="chat.html" class="nav-link" id="chatNavLink">
                <i class="bi bi-chat-dots"></i> Ø§Ù„Ø´Ø§Øª
                <span class="nav-badge" id="chatUnreadBadge" style="display: none;">0</span>
            </a>
            <a href="#expenses" class="nav-link" onclick="showSection('expenses')">
                <i class="bi bi-cash-stack"></i> Ø®Ø²Ù†Ø© Ø§Ù„ÙØ±Ø¹
            </a>
            <a href="#settings" class="nav-link" onclick="showSection('settings')" data-permission="admin">
                <i class="bi bi-gear"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-info">
                <p><i class="bi bi-person-circle"></i> <strong id="userName">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</strong></p>
                <p><i class="bi bi-shield-check"></i> <span id="userRole">Ø§Ù„Ø¯ÙˆØ±</span></p>
                <p id="userSpecialization" style="display: none;"><i class="bi bi-tools"></i> <span id="userSpecializationText">Ø§Ù„ØªØ®ØµØµ</span></p>
                <p id="sidebarUserBranch" style="display: none;"><i class="bi bi-building"></i> <span id="userBranchText">Ø§Ù„ÙØ±Ø¹</span></p>
            </div>
            <!-- Ø¹Ø±Ø¶ Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± -->
            <div class="app-version" style="text-align: center; padding: 10px 0; margin-top: 10px; border-top: 1px solid var(--border-color);">
                <button id="versionBtn" class="version-btn" onclick="showVersionModal()" style="background: none; border: none; color: var(--text-light); font-size: 0.75em; cursor: pointer; padding: 5px 10px; border-radius: 5px; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 5px;">
                    <span id="appVersionDisplay">v2.0.1</span>
                </button>
            </div>
            <button onclick="logout()" class="btn btn-danger btn-sm"><i class="bi bi-box-arrow-right"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </aside>

    <!-- Floating Chat Modal (Desktop Only) - ÙŠÙØªØ­ ÙÙŠ Ø£Ù‚ØµÙ‰ ÙŠØ³Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø© -->
    <div id="floatingChatModal" class="floating-chat-modal" style="display: none;">
        <div class="floating-chat-header">
            <h3>Z-chat</h3>
            <div class="floating-chat-header-actions">
                <button class="floating-chat-delete-btn" id="floatingChatDeleteBtn" aria-label="Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„" title="Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·)" style="display: none;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
                <button class="floating-chat-refresh-btn" id="floatingChatRefreshBtn" aria-label="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ø¦Ù„" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ø¦Ù„">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <polyline points="1 20 1 14 7 14"></polyline>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                    </svg>
                </button>
                <button class="floating-chat-close-btn" id="floatingChatCloseBtn" aria-label="Ø¥ØºÙ„Ø§Ù‚">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>
        <div class="floating-chat-body">
            <iframe id="chatIframe" src="chat.html" frameborder="0"></iframe>
        </div>
    </div>
    <div class="floating-chat-overlay" id="floatingChatOverlay" style="display: none;"></div>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <main class="main-content">
        <header class="top-bar">
            <button class="btn-menu" onclick="toggleSidebar()"><i class="bi bi-list"></i></button>
            <h1 id="pageTitle"><i class="bi bi-speedometer2"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
            <div class="header-actions">
                <span id="syncIndicator" class="sync-indicator" onclick="syncManager.manualSync()" title="Ø§Ø¶ØºØ· Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹"><i class="bi bi-arrow-repeat"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                <button id="mobileRefreshBtn" class="btn btn-icon mobile-only" onclick="syncManager.manualSync()" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"><i class="bi bi-arrow-repeat"></i></button>
                <button id="installButton" class="btn btn-primary hidden" style="display: none; margin-left: 10px; padding: 8px 16px;" title="ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚">
                    <i class="bi bi-download"></i> <span class="d-none d-md-inline">ØªØ«Ø¨ÙŠØª</span>
                </button>
                <button onclick="toggleDarkMode()" class="btn btn-icon" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ"><i class="bi bi-moon-stars"></i></button>
                <button id="notificationsBtn" onclick="toggleNotificationsList()" class="btn btn-icon" title="Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª" style="position: relative;">
                    <i class="bi bi-bell"></i>
                    <span class="notification-badge" id="notificationBadge" style="display: none; position: absolute; top: -5px; right: -5px; background: var(--danger-color); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center;">0</span>
                </button>
                
                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
                <div class="notifications-list" id="notificationsList" style="display: none; position: absolute; top: 100%; right: 0; background: var(--white); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: var(--shadow); max-height: 400px; overflow-y: auto; z-index: 1000; margin-top: 10px; min-width: 300px;">
                    <div class="notifications-header" style="display: flex; align-items: center; justify-content: space-between; padding: 15px; border-bottom: 1px solid var(--border-color);">
                        <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--text-dark);">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
                        <button class="notifications-close" onclick="toggleNotificationsList()" style="background: none; border: none; font-size: 24px; color: var(--text-light); cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s;">Ã—</button>
                    </div>
                    <div class="notifications-items" style="max-height: 350px; overflow-y: auto;"></div>
                </div>
                <button onclick="showSection('profile')" class="btn btn-icon" title="Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ"><i class="bi bi-person-circle"></i></button>
                <button onclick="logout()" class="btn btn-icon btn-logout" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"><i class="bi bi-box-arrow-right"></i></button>
            </div>
            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù‡ÙˆØ§ØªÙ -->
            <div class="mobile-top-user-info">
                <div class="mobile-user-info">
                    <p><i class="bi bi-person-circle"></i> <strong id="mobileUserName">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</strong></p>
                    <p><i class="bi bi-shield-check"></i> <span id="mobileUserRole">Ø§Ù„Ø¯ÙˆØ±</span></p>
                </div>
            </div>
        </header>

        <div class="content">
            <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
            <section id="dashboard-section" class="section active">
                <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹ -->
                <div class="branch-tabs">
                    <button type="button" class="branch-tab active" onclick="switchDashboardBranch(1)">
                        <i class="bi bi-building"></i> Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„
                    </button>
                    <button type="button" class="branch-tab" onclick="switchDashboardBranch(2)">
                        <i class="bi bi-building"></i> Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ
                    </button>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„ -->
                <div class="dashboard-branch active" data-branch="1">
                    <!-- Ù‚Ø³Ù… Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ÙÙ†ÙŠÙŠÙ† -->
                    <div class="technicians-section">
                        <div class="section-header">
                            <h2>
                                <i class="bi bi-people"></i>
                                Ø§Ù„ÙÙ†ÙŠÙˆÙ†
                            </h2>
                            <div class="technicians-filters">
                                <label for="technicianMonthFilter1" style="margin-left: 15px;">
                                    <i class="bi bi-calendar"></i>
                                    Ø§Ù„Ø´Ù‡Ø±:
                                </label>
                                <input 
                                    type="month" 
                                    id="technicianMonthFilter1" 
                                    class="filter-input"
                                    onchange="loadTechnicians(getCurrentBranchId(1), 1)"
                                >
                            </div>
                        </div>
                        <div class="technicians-grid" id="techniciansGrid1">
                            <div class="loading-placeholder">
                                <i class="bi bi-hourglass-split"></i>
                                <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙ†ÙŠÙŠÙ†...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ -->
                <div class="dashboard-branch" data-branch="2">
                    <!-- Ù‚Ø³Ù… Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ÙÙ†ÙŠÙŠÙ† -->
                    <div class="technicians-section">
                        <div class="section-header">
                            <h2>
                                <i class="bi bi-people"></i>
                                Ø§Ù„ÙÙ†ÙŠÙˆÙ†
                            </h2>
                            <div class="technicians-filters">
                                <label for="technicianMonthFilter2" style="margin-left: 15px;">
                                    <i class="bi bi-calendar"></i>
                                    Ø§Ù„Ø´Ù‡Ø±:
                                </label>
                                <input 
                                    type="month" 
                                    id="technicianMonthFilter2" 
                                    class="filter-input"
                                    onchange="loadTechnicians(getCurrentBranchId(2), 2)"
                                >
                            </div>
                        </div>
                        <div class="technicians-grid" id="techniciansGrid2">
                            <div class="loading-placeholder">
                                <i class="bi bi-hourglass-split"></i>
                                <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙ†ÙŠÙŠÙ†...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© -->
            <section id="repairs-section" class="section"></section>

            <!-- Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
            <section id="profile-section" class="section">
                <div class="section-content" id="profile-content">
                    <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                </div>
            </section>

            <!-- Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
            <section id="customers-section" class="section"></section>

            <!-- Ø§Ù„Ù…Ø®Ø²Ù† -->
            <section id="inventory-section" class="section"></section>

            <!-- Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª -->
            <section id="expenses-section" class="section"></section>

            <!-- Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
            <section id="reports-section" class="section"></section>

            <!-- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
            <section id="settings-section" class="section"></section>

            <!-- Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
            <section id="product-returns-section" class="section"></section>
        </div>
    </main>

    <!-- Critical Scripts - ØªØ­Ù…ÙŠÙ„ Ù…Ø¹ defer Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ (Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ) -->
    <script src="js/api.js" defer></script>
    <script src="js/utils.js" defer></script>
    <script src="js/loading-overlay.js" defer></script>
    <script src="js/auth.js" defer></script>
    <script src="js/permissions.js" defer></script>
    <script src="js/indexeddb-cache.js" defer></script>
    <script src="js/global-notifications.js" defer></script>
    <!-- Performance Monitor - ÙÙ‚Ø· ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ± -->
    <script>
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            const script = document.createElement('script');
            script.src = 'js/performance-monitor.js';
            script.defer = true;
            document.head.appendChild(script);
        }
    </script>
    <!-- API Batch Loader - Ù„ØªØ­Ø³ÙŠÙ† ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª API -->
    <script src="js/api-batch.js" defer></script>
    <!-- Message Polling Manager - Ù†Ø¸Ø§Ù… Ù…ÙˆØ­Ø¯ Ù„Ù€ polling Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
    <script src="js/message-polling-manager.js" defer></script>
    <!-- ğŸ”§ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡: ØªØ£Ø¬ÙŠÙ„ ØªØ­Ù…ÙŠÙ„ chat-unread-badge.js Ø­ØªÙ‰ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© -->
    <!-- âœ… ØªØ­Ø³ÙŠÙ†: ØªØ­Ù…ÙŠÙ„ chat-unread-badge.js Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø£ÙˆÙ„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† load event -->
    <script>
        // ØªØ­Ù…ÙŠÙ„ chat-unread-badge.js Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø£ÙˆÙ„ Ø£Ùˆ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù† (Ø£ÙŠÙ‡Ù…Ø§ Ø£Ø³Ø±Ø¹)
        let chatBadgeLoaded = false;
        const loadChatBadge = () => {
            if (chatBadgeLoaded) return;
            chatBadgeLoaded = true;
            const script = document.createElement('script');
            script.src = 'js/chat-unread-badge.js';
            script.async = true;
            document.body.appendChild(script);
        };
        
        // ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø£ÙˆÙ„
        ['click', 'touchstart', 'mousemove', 'keydown'].forEach(event => {
            document.addEventListener(event, loadChatBadge, { once: true, passive: true });
        });
        
        // ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù† ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
        setTimeout(loadChatBadge, 3000);
    </script>
    
    <!-- Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© - ÙØ­Øµ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙˆØ±Ø§Ù‹ -->
    <script>
        (async function protectPage() {
            try {
                // âœ… Ù…Ù†Ø¹ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
                if (window.protectPageInProgress) {
                    console.log('â¸ï¸ ÙØ­Øµ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ø§Ù„ÙØ¹Ù„');
                    return;
                }
                window.protectPageInProgress = true;
                
                // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ API Ùˆ auth
                let retries = 0;
                while ((typeof API === 'undefined' || typeof checkLogin !== 'function') && retries < 20) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    retries++;
                }
                
                if (typeof API === 'undefined' || typeof checkLogin !== 'function') {
                    console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© - Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡...');
                    window.location.replace('index.html');
                    window.protectPageInProgress = false;
                    return;
                }
                
                // âœ… ØªØ³Ø¬ÙŠÙ„Ø§Øª Ù…ÙØµÙ„Ø© Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙŠ protectPage
                console.log('ğŸ” Dashboard - protectPage - Starting authentication check');
                console.log('ğŸ” Dashboard - protectPage - Cookies:', document.cookie);
                console.log('ğŸ” Dashboard - protectPage - localStorage currentUser:', localStorage.getItem('currentUser'));
                console.log('ğŸ” Dashboard - protectPage - sessionStorage just_logged_in_time:', sessionStorage.getItem('just_logged_in_time'));
                
                // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… performAuthCheck Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† checkLogin Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
                if (typeof performAuthCheck === 'function') {
                    console.log('ğŸ” Dashboard - protectPage - Using performAuthCheck');
                    const user = await performAuthCheck();
                    console.log('ğŸ” Dashboard - protectPage - performAuthCheck returned:', user);
                    if (!user) {
                        console.log('âŒ Dashboard - protectPage - No user returned, redirecting to index.html');
                        console.log('âŒ Dashboard - protectPage - Cookies at redirect:', document.cookie);
                        window.location.replace('index.html');
                        window.protectPageInProgress = false;
                        return;
                    }
                } else {
                    console.log('ğŸ” Dashboard - protectPage - Using checkLogin (fallback)');
                    // Fallback: Ø§Ø³ØªØ®Ø¯Ø§Ù… checkLogin Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† performAuthCheck Ù…ØªØ§Ø­Ø§Ù‹
                    const user = await checkLogin();
                    console.log('ğŸ” Dashboard - protectPage - checkLogin returned:', user);
                    if (!user) {
                        console.log('âŒ Dashboard - protectPage - No user returned, redirecting to index.html');
                        console.log('âŒ Dashboard - protectPage - Cookies at redirect:', document.cookie);
                        window.location.replace('index.html');
                        window.protectPageInProgress = false;
                        return;
                    }
                }
                
                console.log('âœ… Dashboard - protectPage - Authentication check successful');
                window.protectPageInProgress = false;
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', error);
                window.location.replace('index.html');
                window.protectPageInProgress = false;
            }
        })();
    </script>
    
    <!-- Security Scripts - ØªØ­Ù…ÙŠÙ„ Ù…ØªØ£Ø®Ø± (lazy load Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„) -->
    <!-- âœ… ØªØ­Ø³ÙŠÙ†: ØªØ­Ù…ÙŠÙ„ Security Scripts Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø£ÙˆÙ„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† load event -->
    <script>
        // ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ø£Ù…Ø§Ù† Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø£ÙˆÙ„ Ø£Ùˆ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†
        let securityScriptsLoaded = false;
        const loadSecurityScripts = () => {
            if (securityScriptsLoaded) return;
            securityScriptsLoaded = true;
            
            const securityScripts = [
                { src: 'js/data-protection.js', id: 'data-protection-script' },
                { src: 'js/security.js', id: 'security-script' }
            ];
            
            securityScripts.forEach((script, index) => {
                setTimeout(() => {
                    if (!document.getElementById(script.id)) {
                        const el = document.createElement('script');
                        el.id = script.id;
                        el.src = script.src;
                        el.async = true;
                        document.body.appendChild(el);
                    }
                }, index * 100);
            });
        };
        
        // ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø£ÙˆÙ„
        ['click', 'touchstart', 'mousemove', 'keydown'].forEach(event => {
            document.addEventListener(event, loadSecurityScripts, { once: true, passive: true });
        });
        
        // ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù† ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
        setTimeout(loadSecurityScripts, 5000);
    </script>
    
    <!-- Core Features - ØªØ­Ù…ÙŠÙ„ Ù…ØªØ£Ø®Ø± Ø¬Ø¯Ø§Ù‹ (lazy load) -->
    <script>
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª ØºÙŠØ± Ø§Ù„Ø­Ø±Ø¬Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø£ÙˆÙ„
        let coreFeaturesLoaded = false;
        const loadCoreFeatures = () => {
            if (coreFeaturesLoaded) return;
            coreFeaturesLoaded = true;
            
            // âœ… ØªØ­Ø³ÙŠÙ†: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø´ÙƒÙ„ Ù…ØªÙˆØ§Ø²ÙŠ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ù…ØªØ³Ù„Ø³Ù„ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª
            const scripts = [
                'js/sync.js',
                'js/encryption.js',
                'js/encryption-settings.js'
            ];
            
            // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø´ÙƒÙ„ Ù…ØªÙˆØ§Ø²ÙŠ
            scripts.forEach(src => {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ù…Ø³Ø¨Ù‚Ø§Ù‹
                if (document.querySelector(`script[src="${src}"]`)) {
                    return;
                }
                
                const el = document.createElement('script');
                el.src = src;
                el.async = true;
                el.defer = true; // âœ… Ø¥Ø¶Ø§ÙØ© defer Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
                document.body.appendChild(el);
            });
        };
        
        // ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø£ÙˆÙ„ Ø£Ùˆ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
        document.addEventListener('DOMContentLoaded', () => {
            let loaded = false;
            const triggerLoad = () => {
                if (!loaded) {
                    loaded = true;
                    loadCoreFeatures();
                }
            };
            
            // ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„
            ['mousedown', 'touchstart', 'keydown'].forEach(event => {
                document.addEventListener(event, triggerLoad, { once: true, passive: true });
            });
            
            // ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù† ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
            setTimeout(triggerLoad, 3000);
        });
    </script>
    
    <!-- Module Scripts - ØªØ­Ù…ÙŠÙ„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© (Lazy Loading) -->
    <script>
        // ØªØ­Ù…ÙŠÙ„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù„Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© - ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
        (function() {
            const scripts = {
                critical: [
                    { src: 'js/repairs.js', defer: true },
                    { src: 'js/customers.js', defer: true },
                    { src: 'js/inventory-item-details.js', defer: true }, // âœ… ÙŠØ¬Ø¨ ØªØ­Ù…ÙŠÙ„Ù‡ Ù‚Ø¨Ù„ inventory.js
                    { src: 'js/inventory.js', defer: true },
                    { src: 'js/inventory-request.js', defer: true }
                ],
                onDemand: [
                    { src: 'js/barcode.js', id: 'barcode-script' },
                    { src: 'js/small-label.js', id: 'label-script' },
                    { src: 'js/backup-management.js', id: 'backup-script' },
                    { src: 'js/expenses.js', id: 'expenses-script' },
                    { src: 'js/reports.js', id: 'reports-script' },
                    { src: 'js/settings.js', id: 'settings-script' },
                    { src: 'js/profile.js', id: 'profile-script' },
                    { src: 'js/product-returns.js', id: 'product-returns-script' },
                    { src: 'js/pwa-install.js', id: 'pwa-script' },
                    { src: 'webauthn/webauthn.js', id: 'webauthn-script' }
                ]
            };
            
            // ğŸ”§ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡: ØªØ­Ù…ÙŠÙ„ Critical Scripts Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© ÙÙ‚Ø· (Lazy Loading Ø­Ù‚ÙŠÙ‚ÙŠ)
            document.addEventListener('DOMContentLoaded', () => {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - Ù„Ù„Ù…ÙˆØ¸Ù: ØªØ­Ù…ÙŠÙ„ ÙÙ‚Ø· (repairs.js, inventory.js)
                const userStr = localStorage.getItem('currentUser');
                const user = userStr ? JSON.parse(userStr) : null;
                const isEmployee = user && user.role === 'employee';
                
                // ØªØµÙÙŠØ© Critical Scripts Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                // âœ… Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¶Ù…ÙŠÙ† inventory-item-details.js Ù…Ø¹ inventory.js Ù„Ù„Ù…ÙˆØ¸Ù
                const scriptsToPreload = isEmployee 
                    ? scripts.critical.filter(s => s.src.includes('repairs.js') || s.src.includes('inventory'))
                    : scripts.critical;
                
                // Preload ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† ØªØ­Ù…ÙŠÙ„ ÙÙˆØ±ÙŠ) - Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
                scriptsToPreload.forEach(script => {
                    const link = document.createElement('link');
                    link.rel = 'preload';
                    link.href = script.src;
                    link.as = 'script';
                    document.head.appendChild(link);
                });
                
                // ğŸ”§ ØªØ­Ø³ÙŠÙ†: ØªØ­Ù…ÙŠÙ„ Critical Scripts ÙÙ‚Ø· Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
                // Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ script Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
                window.loadCriticalScript = function(scriptSrc) {
                    return new Promise((resolve, reject) => {
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªØ­Ù…ÙŠÙ„Ù‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹
                        if (document.querySelector(`script[src="${scriptSrc}"]`)) {
                            resolve();
                            return;
                        }
                        
                        const el = document.createElement('script');
                        el.src = scriptSrc;
                        el.defer = true;
                        el.async = true;
                        el.onload = () => resolve();
                        el.onerror = () => reject(new Error(`Failed to load ${scriptSrc}`));
                        document.body.appendChild(el);
                    });
                };
                
                // ğŸ”§ ØªØ­Ù…ÙŠÙ„ ÙÙ‚Ø· Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù‚Ø³Ù… Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© (ØªØ£Ø®ÙŠØ± Ø­ØªÙ‰ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø£Ùˆ Ø¨Ø¹Ø¯ 2 Ø«Ø§Ù†ÙŠØ©)
                let criticalScriptsLoaded = false;
                const loadCriticalScriptsOnDemand = () => {
                    if (criticalScriptsLoaded) return;
                    criticalScriptsLoaded = true;
                    
                    // ØªØ­Ù…ÙŠÙ„ Ù…Ø¹ ØªØ£Ø®ÙŠØ± ØªØ¯Ø±ÙŠØ¬ÙŠ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†
                    scriptsToPreload.forEach((script, index) => {
                        setTimeout(() => {
                            window.loadCriticalScript(script.src).catch(err => {
                                console.warn(`âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ${script.src}:`, err);
                            });
                        }, index * 150); // ØªØ£Ø®ÙŠØ± 150ms Ø¨ÙŠÙ† ÙƒÙ„ script
                    });
                };
                
                // ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø£ÙˆÙ„ Ø£Ùˆ Ø¨Ø¹Ø¯ 2 Ø«Ø§Ù†ÙŠØ© (Ø£ÙŠÙ‡Ù…Ø§ Ø£Ø³Ø±Ø¹)
                ['click', 'touchstart', 'mousemove'].forEach(event => {
                    document.addEventListener(event, loadCriticalScriptsOnDemand, { once: true, passive: true });
                });
                setTimeout(loadCriticalScriptsOnDemand, 2000); // ØªØ£Ø®ÙŠØ± 2 Ø«Ø§Ù†ÙŠØ© ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
                
                // ØªØ­Ù…ÙŠÙ„ On-Demand Scripts Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© (Lazy Loading)
                window.loadScriptOnDemand = function(scriptId) {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - Ù„Ù„Ù…ÙˆØ¸Ù: Ù…Ù†Ø¹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©
                    const userStr = localStorage.getItem('currentUser');
                    const user = userStr ? JSON.parse(userStr) : null;
                    const isEmployee = user && user.role === 'employee';
                    
                    // Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø© Ù„Ù„Ù…ÙˆØ¸Ù
                    const forbiddenScripts = ['expenses-script', 'reports-script', 'settings-script'];
                    if (isEmployee && forbiddenScripts.includes(scriptId)) {
                        console.log('ğŸš« Ù…Ù†Ø¹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù:', scriptId, 'Ù„Ù„Ù…ÙˆØ¸Ù');
                        return Promise.reject(new Error('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ù„Ù„Ù…ÙˆØ¸Ù'));
                    }
                    
                    const scriptInfo = scripts.onDemand.find(s => s.id === scriptId);
                    if (!scriptInfo) return Promise.resolve();
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªØ­Ù…ÙŠÙ„Ù‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹
                    if (document.getElementById(scriptInfo.id)) {
                        return Promise.resolve();
                    }
                    
                    return new Promise((resolve, reject) => {
                        const el = document.createElement('script');
                        el.id = scriptInfo.id;
                        el.src = scriptInfo.src;
                        el.defer = true;
                        el.onload = () => resolve();
                        el.onerror = () => reject(new Error(`Failed to load ${scriptInfo.src}`));
                        document.body.appendChild(el);
                    });
                };
                
                // Preload scripts Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø£ÙˆÙ„ (passive loading) - ØªØ£Ø®ÙŠØ± Ø£ÙƒØ«Ø±
                // ØªØ­Ù…ÙŠÙ„ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„ÙØ¹Ù„ÙŠ Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¹Ù†Ø¯ hover Ø£Ùˆ click)
                let userInteracted = false;
                const markInteraction = () => {
                    if (userInteracted) return;
                    userInteracted = true;
                    // ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„
                    setTimeout(() => {
                        ['barcode-script', 'label-script'].forEach(id => {
                            window.loadScriptOnDemand(id).catch(() => {});
                        });
                    }, 500);
                };
                
                document.addEventListener('mouseover', markInteraction, { once: true, passive: true });
                document.addEventListener('touchstart', markInteraction, { once: true, passive: true });
            });
        })();
    </script>
    
    <script>
        // Ù…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
        let isReloading = false;
        
        // ğŸ”§ Ø§Ù„Ø­Ù„: Ù…Ù†Ø¹ Service Worker reload Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        function shouldPreventReload() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙÙˆØ±ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
            if (window.__PREVENT_SW_RELOAD__ === true) {
                console.log('ğŸ›¡ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙÙˆØ±ÙŠØ© - Ù…Ù†Ø¹ reload');
                return true;
            }
            
            try {
                const justLoggedInTime = sessionStorage.getItem('just_logged_in_time');
                if (justLoggedInTime) {
                    const timeSinceLogin = Date.now() - parseInt(justLoggedInTime);
                    console.log('ğŸ” ÙØ­Øµ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', {
                        justLoggedInTime,
                        timeSinceLogin,
                        shouldPrevent: timeSinceLogin < 20000
                    });
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø­Ø¯ÙŠØ« (Ø£Ù‚Ù„ Ù…Ù† 20 Ø«Ø§Ù†ÙŠØ©)ØŒ Ù…Ù†Ø¹ reload
                    if (timeSinceLogin < 20000) {
                        console.log('â¸ï¸ Ù…Ù†Ø¹ Service Worker reload - ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø­Ø¯ÙŠØ« (' + Math.round(timeSinceLogin / 1000) + ' Ø«Ø§Ù†ÙŠØ© Ù…Ø¶Øª)');
                        return true;
                    } else {
                        // Ù…Ø³Ø­ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¥Ø°Ø§ ØªØ¬Ø§ÙˆØ²Øª 20 Ø«Ø§Ù†ÙŠØ©
                        sessionStorage.removeItem('just_logged_in_time');
                        window.__PREVENT_SW_RELOAD__ = false; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙÙˆØ±ÙŠØ©
                        console.log('âœ… Ù…Ø³Ø­ Ø¹Ù„Ø§Ù…Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - ØªØ¬Ø§ÙˆØ²Øª 20 Ø«Ø§Ù†ÙŠØ©');
                    }
                }
                return false;
            } catch (e) {
                console.error('Ø®Ø·Ø£ ÙÙŠ shouldPreventReload:', e);
                return false;
            }
        }
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ­Ø¯ÙŠØ« Service Worker - ÙŠØ¬Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ù‡Ø§ Ù‚Ø¨Ù„ Ø£ÙŠ ÙƒÙˆØ¯ Ø¢Ø®Ø± ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ SW
        if ('serviceWorker' in navigator) {
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø³Ø§Ø¦Ù„ Service Worker
            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data && event.data.type === 'SW_UPDATED') {
                    console.log('ğŸ“¨ Ø±Ø³Ø§Ù„Ø© Service Worker:', event.data.message, 'Version:', event.data.version);
                    // ğŸ”§ Ø§Ù„Ø­Ù„: Ø¥Ø²Ø§Ù„Ø© reload Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ - Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø³ÙŠØ¹ÙŠØ¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
                    // Service Worker Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
                    console.log('â„¹ï¸ Service Worker Ù…Ø­Ø¯Ø« - Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©');
                }
            });
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ø¯ÙŠØ«Ø§Øª Service Worker Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
            navigator.serviceWorker.getRegistration().then(registration => {
                if (registration) {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
                    registration.addEventListener('updatefound', () => {
                        console.log('ğŸ” ØªÙ… Ø§ÙƒØªØ´Ø§Ù ØªØ­Ø¯ÙŠØ« Service Worker');
                        const newWorker = registration.installing;
                        if (newWorker) {
                            newWorker.addEventListener('statechange', () => {
                                console.log('ğŸ“Š Ø­Ø§Ù„Ø© Service Worker Ø§Ù„Ø¬Ø¯ÙŠØ¯:', newWorker.state);
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('ğŸ”„ Service Worker ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª - Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©');
                                    // ğŸ”§ Ø§Ù„Ø­Ù„: Ø¥Ø²Ø§Ù„Ø© reload Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ - Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø³ÙŠØ¹ÙŠØ¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
                                }
                            });
                        }
                    });
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Service Worker Ù…Ø­Ø¯Ø« ÙŠÙ†ØªØ¸Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„
                    if (registration.waiting) {
                        console.log('ğŸ”„ Service Worker Ù…Ø­Ø¯Ø« Ù…ÙˆØ¬ÙˆØ¯ - Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©');
                        // ğŸ”§ Ø§Ù„Ø­Ù„: Ø¥Ø²Ø§Ù„Ø© SKIP_WAITING Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ - Service Worker Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ Ø¹Ù†Ø¯ reload ÙŠØ¯ÙˆÙŠ
                    }
                    
                    // ğŸ”§ Ø§Ù„Ø­Ù„: Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙƒÙ„ Ø«Ø§Ù†ÙŠØªÙŠÙ†
                    // Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙ‚Ø· Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
                    // setTimeout(async () => {
                    //     try {
                    //         await registration.update();
                    //     } catch (error) {
                    //         console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ø¯ÙŠØ«Ø§Øª Service Worker:', error);
                    //     }
                    // }, 2000);
                }
            }).catch(err => {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Service Worker registration:', err);
            });
        }
    </script>
    
    <script>
        let currentSection = 'dashboard';
        
        // Ù†Ø¸Ø§Ù… Ø­ÙØ¸ ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        const PAGE_STORAGE_KEY = 'current_page_section';
        const PAGE_SESSION_KEY = 'current_page_section_session'; // Ù„Ù„Ù€ refresh
        const INVENTORY_TAB_STORAGE_KEY = 'current_inventory_tab';
        
        // Ø­ÙØ¸ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ localStorage Ùˆ sessionStorage
        function saveCurrentPage(section) {
            try {
                // Ø­ÙØ¸ ÙÙŠ localStorage Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª
                localStorage.setItem(PAGE_STORAGE_KEY, section);
                localStorage.setItem(PAGE_STORAGE_KEY + '_timestamp', Date.now().toString());
                
                // Ø­ÙØ¸ ÙÙŠ sessionStorage Ù„Ù„Ù€ refresh (ÙŠÙÙ…Ø³Ø­ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ¨ÙˆÙŠØ¨)
                sessionStorage.setItem(PAGE_SESSION_KEY, section);
                
                console.log('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:', section);
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØµÙØ­Ø©:', error);
            }
        }
        
        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© - Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù€ sessionStorage (Ù„Ù„Ù€ refresh)
        function restoreCurrentPage() {
            try {
                // ğŸ”§ Ø§Ù„Ø­Ù„: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† sessionStorage Ø£ÙˆÙ„Ø§Ù‹ (Ù„Ù„Ù€ refresh)
                const sessionSection = sessionStorage.getItem(PAGE_SESSION_KEY);
                if (sessionSection) {
                    console.log('ğŸ“‚ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØµÙØ­Ø© Ù…Ù† sessionStorage (refresh):', sessionSection);
                    return sessionSection;
                }
                
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† ÙÙŠ sessionStorageØŒ Ø§Ø³ØªØ®Ø¯Ù… localStorage (Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ)
                const savedSection = localStorage.getItem(PAGE_STORAGE_KEY);
                if (savedSection) {
                    console.log('ğŸ“‚ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØµÙØ­Ø© Ù…Ù† localStorage:', savedSection);
                    // Ù†Ø³Ø® Ø¥Ù„Ù‰ sessionStorage Ù„Ù„Ù€ refresh Ø§Ù„Ù‚Ø§Ø¯Ù…
                    sessionStorage.setItem(PAGE_SESSION_KEY, savedSection);
                    return savedSection;
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØµÙØ­Ø©:', error);
            }
            return 'dashboard';
        }

        // Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© - Ù…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
        // Ù…ØªØºÙŠØ± Ù„Ù…Ù†Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©
        let authCheckInProgress = false;
        let authChecked = false;

        let cachedUser = null;
        
        async function performAuthCheck() {
            // âœ… ØªØ³Ø¬ÙŠÙ„Ø§Øª Ù…ÙØµÙ„Ø© Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙŠ dashboard
            console.log('ğŸ” Dashboard - performAuthCheck called');
            console.log('ğŸ” Dashboard - Cookies:', document.cookie);
            console.log('ğŸ” Dashboard - localStorage currentUser:', localStorage.getItem('currentUser'));
            console.log('ğŸ” Dashboard - sessionStorage just_logged_in_time:', sessionStorage.getItem('just_logged_in_time'));
            console.log('ğŸ” Dashboard - authCheckInProgress:', authCheckInProgress);
            console.log('ğŸ” Dashboard - authChecked:', authChecked);
            console.log('ğŸ” Dashboard - cachedUser:', cachedUser);
            
            // ğŸ”§ Ø§Ù„Ø­Ù„ 5: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø­Ø¯ÙŠØ« Ù‚Ø¨Ù„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ showLoginRequiredMessage
            const justLoggedInTime = sessionStorage.getItem('just_logged_in_time');
            const isRecentLogin = justLoggedInTime && (Date.now() - parseInt(justLoggedInTime)) < 15000;
            
            console.log('ğŸ” Dashboard - justLoggedInTime:', justLoggedInTime);
            console.log('ğŸ” Dashboard - isRecentLogin:', isRecentLogin);
            
            if (isRecentLogin) {
                console.log('â³ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø­Ø¯ÙŠØ« ÙÙŠ dashboard - Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø£ÙˆÙ„Ø§Ù‹...');
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø£ÙˆÙ„Ø§Ù‹
                try {
                    const savedUser = localStorage.getItem('currentUser');
                    if (savedUser) {
                        const user = JSON.parse(savedUser);
                        console.log('âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', user);
                        cachedUser = user;
                        authChecked = true;
                        // Ù…Ø³Ø­ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
                        sessionStorage.removeItem('just_logged_in_time');
                        return user;
                    }
                } catch (e) {
                    console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', e);
                }
                // Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„Ø¬Ù„Ø³Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
                console.log('â³ Dashboard - Waiting 1 second for session to be ready...');
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // Ù…Ù†Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© - Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø·Ù„Ø¨ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°ØŒ Ø§Ù†ØªØ¸Ø±
            if (authCheckInProgress) {
                console.log('â¸ï¸ Dashboard - Auth check already in progress, waiting...');
                // Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ 5 Ø«ÙˆØ§Ù†)
                let waitTime = 0;
                while (authCheckInProgress && waitTime < 5000) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    waitTime += 100;
                }
                console.log('â¸ï¸ Dashboard - Auth check finished, returning cached user:', cachedUser);
                return cachedUser;
            }
            
            // Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø§Ù„ÙØ¹Ù„ ÙˆÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­ÙÙˆØ¸ØŒ Ø£Ø±Ø¬Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if (authChecked && cachedUser) {
                console.log('âœ… Dashboard - Using cached user:', cachedUser);
                return cachedUser;
            }
            
            authCheckInProgress = true;
            console.log('ğŸ” Dashboard - Starting checkLogin...');
            try {
                const user = await checkLogin();
                console.log('ğŸ” Dashboard - checkLogin returned:', user);
                authCheckInProgress = false;
                authChecked = true;
                
                if (!user) {
                    console.log('âŒ Dashboard - No user returned from checkLogin');
                    cachedUser = null;
                    
                    // ğŸ”§ Ø§Ù„Ø­Ù„ 6: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø­Ø¯ÙŠØ« Ù‚Ø¨Ù„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ showLoginRequiredMessage
                    const justLoggedInTimeCheck = sessionStorage.getItem('just_logged_in_time');
                    if (justLoggedInTimeCheck) {
                        const timeSinceLogin = Date.now() - parseInt(justLoggedInTimeCheck);
                        // Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø­Ø¯ÙŠØ« (Ø£Ù‚Ù„ Ù…Ù† 15 Ø«Ø§Ù†ÙŠØ©)ØŒ Ù„Ø§ Ù†Ø³ØªØ¯Ø¹ÙŠ showLoginRequiredMessage
                        if (timeSinceLogin < 15000) {
                            console.log('â¸ï¸ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø­Ø¯ÙŠØ« - ØªÙ… Ø¥Ù„ØºØ§Ø¡ showLoginRequiredMessage Ù„Ù…Ù†Ø¹ loop');
                            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©
                            await new Promise(resolve => setTimeout(resolve, 2000));
                            const retryUser = await checkLogin();
                            if (retryUser) {
                                cachedUser = retryUser;
                                return retryUser;
                            }
                            // Ø¥Ø°Ø§ ÙØ´Ù„Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£ÙŠØ¶Ø§Ù‹ØŒ Ù†Ø±Ø¬Ø¹ null Ø¨Ø¯ÙˆÙ† ØªÙˆØ¬ÙŠÙ‡
                            return null;
                        }
                    }
                    
                    localStorage.clear();
                    sessionStorage.clear();
                    showLoginRequiredMessage();
                    return null;
                }
                
                cachedUser = user;
                return user;
            } catch (error) {
                authCheckInProgress = false;
                authChecked = false;
                cachedUser = null;
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', error);
                
                // ğŸ”§ Ø§Ù„Ø­Ù„ 7: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø­Ø¯ÙŠØ« Ù‚Ø¨Ù„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ showLoginRequiredMessage ÙÙŠ catch
                const justLoggedInTimeError = sessionStorage.getItem('just_logged_in_time');
                if (justLoggedInTimeError) {
                    const timeSinceLogin = Date.now() - parseInt(justLoggedInTimeError);
                    if (timeSinceLogin < 15000) {
                        console.log('â¸ï¸ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø­Ø¯ÙŠØ« ÙÙŠ catch - ØªÙ… Ø¥Ù„ØºØ§Ø¡ showLoginRequiredMessage');
                        return null;
                    }
                }
                
                localStorage.clear();
                sessionStorage.clear();
                showLoginRequiredMessage();
                return null;
            }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù† pos.html Ø£Ùˆ chat.html (Ù…ØªØºÙŠØ± Ø¹Ø§Ù…)
        let isReturningFromPOS = document.referrer.includes('pos.html') || 
                                  sessionStorage.getItem('returning_from_pos') === 'true';
        let isReturningFromChat = document.referrer.includes('chat.html') || 
                                   sessionStorage.getItem('returning_from_chat') === 'true';
        
        // âœ… Ø¥ØµÙ„Ø§Ø­ CSS Ùˆ Bootstrap Icons Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù…Ù† Ø£ÙŠ ØµÙØ­Ø© Ø®Ø§Ø±Ø¬ÙŠØ©
        if (isReturningFromPOS || isReturningFromChat) {
            // Ù…Ø³Ø­ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
            if (isReturningFromPOS) {
                sessionStorage.removeItem('returning_from_pos');
                console.log('ğŸ”„ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù† Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹ - Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰');
            }
            if (isReturningFromChat) {
                sessionStorage.removeItem('returning_from_chat');
                console.log('ğŸ”„ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù† Ø§Ù„Ø´Ø§Øª - Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰');
            }
            
            // âœ… Ø¥ØµÙ„Ø§Ø­: Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ CSS Ùˆ Bootstrap Icons Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù† POS/Chat
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù…Ù† utils.js Ù…Ø¹ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„ØªØ­Ù…ÙŠÙ„Ù‡Ø§
            const waitForUtilsAndFixCSS = (maxAttempts = 50, delay = 100) => {
                let attempts = 0;
                const checkAndFix = () => {
                    attempts++;
                    if (typeof ensureCSSAndIconsLoaded === 'function') {
                        ensureCSSAndIconsLoaded();
                        return true;
                    } else if (attempts < maxAttempts) {
                        setTimeout(checkAndFix, delay);
                        return false;
                    } else {
                        console.warn('âš ï¸ [CSS Fix] Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ utils.js Ø¨Ø¹Ø¯', maxAttempts, 'Ù…Ø­Ø§ÙˆÙ„Ø©');
                        return false;
                    }
                };
                checkAndFix();
            };
            
            waitForUtilsAndFixCSS();
            
            // ØªÙ†ÙÙŠØ° Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ DOM
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    waitForUtilsAndFixCSS();
                });
            } else {
                waitForUtilsAndFixCSS();
            }
            
            // âœ… Ø¥ØµÙ„Ø§Ø­ Ø¥Ø¶Ø§ÙÙŠ: ØªÙ†ÙÙŠØ° Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            setTimeout(() => {
                waitForUtilsAndFixCSS();
            }, 500);
        }

        // âœ… Ø¥ØµÙ„Ø§Ø­ CSS Ùˆ Bootstrap Icons Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© (refresh Ø£Ùˆ ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„)
        (function() {
            const shouldFixCSS = isReturningFromPOS || isReturningFromChat || 
                                sessionStorage.getItem('after_login_fix_css') === 'true';
            
            console.log('ğŸ”§ [CSS Fix] Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† CSS - shouldFixCSS:', shouldFixCSS, 'after_login_fix_css:', sessionStorage.getItem('after_login_fix_css'));
            
            if (shouldFixCSS) {
                // Ù…Ø³Ø­ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
                sessionStorage.removeItem('after_login_fix_css');
                console.log('âœ… [CSS Fix] ØªÙ… Ù…Ø³Ø­ Ø¹Ù„Ø§Ù…Ø© after_login_fix_css');
            }
            
            // âœ… Ø¯Ø§Ù„Ø© Ù„Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ utils.js Ø«Ù… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ensureCSSAndIconsLoaded
            const waitForUtilsAndFixCSS = (maxAttempts = 50, delay = 100) => {
                let attempts = 0;
                const checkAndFix = () => {
                    attempts++;
                    if (typeof ensureCSSAndIconsLoaded === 'function') {
                        // âœ… Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ØªØ§Ø­Ø© Ø§Ù„Ø¢Ù† - Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§
                        console.log('âœ… [CSS Fix] utils.js Ù…Ø­Ù…Ù‘Ù„ - Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ensureCSSAndIconsLoaded (Ù…Ø­Ø§ÙˆÙ„Ø©', attempts, ')');
                        ensureCSSAndIconsLoaded();
                        return true;
                    } else if (attempts < maxAttempts) {
                        // âœ… Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø«Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                        if (attempts === 1 || attempts % 10 === 0) {
                            console.log('â³ [CSS Fix] Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ utils.js... (Ù…Ø­Ø§ÙˆÙ„Ø©', attempts, '/', maxAttempts, ')');
                        }
                        setTimeout(checkAndFix, delay);
                        return false;
                    } else {
                        // âœ… ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ utils.js - ØªØ³Ø¬ÙŠÙ„ ØªØ­Ø°ÙŠØ±
                        console.warn('âš ï¸ [CSS Fix] Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ utils.js Ø¨Ø¹Ø¯', maxAttempts, 'Ù…Ø­Ø§ÙˆÙ„Ø©');
                        return false;
                    }
                };
                checkAndFix();
            };
            
            // âœ… ØªÙ†ÙÙŠØ° ÙÙˆØ±Ø§Ù‹ Ù…Ø¹ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„ØªØ­Ù…ÙŠÙ„ utils.js
            waitForUtilsAndFixCSS();
            
            // âœ… ØªÙ†ÙÙŠØ° Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ DOM
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    waitForUtilsAndFixCSS();
                });
            } else {
                waitForUtilsAndFixCSS();
            }
            
            // âœ… Ø¥ØµÙ„Ø§Ø­ Ø¥Ø¶Ø§ÙÙŠ: ØªÙ†ÙÙŠØ° Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª)
            setTimeout(() => {
                waitForUtilsAndFixCSS();
            }, 200); // ØªÙ‚Ù„ÙŠÙ„ Ù…Ù† 500ms Ø¥Ù„Ù‰ 200ms
            
            // âœ… Ø¥ØµÙ„Ø§Ø­ Ø¥Ø¶Ø§ÙÙŠ: ØªÙ†ÙÙŠØ° Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ scripts (ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª)
            setTimeout(() => {
                waitForUtilsAndFixCSS();
            }, 500); // ØªÙ‚Ù„ÙŠÙ„ Ù…Ù† 1000ms Ø¥Ù„Ù‰ 500ms
            
            // âœ… Ø¥ØµÙ„Ø§Ø­ Ø¥Ø¶Ø§ÙÙŠ: ØªÙ†ÙÙŠØ° Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ (CSS, fonts, images)
            window.addEventListener('load', () => {
                console.log('âœ… [CSS Fix] window.load Ø­Ø¯Ø« - Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ensureCSSAndIconsLoaded');
                waitForUtilsAndFixCSS(100, 50); // Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø£ÙƒØ«Ø± Ù…Ø¹ ØªØ£Ø®ÙŠØ± Ø£Ù‚Ù„
                
                // âœ… Ø¥ØµÙ„Ø§Ø­ Ø¥Ø¶Ø§ÙÙŠ: Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
                setTimeout(() => {
                    if (typeof ensureCSSAndIconsLoaded === 'function') {
                        ensureCSSAndIconsLoaded();
                    }
                    // Ø¥Ø¶Ø§ÙØ© class css-loaded Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                    if (!document.documentElement.classList.contains('css-loaded')) {
                        document.documentElement.classList.add('css-loaded');
                    }
                    if (!document.body.classList.contains('css-loaded')) {
                        document.body.classList.add('css-loaded');
                    }
                }, 100);
            });
            
            // âœ… Ø¥ØµÙ„Ø§Ø­ Ø¥Ø¶Ø§ÙÙŠ: Ø§Ø³ØªØ®Ø¯Ø§Ù… MutationObserver Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ±Ø§Øª DOM
            if (typeof MutationObserver !== 'undefined') {
                const observer = new MutationObserver((mutations) => {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ link tags
                    const hasStyleChanges = mutations.some(mutation => {
                        return Array.from(mutation.addedNodes).some(node => 
                            node.nodeName === 'LINK' && node.rel === 'stylesheet'
                        ) || mutation.type === 'attributes' && mutation.target.nodeName === 'LINK';
                    });
                    
                    if (hasStyleChanges) {
                        console.log('ğŸ” [CSS Fix] ØªÙ… Ø§ÙƒØªØ´Ø§Ù ØªØºÙŠÙŠØ± ÙÙŠ CSS - Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù‚Ù‚');
                        setTimeout(() => {
                            waitForUtilsAndFixCSS(20, 100);
                        }, 200);
                    }
                });
                
                // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ DOM
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => {
                        observer.observe(document.head, {
                            childList: true,
                            attributes: true,
                            attributeFilter: ['href', 'media', 'rel']
                        });
                    });
                } else {
                    observer.observe(document.head, {
                        childList: true,
                        attributes: true,
                        attributeFilter: ['href', 'media', 'rel']
                    });
                }
            }
        })();

        // Ø¹Ø±Ø¶ Ù‚Ø³Ù… Ù…Ø¹ÙŠÙ† - ØªØ¹Ø±ÙŠÙ Ù…Ø¨ÙƒØ± Ù„Ø¶Ù…Ø§Ù† ØªÙˆØ§ÙØ±Ù‡ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
        window.showSection = function(section, skipSave = false) {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† DOM Ø¬Ø§Ù‡Ø²
            if (document.readyState === 'loading') {
                console.warn('DOM ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ø¨Ø¹Ø¯ - Ø³ÙŠØªÙ… Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±');
                document.addEventListener('DOMContentLoaded', () => {
                    window.showSection(section, skipSave);
                });
                return;
            }

            // âœ… ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© ÙÙ‚Ø· (Lazy Loading)
            const sectionElement = document.getElementById(`${section}-section`);
            const isSectionLoaded = sectionElement && sectionElement.dataset.loaded === 'true';
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‚Ø³Ù… ØºÙŠØ± Ù…Ø­Ù…Ù‘Ù„ØŒ ØªØ­Ù…ÙŠÙ„Ù‡ Ø£ÙˆÙ„Ø§Ù‹
            if (!isSectionLoaded && section !== 'dashboard') {
                console.log(`ğŸ“¦ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… ${section} Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©...`);
                
                // âœ… Ø¥Ø¸Ù‡Ø§Ø± loading overlay Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                if (typeof showLoading === 'function') {
                    showLoading();
                } else if (window.loadingOverlay && typeof window.loadingOverlay.show === 'function') {
                    window.loadingOverlay.show();
                }
                
                loadSectionOnDemand(section).then(() => {
                    // Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø³Ù…
                    showSectionInternal(section, skipSave);
                    
                    // âœ… Ø¥Ø®ÙØ§Ø¡ loading overlay Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    // Ù†Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ØºÙŠØ± Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©
                    setTimeout(() => {
                        if (typeof hideLoading === 'function') {
                            hideLoading();
                        } else if (window.loadingOverlay && typeof window.loadingOverlay.hide === 'function') {
                            window.loadingOverlay.hide();
                        }
                    }, 300);
                }).catch(error => {
                    console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… ${section}:`, error);
                    showSectionInternal(section, skipSave);
                    
                    // âœ… Ø¥Ø®ÙØ§Ø¡ loading overlay Ø­ØªÙ‰ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
                    if (typeof hideLoading === 'function') {
                        hideLoading();
                    } else if (window.loadingOverlay && typeof window.loadingOverlay.hide === 'function') {
                        window.loadingOverlay.hide();
                    }
                });
                return;
            }
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‚Ø³Ù… Ù…Ø­Ù…Ù‘Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ø¹Ø±Ø¶Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©
            showSectionInternal(section, skipSave);
        };
        
        // Ø¯Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø³Ù…
        function showSectionInternal(section, skipSave = false) {
            console.log(`ğŸ“„ Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø³Ù…: ${section}, isReturningFromPOS: ${isReturningFromPOS}, isReturningFromChat: ${isReturningFromChat}`);
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
            const userStr = localStorage.getItem('currentUser');
            const user = userStr ? JSON.parse(userStr) : null;
            const isEmployee = user && user.role === 'employee';
            const isManager = user && user.role === 'manager';
            const isAdmin = user && user.role === 'admin';
            const isTechnician = user && user.role === 'technician';
            const branchCode = localStorage.getItem('branch_code') || '';
            
            // âœ… Ù…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ØºÙŠØ± Ø§Ù„Ù…Ø§Ù„Ùƒ
            if (section === 'dashboard' && !isAdmin) {
                console.warn('ğŸš« Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø¯ÙˆÙ† ØµÙ„Ø§Ø­ÙŠØ©');
                if (typeof showMessage === 'function') {
                    showMessage('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…', 'error');
                }
                // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                if (isEmployee) {
                    section = 'profile';
                } else if (isManager || isTechnician) {
                    section = 'repairs';
                } else {
                    section = 'repairs'; // Ø§ÙØªØ±Ø§Ø¶ÙŠ
                }
            }
            
            // âœ… Ù…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ØºÙŠØ± Ø§Ù„Ù…Ø§Ù„Ùƒ
            if (section === 'settings' && !isAdmin) {
                console.warn('ğŸš« Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø¯ÙˆÙ† ØµÙ„Ø§Ø­ÙŠØ©');
                if (typeof showMessage === 'function') {
                    showMessage('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'error');
                }
                // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                if (isEmployee) {
                    section = 'profile';
                } else if (isManager || isTechnician) {
                    section = 'repairs';
                } else {
                    section = 'repairs'; // Ø§ÙØªØ±Ø§Ø¶ÙŠ
                }
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª product-returns
            if (section === 'product-returns') {
                let hasPermission = false;
                
                // Ø§Ù„Ù…Ø§Ù„Ùƒ Ù„Ù‡ ÙƒØ§Ù…Ù„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
                if (isAdmin) {
                    hasPermission = true;
                }
                // Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙŠ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„
                else if (isManager && (!branchCode || branchCode === 'HANOVIL')) {
                    hasPermission = true;
                }
                // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡Ù…
                else if (isEmployee) {
                    hasPermission = true;
                }
                
                if (!hasPermission) {
                    console.warn('ğŸš« Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¯ÙˆÙ† ØµÙ„Ø§Ø­ÙŠØ©');
                    if (typeof showMessage === 'function') {
                        showMessage('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…', 'error');
                    }
                    section = 'repairs';
                }
            }
            
            if (isEmployee) {
                // Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© Ù„Ù„Ù…ÙˆØ¸Ù: repairs, inventory, profile, product-returns
                // Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø© Ù„Ù„Ù…ÙˆØ¸Ù
                const forbiddenSections = ['dashboard', 'customers', 'expenses', 'reports', 'settings'];
                
                if (forbiddenSections.includes(section)) {
                    console.warn('ğŸš« Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ù…Ø­Ø¸ÙˆØ± Ù„Ù„Ù…ÙˆØ¸Ù:', section);
                    if (typeof showMessage === 'function') {
                        showMessage('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…', 'error');
                    }
                    // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ§Ù†Ø© ÙƒØ¨Ø¯ÙŠÙ„
                    section = 'repairs';
                }
            }
            
            // âœ… Ù…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù„Ù…Ø¯ÙŠØ± ÙˆØ§Ù„ÙÙ†ÙŠ Ø£ÙŠØ¶Ø§Ù‹
            if ((isManager || isTechnician) && section === 'settings') {
                console.warn('ğŸš« Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø¯ÙˆÙ† ØµÙ„Ø§Ø­ÙŠØ©');
                if (typeof showMessage === 'function') {
                    showMessage('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'error');
                }
                section = 'repairs';
            }
            
            // Ø­ÙØ¸ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ localStorage (Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† skipSave = true)
            if (!skipSave && typeof saveCurrentPage === 'function') {
                saveCurrentPage(section);
            }
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ø´ÙƒÙ„ Ù‚ÙˆÙŠ - Ù…Ù†Ø¹ Ø£ÙŠ ØªØ¹Ø§Ø±Ø¶Ø§Øª
            document.querySelectorAll('.section').forEach(sec => {
                sec.classList.remove('active');
                // Ø¥Ø¶Ø§ÙØ© style Ù…Ø¨Ø§Ø´Ø± Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¥Ø®ÙØ§Ø¡
                sec.style.display = 'none';
            });
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© Ù„Ù„Ù…Ø®Ø²Ù† Ø£ÙŠØ¶Ø§Ù‹
            document.querySelectorAll('.inventory-section').forEach(sec => {
                sec.classList.remove('active');
                sec.style.display = 'none';
            });
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ù€ navbar Ø§Ù„Ø¹Ø§Ø¦Ù…
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯
            const targetSection = document.getElementById(`${section}-section`);
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ø§Ù„Ù‚Ø³Ù…
            const hasContent = targetSection && targetSection.innerHTML.trim().length > 0;
            const hasMinContent = targetSection && targetSection.innerHTML.trim().length > 100;
            
            console.log(`ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø³Ù… ${section}: hasContent=${hasContent}, hasMinContent=${hasMinContent}, length=${targetSection ? targetSection.innerHTML.trim().length : 0}`);
            
            if (targetSection) {
                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙ‚Ø·
                targetSection.classList.add('active');
                targetSection.style.display = 'block';
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                document.querySelectorAll('.section').forEach(sec => {
                    if (sec !== targetSection) {
                        sec.classList.remove('active');
                        sec.style.display = 'none';
                    }
                });
                
                // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© Ù„Ù„Ù…Ø®Ø²Ù† Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù‡Ùˆ Ø§Ù„Ù…Ø®Ø²Ù†
                if (section !== 'inventory') {
                    document.querySelectorAll('.inventory-section').forEach(sec => {
                        sec.classList.remove('active');
                        sec.style.display = 'none';
                    });
                }
                
                // Ø¹Ù†Ø¯ Ø¹Ø±Ø¶ dashboardØŒ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙˆØ§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„ ÙŠØ¸Ù‡Ø±Ø§Ù†
                if (section === 'dashboard') {
                    // âœ… Ø¥ØµÙ„Ø§Ø­: Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙÙˆØ±Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹ (Ø¨Ø¯ÙˆÙ† ØªØ£Ø®ÙŠØ±)
                    const branchTabs = targetSection.querySelector('.branch-tabs');
                    if (branchTabs) {
                        branchTabs.style.display = 'flex';
                        branchTabs.style.visibility = 'visible';
                        branchTabs.style.opacity = '1';
                        console.log('âœ… [Dashboard] ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹ ÙÙˆØ±Ø§Ù‹');
                    }
                    
                    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„ Ù†Ø´Ø· ÙÙˆØ±Ø§Ù‹
                    const firstBranch = targetSection.querySelector('.dashboard-branch[data-branch="1"]');
                    const secondBranch = targetSection.querySelector('.dashboard-branch[data-branch="2"]');
                    if (firstBranch) {
                        if (!firstBranch.classList.contains('active')) {
                            firstBranch.classList.add('active');
                        }
                        firstBranch.style.display = 'block';
                    }
                    if (secondBranch) {
                        if (secondBranch.classList.contains('active')) {
                            secondBranch.classList.remove('active');
                        }
                        secondBranch.style.display = 'none';
                    }
                    
                    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„ Ù†Ø´Ø· ÙÙˆØ±Ø§Ù‹
                    const firstTab = targetSection.querySelector('.branch-tab:nth-child(1)');
                    const secondTab = targetSection.querySelector('.branch-tab:nth-child(2)');
                    if (firstTab && !firstTab.classList.contains('active')) {
                        firstTab.classList.add('active');
                    }
                    if (secondTab && secondTab.classList.contains('active')) {
                        secondTab.classList.remove('active');
                    }
                    
                    // âœ… Ø¥ØµÙ„Ø§Ø­: ÙƒÙˆØ¯ Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„Ù„ØªØ£ÙƒØ¯ (Ø®Ø§ØµØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù† POS)
                    setTimeout(() => {
                        const branchTabs = targetSection.querySelector('.branch-tabs');
                        console.log('ğŸ” [Dashboard] ÙØ­Øµ Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹:', branchTabs);
                        if (branchTabs) {
                            branchTabs.style.display = 'flex';
                            branchTabs.style.visibility = 'visible';
                            branchTabs.style.opacity = '1';
                            console.log('âœ… [Dashboard] ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹ (ÙØ­Øµ Ø§Ø­ØªÙŠØ§Ø·ÙŠ)');
                        } else {
                            console.warn('âš ï¸ [Dashboard] Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹ ÙÙŠ dashboard-section');
                        }
                        
                        const firstBranch = targetSection.querySelector('.dashboard-branch[data-branch="1"]');
                        const secondBranch = targetSection.querySelector('.dashboard-branch[data-branch="2"]');
                        if (firstBranch) {
                            if (!firstBranch.classList.contains('active')) {
                                firstBranch.classList.add('active');
                            }
                            firstBranch.style.display = 'block';
                        }
                        if (secondBranch) {
                            if (secondBranch.classList.contains('active')) {
                                secondBranch.classList.remove('active');
                            }
                            secondBranch.style.display = 'none';
                        }
                        
                        const firstTab = targetSection.querySelector('.branch-tab:nth-child(1)');
                        const secondTab = targetSection.querySelector('.branch-tab:nth-child(2)');
                        if (firstTab && !firstTab.classList.contains('active')) {
                            firstTab.classList.add('active');
                        }
                        if (secondTab && secondTab.classList.contains('active')) {
                            secondTab.classList.remove('active');
                        }
                    }, (isReturningFromPOS || isReturningFromChat) ? 200 : 50); // ØªØ£Ø®ÙŠØ± Ø£Ø·ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù† POS Ø£Ùˆ Chat
                }
                
                // ØªØ­Ù…ÙŠÙ„ product-returns Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
                let skipContentCheck = false;
                if (section === 'product-returns') {
                    if (typeof loadProductReturnsSection !== 'function') {
                        console.log('ØªØ­Ù…ÙŠÙ„ product-returns.js...');
                        skipContentCheck = true; // ØªØ®Ø·ÙŠ ÙØ­Øµ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙÙˆØ±ÙŠ Ù„Ø£Ù† Ø§Ù„Ø³ÙƒØ±Ø¨Øª ÙŠØ¬Ø±ÙŠ ØªØ­Ù…ÙŠÙ„Ù‡
                        if (typeof loadScriptOnDemand === 'function') {
                            loadScriptOnDemand('product-returns-script').then(() => {
                                console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ product-returns.js Ø¨Ù†Ø¬Ø§Ø­');
                                if (typeof loadProductReturnsSection === 'function') {
                                    loadProductReturnsSection();
                                } else {
                                    console.error('loadProductReturnsSection ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù');
                                }
                            }).catch(err => {
                                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ product-returns.js:', err);
                            });
                        }
                    } else {
                        loadProductReturnsSection();
                    }
                }
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‚Ø³Ù… ÙØ§Ø±ØºØ§Ù‹ Ø£Ùˆ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ ÙƒØ§ÙÙØŒ Ù†Ø¹ÙŠØ¯ ØªØ­Ù…ÙŠÙ„Ù‡
                // ØªØ®Ø·ÙŠ Ø§Ù„ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† product-returns ÙŠØ¬Ø±ÙŠ ØªØ­Ù…ÙŠÙ„Ù‡ Ø­Ø§Ù„ÙŠØ§Ù‹
                if ((!hasContent || !hasMinContent) && !skipContentCheck) {
                    console.log(`âš ï¸ Ø§Ù„Ù‚Ø³Ù… ${section} ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ ÙƒØ§ÙÙ (${targetSection.innerHTML.trim().length} Ø­Ø±Ù)ØŒ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„...`);
                    
                    // âœ… ØªØ­Ø³ÙŠÙ†: Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù† POS Ø£Ùˆ ChatØŒ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ scripts Ø£ÙˆÙ„Ø§Ù‹
                    if (isReturningFromPOS || isReturningFromChat) {
                        console.log('ğŸ”„ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù† POS/Chat - ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ scripts Ø£ÙˆÙ„Ø§Ù‹...');
                        
                        // âœ… Ø¥Ø¸Ù‡Ø§Ø± loading overlay Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                        if (typeof showLoading === 'function') {
                            showLoading();
                        } else if (window.loadingOverlay && typeof window.loadingOverlay.show === 'function') {
                            window.loadingOverlay.show();
                        }
                        
                        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ scripts Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
                        const loadRequiredScript = async () => {
                            try {
                                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ script Ø£ÙˆÙ„Ø§Ù‹
                                if (section === 'repairs' && typeof loadCriticalScript === 'function') {
                                    await loadCriticalScript('js/repairs.js').catch(() => {});
                                } else if (section === 'customers' && typeof loadCriticalScript === 'function') {
                                    await loadCriticalScript('js/customers.js').catch(() => {});
                                } else if (section === 'inventory' && typeof loadCriticalScript === 'function') {
                                    await loadCriticalScript('js/inventory.js').catch(() => {});
                                } else if (section === 'expenses' && typeof loadScriptOnDemand === 'function') {
                                    await loadScriptOnDemand('expenses-script').catch(() => {});
                                } else if (section === 'reports' && typeof loadScriptOnDemand === 'function') {
                                    await loadScriptOnDemand('reports-script').catch(() => {});
                                } else if (section === 'product-returns' && typeof loadScriptOnDemand === 'function') {
                                    await loadScriptOnDemand('product-returns-script').catch(() => {});
                                }
                                
                                // Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ script
                                await new Promise(resolve => setTimeout(resolve, 300));
                                
                                // Ø§Ù„Ø¢Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…
                                if (section === 'repairs' && typeof loadRepairsSection === 'function') {
                                    await loadRepairsSection();
                                } else if (section === 'customers' && typeof loadCustomersSection === 'function') {
                                    await loadCustomersSection();
                                } else if (section === 'inventory' && typeof loadInventorySection === 'function') {
                                    await loadInventorySection();
                                } else if (section === 'expenses' && typeof loadExpensesSection === 'function') {
                                    await loadExpensesSection();
                                } else if (section === 'reports' && typeof loadReportsSection === 'function') {
                                    await loadReportsSection();
                                } else if (section === 'product-returns' && typeof loadProductReturnsSection === 'function') {
                                    await loadProductReturnsSection();
                                }
                                
                                console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… ${section} Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù† POS`);
                            } catch (error) {
                                console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… ${section}:`, error);
                            } finally {
                                // âœ… Ø¥Ø®ÙØ§Ø¡ loading overlay Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                                setTimeout(() => {
                                    if (typeof hideLoading === 'function') {
                                        hideLoading();
                                    } else if (window.loadingOverlay && typeof window.loadingOverlay.hide === 'function') {
                                        window.loadingOverlay.hide();
                                    }
                                }, 300);
                            }
                        };
                        
                        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ scripts ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰
                        loadRequiredScript();
                        return; // Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ø£Ù† Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø³ÙŠØ­Ø¯Ø« Ø¨Ø´ÙƒÙ„ async
                    }
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± (Ù„Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©)
                    const reloadDelay = 200;
                    setTimeout(async () => {
                        // âœ… Ø¥Ø¸Ù‡Ø§Ø± loading overlay Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                        if (typeof showLoading === 'function') {
                            showLoading();
                        } else if (window.loadingOverlay && typeof window.loadingOverlay.show === 'function') {
                            window.loadingOverlay.show();
                        }
                        
                        try {
                            // ğŸ”§ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡: ØªØ­Ù…ÙŠÙ„ critical script Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
                            if (section === 'repairs') {
                                if (typeof loadCriticalScript === 'function') {
                                    await loadCriticalScript('js/repairs.js').catch(() => {});
                                }
                                if (typeof loadRepairsSection === 'function') {
                                    await loadRepairsSection();
                                }
                            } else if (section === 'customers') {
                                if (typeof loadCriticalScript === 'function') {
                                    await loadCriticalScript('js/customers.js').catch(() => {});
                                }
                                if (typeof loadCustomersSection === 'function') {
                                    await loadCustomersSection();
                                }
                            } else if (section === 'inventory') {
                                // âœ… ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ inventory-item-details.js Ù‚Ø¨Ù„ inventory.js
                                if (typeof loadCriticalScript === 'function') {
                                    if (typeof showInventoryItemDetails !== 'function') {
                                        await loadCriticalScript('js/inventory-item-details.js').catch(() => {});
                                    }
                                    await loadCriticalScript('js/inventory.js').catch(() => {});
                                }
                                if (typeof loadInventorySection === 'function') {
                                    await loadInventorySection();
                                }
                            } else if (section === 'expenses' && typeof loadExpensesSection === 'function') {
                                await loadExpensesSection();
                            } else if (section === 'reports' && typeof loadReportsSection === 'function') {
                                await loadReportsSection();
                            } else if (section === 'product-returns') {
                                // ØªØ­Ù…ÙŠÙ„ product-returns.js Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø­Ù…Ù„Ø§Ù‹
                                if (typeof loadProductReturnsSection !== 'function') {
                                    if (typeof loadScriptOnDemand === 'function') {
                                        await loadScriptOnDemand('product-returns-script').then(async () => {
                                            console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ product-returns.js Ø¨Ù†Ø¬Ø§Ø­ (Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„)');
                                            if (typeof loadProductReturnsSection === 'function') {
                                                await loadProductReturnsSection();
                                            } else {
                                                console.error('loadProductReturnsSection ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù');
                                            }
                                        }).catch(err => {
                                            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ product-returns.js:', err);
                                        });
                                    }
                                } else {
                                    await loadProductReturnsSection();
                                }
                            } else {
                                // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ØªÙˆÙØ±Ø©ØŒ Ù†Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø«Ù… Ù†Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                                if (typeof updateSectionData === 'function') {
                                    setTimeout(() => {
                                        updateSectionData(section, true);
                                    }, 500);
                                }
                            }
                            
                            // âœ… Ø¥Ø®ÙØ§Ø¡ loading overlay Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                            setTimeout(() => {
                                if (typeof hideLoading === 'function') {
                                    hideLoading();
                                } else if (window.loadingOverlay && typeof window.loadingOverlay.hide === 'function') {
                                    window.loadingOverlay.hide();
                                }
                            }, 300);
                        } catch (error) {
                            console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… ${section}:`, error);
                            // âœ… Ø¥Ø®ÙØ§Ø¡ loading overlay Ø­ØªÙ‰ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
                            if (typeof hideLoading === 'function') {
                                hideLoading();
                            } else if (window.loadingOverlay && typeof window.loadingOverlay.hide === 'function') {
                                window.loadingOverlay.hide();
                            }
                        }
                    }, reloadDelay);
                }
            } else {
                console.warn('Ø§Ù„Ù‚Ø³Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯:', section);
                // ğŸ”§ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡: ØªØ­Ù…ÙŠÙ„ critical script Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
                if (section === 'repairs') {
                    if (typeof loadCriticalScript === 'function') {
                        loadCriticalScript('js/repairs.js').then(() => {
                            if (typeof loadRepairsSection === 'function') loadRepairsSection();
                        }).catch(() => {});
                    } else if (typeof loadRepairsSection === 'function') {
                        loadRepairsSection();
                    }
                } else if (section === 'customers') {
                    if (typeof loadCriticalScript === 'function') {
                        loadCriticalScript('js/customers.js').then(() => {
                            if (typeof loadCustomersSection === 'function') loadCustomersSection();
                        }).catch(() => {});
                    } else if (typeof loadCustomersSection === 'function') {
                        loadCustomersSection();
                    }
                } else if (section === 'inventory') {
                    if (typeof loadCriticalScript === 'function') {
                        loadCriticalScript('js/inventory.js').then(() => {
                            if (typeof loadInventorySection === 'function') loadInventorySection();
                        }).catch(() => {});
                    } else if (typeof loadInventorySection === 'function') {
                        loadInventorySection();
                    }
                } else if (section === 'expenses' && typeof loadExpensesSection === 'function') {
                    loadExpensesSection();
                } else if (section === 'reports' && typeof loadReportsSection === 'function') {
                    loadReportsSection();
                } else if (section === 'product-returns') {
                    // ØªØ­Ù…ÙŠÙ„ product-returns.js Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø­Ù…Ù„Ø§Ù‹
                    console.log('Ø§Ù„Ù‚Ø³Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ ØªØ­Ù…ÙŠÙ„ product-returns.js...');
                    if (typeof loadProductReturnsSection !== 'function') {
                        if (typeof loadScriptOnDemand === 'function') {
                            loadScriptOnDemand('product-returns-script').then(() => {
                                console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ product-returns.js Ø¨Ù†Ø¬Ø§Ø­');
                                if (typeof loadProductReturnsSection === 'function') {
                                    loadProductReturnsSection();
                                } else {
                                    console.error('loadProductReturnsSection ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù');
                                }
                            }).catch(err => {
                                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ product-returns.js:', err);
                            });
                        }
                    } else {
                        loadProductReturnsSection();
                    }
                } else if (section === 'settings') {
                    // âœ… ØªØ­Ù…ÙŠÙ„ settings.js Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø­Ù…Ù„Ø§Ù‹ - Ø·Ø±ÙŠÙ‚Ø© Ù…Ø­Ø³Ù‘Ù†Ø©
                    const loadSettingsScript = () => {
                        return new Promise((resolve, reject) => {
                            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù€ script ØºÙŠØ± Ù…Ø­Ù…Ù‘Ù„ Ø¨Ø§Ù„ÙØ¹Ù„
                            const existingScript = document.querySelector('script[src="js/settings.js"]');
                            if (existingScript) {
                                console.log('âœ… settings.js Ù…Ø­Ù…Ù‘Ù„ Ø¨Ø§Ù„ÙØ¹Ù„');
                                resolve();
                                return;
                            }
                            
                            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ script Ù…Ø¨Ø§Ø´Ø±Ø©
                            const script = document.createElement('script');
                            script.src = 'js/settings.js';
                            script.async = true;
                            script.defer = true;
                            
                            script.onload = () => {
                                console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ settings.js Ø¨Ù†Ø¬Ø§Ø­');
                                resolve();
                            };
                            
                            script.onerror = (error) => {
                                console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ settings.js:', error);
                                reject(new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ settings.js'));
                            };
                            
                            document.body.appendChild(script);
                        });
                    };
                    
                    if (typeof loadSettingsSection !== 'function') {
                        console.log('ğŸ“¦ ØªØ­Ù…ÙŠÙ„ settings.js...');
                        loadSettingsScript().then(() => {
                            // âœ… Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† ØªÙ†ÙÙŠØ° Ø§Ù„Ù€ script Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                            return new Promise(resolve => setTimeout(resolve, 300));
                        }).then(() => {
                            // âœ… Ù…Ø­Ø§ÙˆÙ„Ø© Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø§Ù„Ø©
                            let attempts = 0;
                            const maxAttempts = 15;
                            const checkFunction = () => {
                                attempts++;
                                console.log(`ğŸ” Ù…Ø­Ø§ÙˆÙ„Ø© ${attempts}/${maxAttempts} Ù„Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ loadSettingsSection...`);
                                
                                if (typeof loadSettingsSection === 'function') {
                                    console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ loadSettingsSection Ø¨Ø¹Ø¯', attempts, 'Ù…Ø­Ø§ÙˆÙ„Ø©');
                                    loadSettingsSection();
                                } else if (attempts < maxAttempts) {
                                    setTimeout(checkFunction, 150);
                                } else {
                                    console.error('âŒ loadSettingsSection ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø¨Ø¹Ø¯', maxAttempts, 'Ù…Ø­Ø§ÙˆÙ„Ø©');
                                    console.error('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† window.loadSettingsSection:', typeof window.loadSettingsSection);
                                    console.error('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† loadSettingsSection:', typeof loadSettingsSection);
                                    
                                    const settingsSection = document.getElementById('settings-section');
                                    if (settingsSection) {
                                        settingsSection.innerHTML = `
                                            <div style="text-align: center; padding: 40px; color: var(--danger-color);">
                                                <i class="bi bi-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                                                <p>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</p>
                                                <p style="font-size: 0.9em; margin-top: 10px; color: #999;">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¯Ø§Ù„Ø© loadSettingsSection</p>
                                                <p style="font-size: 0.8em; margin-top: 5px; color: #999;">ÙŠØ±Ø¬Ù‰ ÙØªØ­ Console Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</p>
                                                <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 20px;">
                                                    <i class="bi bi-arrow-clockwise"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
                                                </button>
                                            </div>
                                        `;
                                    }
                                }
                            };
                            checkFunction();
                        }).catch(err => {
                            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ settings.js:', err);
                            const settingsSection = document.getElementById('settings-section');
                            if (settingsSection) {
                                settingsSection.innerHTML = `
                                    <div style="text-align: center; padding: 40px; color: var(--danger-color);">
                                        <i class="bi bi-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                                        <p>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</p>
                                        <p style="font-size: 0.9em; margin-top: 10px; color: #999;">${(err?.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>
                                        <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 20px;">
                                            <i class="bi bi-arrow-clockwise"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
                                        </button>
                                    </div>
                                `;
                            }
                        });
                    } else {
                        console.log('âœ… loadSettingsSection Ù…ØªÙˆÙØ±Ø© Ø¨Ø§Ù„ÙØ¹Ù„');
                        loadSettingsSection();
                    }
                } else if (section === 'profile') {
                    // ØªØ­Ù…ÙŠÙ„ profile.js Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø­Ù…Ù„Ø§Ù‹
                    if (typeof loadProfileSection !== 'function') {
                        if (typeof loadScriptOnDemand === 'function') {
                            loadScriptOnDemand('profile-script').then(() => {
                                if (typeof loadProfileSection === 'function') {
                                    loadProfileSection();
                                }
                            }).catch(err => {
                                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ profile.js:', err);
                            });
                        }
                    } else {
                        loadProfileSection();
                    }
                }
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…
                setTimeout(() => {
                    const retrySection = document.getElementById(`${section}-section`);
                    if (retrySection) {
                        retrySection.classList.add('active');
                    }
                }, 100);
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ù‚Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
            if (section === 'profile') {
                // ØªØ­Ù…ÙŠÙ„ profile.js Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø­Ù…Ù„Ø§Ù‹
                if (typeof loadProfileSection !== 'function') {
                    if (typeof loadScriptOnDemand === 'function') {
                        loadScriptOnDemand('profile-script').then(() => {
                            if (typeof loadProfileSection === 'function') {
                                loadProfileSection();
                            }
                        }).catch(err => {
                            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ profile.js:', err);
                        });
                    }
                } else {
                    loadProfileSection();
                }
            }
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø· (Ø§Ø³ØªØ®Ø¯Ø§Ù… window.event Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹ØŒ Ø£Ùˆ Ø§Ù„Ø¨Ø­Ø« ÙŠØ¯ÙˆÙŠØ§Ù‹)
            const event = window.event || null;
            if (event && event.target) {
                const navLink = event.target.closest('.nav-link');
                if (navLink) {
                    navLink.classList.add('active');
                }
                const mobileNavItem = event.target.closest('.mobile-nav-item');
                if (mobileNavItem) {
                    mobileNavItem.classList.add('active');
                }
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ eventØŒ Ù†Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¯ÙˆÙŠØ§Ù‹
                document.querySelectorAll('.nav-link').forEach(link => {
                    if (link.getAttribute('onclick') && link.getAttribute('onclick').includes(`'${section}'`)) {
                        link.classList.add('active');
                    }
                });
                document.querySelectorAll('.mobile-nav-item').forEach(item => {
                    if (item.getAttribute('onclick') && item.getAttribute('onclick').includes(`'${section}'`)) {
                        item.classList.add('active');
                    }
                });
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©
            const titles = {
                'dashboard': 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…',
                'repairs': 'Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©',
                'customers': 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡',
                'inventory': 'Ø§Ù„Ù…Ø®Ø²Ù†',
                'expenses': 'Ø®Ø²Ù†Ø© Ø§Ù„ÙØ±Ø¹',
                'reports': 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©',
                'settings': 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
                'profile': 'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ'
            };
            
            const icons = {
                'dashboard': 'bi-speedometer2',
                'repairs': 'bi-tools',
                'customers': 'bi-people',
                'inventory': 'bi-box-seam',
                'expenses': 'bi-cash-stack',
                'reports': 'bi-graph-up',
                'settings': 'bi-gear',
                'profile': 'bi-person-circle'
            };
            
            if (titles[section]) {
                const pageTitle = document.getElementById('pageTitle');
                if (pageTitle) {
                    const iconClass = icons[section] || 'bi-speedometer2';
                    pageTitle.innerHTML = `<i class="bi ${iconClass}"></i> ${titles[section]}`;
                }
            }
            if (typeof currentSection !== 'undefined') {
                currentSection = section;
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª - Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ÙƒØ§Ù…Ù„Ø©
            // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø®ÙŠØ± Ù„Ø¶Ù…Ø§Ù† Ø£Ù† DOM Ø¬Ø§Ù‡Ø²
            if (typeof updateSectionData === 'function') {
                const updateDelay = (isReturningFromPOS || isReturningFromChat) ? 300 : 100;
                setTimeout(() => {
                    updateSectionData(section, true); // true = Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ÙƒØ§Ù…Ù„Ø©
                }, updateDelay);
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ navbar Ø§Ù„Ø¹Ø§Ø¦Ù…
            if (typeof updateMobileNavbar === 'function') {
                updateMobileNavbar(section);
            }
            
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ sidebar ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù‡Ø§ØªÙ Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± ØªØ¨ÙˆÙŠØ¨
            if (window.innerWidth <= 575.98) {
                const sidebar = document.getElementById('sidebar');
                const mobileMenuBtn = document.getElementById('mobileMenuBtn') || document.querySelector('.btn-menu');
                if (sidebar) {
                    sidebar.classList.remove('open');
                }
                if (mobileMenuBtn) {
                    mobileMenuBtn.innerHTML = '<i class="bi bi-list"></i>';
                }
            }
        };
        
        // âœ… Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© (Lazy Loading)
        async function loadSectionOnDemand(section) {
            const sectionElement = document.getElementById(`${section}-section`);
            if (!sectionElement) {
                console.warn(`âš ï¸ Ø§Ù„Ù‚Ø³Ù… ${section} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ DOM`);
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù‚Ø³Ù… ØºÙŠØ± Ù…Ø­Ù…Ù‘Ù„ Ø¨Ø§Ù„ÙØ¹Ù„
            if (sectionElement.dataset.loaded === 'true') {
                return; // Ø§Ù„Ù‚Ø³Ù… Ù…Ø­Ù…Ù‘Ù„ Ø¨Ø§Ù„ÙØ¹Ù„
            }
            
            console.log(`ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ù‚Ø³Ù… ${section}...`);
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
            switch(section) {
                case 'repairs':
                    if (typeof loadRepairsSection === 'function') {
                        await loadRepairsSection();
                    } else if (typeof loadCriticalScript === 'function') {
                        await loadCriticalScript('js/repairs.js');
                        if (typeof loadRepairsSection === 'function') {
                            await loadRepairsSection();
                        }
                    }
                    break;
                    
                case 'customers':
                    if (typeof loadCustomersSection === 'function') {
                        await loadCustomersSection();
                    } else if (typeof loadCriticalScript === 'function') {
                        await loadCriticalScript('js/customers.js');
                        if (typeof loadCustomersSection === 'function') {
                            await loadCustomersSection();
                        }
                    }
                    break;
                    
                case 'inventory':
                    // âœ… ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ inventory-item-details.js Ù‚Ø¨Ù„ inventory.js
                    if (typeof loadCriticalScript === 'function') {
                        // ØªØ­Ù…ÙŠÙ„ inventory-item-details.js Ø£ÙˆÙ„Ø§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø­Ù…Ù„Ø§Ù‹
                        if (typeof showInventoryItemDetails !== 'function') {
                            await loadCriticalScript('js/inventory-item-details.js');
                        }
                        // ØªØ­Ù…ÙŠÙ„ inventory.js
                        if (typeof loadInventorySection !== 'function') {
                            await loadCriticalScript('js/inventory.js');
                        }
                    }
                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
                    if (typeof loadInventorySection === 'function') {
                        await loadInventorySection();
                    }
                    break;
                    
                case 'expenses':
                    if (typeof loadExpensesSection === 'function') {
                        await loadExpensesSection();
                    } else if (typeof loadScriptOnDemand === 'function') {
                        await loadScriptOnDemand('expenses-script');
                        if (typeof loadExpensesSection === 'function') {
                            await loadExpensesSection();
                        }
                    }
                    break;
                    
                case 'reports':
                    if (typeof loadReportsSection === 'function') {
                        await loadReportsSection();
                    } else if (typeof loadScriptOnDemand === 'function') {
                        await loadScriptOnDemand('reports-script');
                        if (typeof loadReportsSection === 'function') {
                            await loadReportsSection();
                        }
                    }
                    break;
                    
                case 'settings':
                    if (typeof loadSettingsSection === 'function') {
                        await loadSettingsSection();
                    } else if (typeof loadScriptOnDemand === 'function') {
                        await loadScriptOnDemand('settings-script');
                        if (typeof loadSettingsSection === 'function') {
                            await loadSettingsSection();
                        }
                    }
                    break;
                    
                case 'product-returns':
                    if (typeof loadProductReturnsSection === 'function') {
                        await loadProductReturnsSection();
                    } else if (typeof loadScriptOnDemand === 'function') {
                        await loadScriptOnDemand('product-returns-script');
                        if (typeof loadProductReturnsSection === 'function') {
                            await loadProductReturnsSection();
                        }
                    }
                    break;
            }
            
            // ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ø£Ù† Ø§Ù„Ù‚Ø³Ù… ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡
            if (sectionElement) {
                sectionElement.dataset.loaded = 'true';
            }
            
            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù‚Ø³Ù… ${section} Ø¨Ù†Ø¬Ø§Ø­`);
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('DOMContentLoaded', async () => {
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹
            const logoImg = document.querySelector('.sidebar-logo');
            if (logoImg && typeof getCachedDefaultLogo === 'function') {
                try {
                    const logoUrl = await getCachedDefaultLogo();
                    logoImg.src = logoUrl;
                    logoImg.style.display = 'block';
                    logoImg.onerror = function() {
                        console.warn('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ù† Ø§Ù„ÙƒØ§Ø´ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ');
                        logoImg.src = 'vertopal.com_photo_5922357566287580087_y.png';
                    };
                } catch (err) {
                    console.warn('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ù† Ø§Ù„ÙƒØ§Ø´:', err);
                    logoImg.src = 'vertopal.com_photo_5922357566287580087_y.png';
                    logoImg.style.display = 'block';
                }
            } else if (logoImg) {
                // Fallback: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
                logoImg.src = 'vertopal.com_photo_5922357566287580087_y.png';
                logoImg.style.display = 'block';
            }
            
            const user = await performAuthCheck();
            if (!user) {
                return;
            }
            
            displayUserInfo();
            hideByPermission().catch(error => {
                console.error('Ø®Ø·Ø£ ÙÙŠ hideByPermission:', error);
            });
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ù„Ù…ÙˆØ¸Ù
            if (typeof setupPermissionObserver === 'function') {
                setupPermissionObserver();
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ hideByPermission Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ±
            setTimeout(() => {
                hideByPermission().catch(error => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ hideByPermission:', error);
                });
            }, 500);
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ hideByPermission Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            setTimeout(() => {
                hideByPermission().catch(error => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ hideByPermission:', error);
                });
            }, 2000);
            loadDarkMode();
            setupModalCloseOnClickOutside();
            
            // Ø¥Ø¯Ø§Ø±Ø© Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª
            const initInstallButton = () => {
                const installLink = document.getElementById('installLink');
                if (!installLink) return;
                
                if (typeof pwaInstallManager !== 'undefined') {
                    const installInfo = pwaInstallManager.getInstallInfo();
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø²Ø± Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø«Ø¨ØªØ§Ù‹ Ø£Ùˆ Ø¥Ø°Ø§ ÙƒØ§Ù† Chrome Desktop
                    const browser = pwaInstallManager.getBrowser();
                    const isChromeDesktop = browser === 'chrome' && !pwaInstallManager.isAndroid() && !pwaInstallManager.isIOS();
                    
                    if (!installInfo.isInstalled || isChromeDesktop) {
                        installLink.style.display = 'inline-block';
                    }
                } else {
                    // ØªÙ‡ÙŠØ¦Ø© PWA Install Manager
                    if (typeof PWAInstallManager !== 'undefined') {
                        window.pwaInstallManager = new PWAInstallManager();
                        const installInfo = window.pwaInstallManager.getInstallInfo();
                        const browser = window.pwaInstallManager.getBrowser();
                        const isChromeDesktop = browser === 'chrome' && !window.pwaInstallManager.isAndroid() && !window.pwaInstallManager.isIOS();
                        
                        if (!installInfo.isInstalled || isChromeDesktop) {
                            installLink.style.display = 'inline-block';
                        }
                    }
                }
            };
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© ÙÙˆØ±ÙŠØ©
            initInstallButton();
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ PWA Manager
            setTimeout(initInstallButton, 500);
            setTimeout(initInstallButton, 1500);
            
            // ØªØ³Ø¬ÙŠÙ„ Service Worker Ø¨Ø´ÙƒÙ„ ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù† - Ù„Ø§ ÙŠØ¹ÙŠÙ‚ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
            // ğŸ”§ Ø¯Ø§Ù„Ø© Ù„Ø¥Ù„ØºØ§Ø¡ ØªØ³Ø¬ÙŠÙ„ Service Worker
            const unregisterServiceWorker = async () => {
                if ('serviceWorker' in navigator) {
                    try {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        for (let registration of registrations) {
                            const unregistered = await registration.unregister();
                            console.log('ğŸ—‘ï¸ Service Worker unregistered:', unregistered);
                        }
                        // Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ caches
                        const cacheNames = await caches.keys();
                        await Promise.all(
                            cacheNames.map(cacheName => {
                                console.log('ğŸ—‘ï¸ Deleting cache:', cacheName);
                                return caches.delete(cacheName);
                            })
                        );
                        console.log('âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ³Ø¬ÙŠÙ„ Service Worker ÙˆÙ…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ caches');
                        return true;
                    } catch (error) {
                        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ ØªØ³Ø¬ÙŠÙ„ Service Worker:', error);
                        return false;
                    }
                }
                return false;
            };
            
            // Ø¬Ø¹Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù† Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
            window.unregisterServiceWorker = unregisterServiceWorker;
            
            const registerServiceWorker = async () => {
                if ('serviceWorker' in navigator) {
                    try {
                        const appVersion = '2.0.1';
                        
                        // âœ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ - Service Worker Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙÙŠ Ø§Ù„Ø¬Ø°Ø±
                        const getBasePath = () => {
                            try {
                                const pathname = window.location.pathname;
                                // âœ… Ø§Ù„Ø­Ù„: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³Ø§Ø± ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ .htmlØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø°Ø±
                                // Ù„Ø£Ù† Service Worker Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙÙŠ Ø§Ù„Ø¬Ø°Ø± ÙˆÙ„ÙŠØ³ ÙÙŠ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØµÙØ­Ø©
                                if (pathname.includes('.html')) {
                                    return ''; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¬Ø°Ø±
                                }
                                // ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ø«Ù„ /zidan15/ Ù†Ø³ØªØ®Ø¯Ù…Ù‡
                                const match = pathname.match(/^\/([^\/]+)\//);
                                if (match && match[1] && !match[1].includes('.')) {
                                    return '/' + match[1];
                                }
                                return ''; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¬Ø°Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹
                            } catch (e) {
                                return ''; // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø°Ø±
                            }
                        };
                        const basePath = getBasePath();
                        // âœ… Ø¥ØµÙ„Ø§Ø­: scope ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ / Ø¯Ø§Ø¦Ù…Ø§Ù‹
                        const scope = basePath ? `${basePath}/` : '/';
                        
                        // âœ… Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Service Worker URL
                        const verifyServiceWorkerUrl = async (url) => {
                            try {
                                const response = await fetch(url, { 
                                    method: 'HEAD',
                                    cache: 'no-cache'
                                });
                                const contentType = response.headers.get('content-type') || '';
                                
                                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Content-Type
                                if (contentType.includes('text/html') || 
                                    (contentType.includes('application/json') && !response.ok)) {
                                    return false; // Content type ØºÙŠØ± ØµØ­ÙŠØ­
                                }
                                
                                if (!response.ok) {
                                    return false; // Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ÙˆØµÙˆÙ„
                                }
                                
                                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Content-Type ØµØ­ÙŠØ­
                                return contentType.includes('application/javascript') || 
                                       contentType.includes('text/javascript') ||
                                       contentType.includes('javascript');
                            } catch (error) {
                                return false; // ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚
                            }
                        };
                        
                        // âœ… Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… sw.js.php Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… sw.js ÙƒØ¨Ø¯ÙŠÙ„
                        let swUrl = basePath ? `${basePath}/sw.js.php` : '/sw.js.php';
                        let useFallback = false;
                        
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† sw.js.php
                        const isValidPhp = await verifyServiceWorkerUrl(swUrl);
                        if (!isValidPhp) {
                            console.warn('âš ï¸ sw.js.php returns wrong content type, trying sw.js as fallback...');
                            // Ø§Ø³ØªØ®Ø¯Ø§Ù… sw.js Ù…Ø¨Ø§Ø´Ø±Ø© ÙƒØ¨Ø¯ÙŠÙ„
                            swUrl = basePath ? `${basePath}/sw.js` : '/sw.js';
                            useFallback = true;
                            
                            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† sw.js Ø£ÙŠØ¶Ø§Ù‹
                            const isValidJs = await verifyServiceWorkerUrl(swUrl);
                            if (!isValidJs) {
                                console.error('âŒ Both sw.js.php and sw.js failed - Service Worker cannot be registered');
                                console.error('   Check server configuration and ensure .htaccess is correct');
                                return; // ÙØ´Ù„ ÙƒÙ„Ø§ Ø§Ù„Ù…Ù„ÙÙŠÙ†
                            }
                        }
                        
                        if (useFallback) {
                            console.log('âœ… Using sw.js directly (fallback)');
                        } else {
                            console.log('âœ… Using sw.js.php');
                        }
                        
                        const registration = await navigator.serviceWorker.register(swUrl, {
                            scope: scope,
                            updateViaCache: 'none'
                        });
                        
                        console.log('âœ… Service Worker registered:', registration);
                        console.log('   - Scope:', registration.scope);
                        console.log('   - Active:', registration.active ? 'Yes' : 'Waiting');
                        
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            if (newWorker) {
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        console.log('ğŸ”„ New Service Worker available. Reload to update.');
                                    }
                                });
                            }
                        });
                        
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
                        // Ø«Ù… Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ø¥ØµØ¯Ø§Ø±
                        const checkForUpdates = async () => {
                            try {
                                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£ÙˆÙ„Ø§Ù‹
                                if (!navigator.onLine) {
                                    console.log('[Update] Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ - Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ø§Ø­Ù‚Ø§Ù‹');
                                    return;
                                }
                                
                                console.log('ğŸ”„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª...');
                                
                                // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ø¯ÙŠØ« Service Worker Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙØ¶Ù„ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡
                                try {
                                    await registration.update();
                                } catch (updateError) {
                                    // ØªØ¬Ø§Ù‡Ù„ Ø®Ø·Ø£ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¨Ø³Ø¨Ø¨ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø´Ø¨ÙƒØ©
                                    if (updateError.message && (
                                        updateError.message.includes('Failed to fetch') ||
                                        updateError.message.includes('NetworkError') ||
                                        updateError.message.includes('network')
                                    )) {
                                        console.log('[Update] Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ø§Ø­Ù‚Ø§Ù‹');
                                        return;
                                    }
                                    // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ù…ÙŠ Ø§Ù„Ø®Ø·Ø£ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø®Ø·Ø£ Ø¢Ø®Ø±
                                    throw updateError;
                                }
                                
                                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Service Worker Ù…Ø­Ø¯Ø«
                                if (registration.waiting) {
                                    console.log('ğŸ”„ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Service Worker Ù…Ø­Ø¯Ø« - Ø³ÙŠØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„');
                                    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù€ Service Worker Ù„ØªØ®Ø·ÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                                    registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                                }
                                
                                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„ÙØ§Øª Ù†ÙØ³Ù‡Ø§
                                if (typeof window.checkForUpdates === 'function') {
                                    try {
                                        const hasUpdate = await window.checkForUpdates();
                                        if (hasUpdate) {
                                            console.log('ğŸ”„ ØªÙ… Ø§ÙƒØªØ´Ø§Ù ØªØ­Ø¯ÙŠØ« Ù„Ù„Ù…Ù„ÙØ§Øª - Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„...');
                                            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
                                            setTimeout(() => {
                                                window.location.reload();
                                            }, 2000);
                                        }
                                    } catch (versionError) {
                                        // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥ØµØ¯Ø§Ø±
                                        console.log('[Update] Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥ØµØ¯Ø§Ø±:', versionError.message);
                                    }
                                }
                            } catch (error) {
                                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙØ¶Ù„ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ - Ø¹Ø¯Ù… Ø¹Ø±Ø¶ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø´Ø¨ÙƒØ© ÙƒØ£Ø®Ø·Ø§Ø¡ Ø­Ø±Ø¬Ø©
                                if (error.message && (
                                    error.message.includes('Failed to fetch') ||
                                    error.message.includes('NetworkError') ||
                                    error.message.includes('network') ||
                                    !navigator.onLine
                                )) {
                                    console.log('[Update] Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ - Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ø§Ø­Ù‚Ø§Ù‹');
                                } else {
                                    console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª:', error.message || error);
                                }
                            }
                        };
                        
                        // Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙˆØ±Ø§Ù‹
                        setTimeout(checkForUpdates, 1000);
                        
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
                        setInterval(checkForUpdates, 30000); // ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
                    } catch (error) {
                        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙØ¶Ù„ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡
                        if (error.message && error.message.includes('MIME type')) {
                            console.error('âŒ Service Worker registration failed: Server returned wrong MIME type (HTML instead of JavaScript)');
                            console.error('   This usually means:');
                            console.error('   1. The sw.js file does not exist on the server');
                            console.error('   2. The server is redirecting 404 errors to index.html');
                            console.error('   3. Server MIME type configuration is incorrect');
                            console.error('   Solution: Check .htaccess file and ensure sw.js is accessible');
                        } else {
                            console.warn('âš ï¸ Service Worker registration failed:', error.message || error);
                        }
                    }
                }
            };
            
            // ØªØ³Ø¬ÙŠÙ„ Service Worker Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
            if (window.requestIdleCallback) {
                window.requestIdleCallback(registerServiceWorker, { timeout: 5000 });
            } else {
                setTimeout(registerServiceWorker, 2000);
            }
            
            // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© - Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù€ sessionStorage (Ù„Ù„Ù€ refresh)
            let savedSection = restoreCurrentPage();
            
            // âœ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const currentUserStr = localStorage.getItem('currentUser');
            const currentUser = currentUserStr ? JSON.parse(currentUserStr) : null;
            const isEmployee = currentUser && currentUser.role === 'employee';
            const isManager = currentUser && currentUser.role === 'manager';
            const isAdmin = currentUser && currentUser.role === 'admin';
            const isTechnician = currentUser && currentUser.role === 'technician';
            
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù‚Ø³Ù… Ù…Ø­ÙÙˆØ¸ Ø£Ùˆ ÙƒØ§Ù† Ù…Ø­Ø¸ÙˆØ±Ø§Ù‹ØŒ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            if (!savedSection) {
                if (isAdmin) {
                    savedSection = 'dashboard';
                } else if (isManager || isTechnician) {
                    savedSection = 'repairs';
                } else if (isEmployee) {
                    savedSection = 'profile';
                } else {
                    savedSection = 'repairs'; // Ø§ÙØªØ±Ø§Ø¶ÙŠ
                }
                saveCurrentPage(savedSection);
            } else {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ù…Ø³Ù…ÙˆØ­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                if (isEmployee) {
                    // Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© Ù„Ù„Ù…ÙˆØ¸Ù: repairs, inventory, profile, product-returns
                    const forbiddenSections = ['dashboard', 'customers', 'expenses', 'reports', 'settings'];
                    if (forbiddenSections.includes(savedSection)) {
                        savedSection = 'profile';
                        saveCurrentPage('profile');
                    }
                } else if (isManager || isTechnician) {
                    // Ù…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ dashboard Ùˆ settings Ù„Ù„Ù…Ø¯ÙŠØ± ÙˆØ§Ù„ÙÙ†ÙŠ
                    if (savedSection === 'dashboard' || savedSection === 'settings') {
                        savedSection = 'repairs';
                        saveCurrentPage('repairs');
                    }
                } else if (!isAdmin && (savedSection === 'dashboard' || savedSection === 'settings')) {
                    // Ù…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ dashboard Ùˆ settings Ù„Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± admin
                    savedSection = 'repairs';
                    saveCurrentPage('repairs');
                }
            }
            
            currentSection = savedSection;
            
            // ğŸ”§ Ø§Ù„Ø­Ù„: Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ sessionStorage Ù„Ù„Ù€ refresh
            sessionStorage.setItem(PAGE_SESSION_KEY, savedSection);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø­Ø³Ø¨ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
            const titles = {
                'dashboard': 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…',
                'repairs': 'Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©',
                'customers': 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡',
                'inventory': 'Ø§Ù„Ù…Ø®Ø²Ù†',
                'expenses': 'Ø®Ø²Ù†Ø© Ø§Ù„ÙØ±Ø¹',
                'reports': 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©',
                'settings': 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'
            };
            
            const icons = {
                'dashboard': 'bi-speedometer2',
                'repairs': 'bi-tools',
                'customers': 'bi-people',
                'inventory': 'bi-box-seam',
                'expenses': 'bi-cash-stack',
                'reports': 'bi-graph-up',
                'settings': 'bi-gear',
                'profile': 'bi-person-circle'
            };
            
            if (titles[savedSection]) {
                const pageTitle = document.getElementById('pageTitle');
                const iconClass = icons[savedSection] || 'bi-speedometer2';
                pageTitle.innerHTML = `<i class="bi ${iconClass}"></i> ${titles[savedSection]}`;
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø­Ø³Ø¨ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('onclick') && link.getAttribute('onclick').includes(`'${savedSection}'`)) {
                    link.classList.add('active');
                }
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ navbar Ø§Ù„Ø¹Ø§Ø¦Ù…
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('onclick') && item.getAttribute('onclick').includes(`'${savedSection}'`)) {
                    item.classList.add('active');
                }
            });
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø´ÙƒÙ„ Ù‚ÙˆÙŠ
            document.querySelectorAll('.section').forEach(sec => {
                sec.classList.remove('active');
                sec.style.display = 'none';
            });
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© Ù„Ù„Ù…Ø®Ø²Ù†
            document.querySelectorAll('.inventory-section').forEach(sec => {
                sec.classList.remove('active');
                sec.style.display = 'none';
            });
            
            // âœ… Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸ (ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
            const sectionToShow = savedSection;
            const sectionElement = document.getElementById(sectionToShow + '-section');
            if (sectionElement) {
                sectionElement.classList.add('active');
                sectionElement.style.display = 'block';
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰
                document.querySelectorAll('.section').forEach(sec => {
                    if (sec !== sectionElement) {
                        sec.classList.remove('active');
                        sec.style.display = 'none';
                    }
                });
                
                // Ø¹Ù†Ø¯ Ø¹Ø±Ø¶ dashboardØŒ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙˆØ§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„
                if (sectionToShow === 'dashboard') {
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… setTimeout Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† DOM Ø¬Ø§Ù‡Ø²
                    setTimeout(() => {
                        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
                        const branchTabs = sectionElement.querySelector('.branch-tabs');
                        console.log('ğŸ” [Dashboard Init] Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹:', branchTabs);
                        if (branchTabs) {
                            branchTabs.style.display = 'flex';
                            branchTabs.style.visibility = 'visible';
                            branchTabs.style.opacity = '1';
                            console.log('âœ… [Dashboard Init] ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹');
                        } else {
                            console.warn('âš ï¸ [Dashboard Init] Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹');
                        }
                        
                        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„ Ù†Ø´Ø·
                        const firstBranch = sectionElement.querySelector('.dashboard-branch[data-branch="1"]');
                        const secondBranch = sectionElement.querySelector('.dashboard-branch[data-branch="2"]');
                        if (firstBranch) {
                            if (!firstBranch.classList.contains('active')) {
                                firstBranch.classList.add('active');
                            }
                            firstBranch.style.display = 'block';
                            console.log('âœ… [Dashboard Init] ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„');
                        }
                        if (secondBranch) {
                            if (secondBranch.classList.contains('active')) {
                                secondBranch.classList.remove('active');
                            }
                            secondBranch.style.display = 'none';
                        }
                        
                        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„ Ù†Ø´Ø·
                        const firstTab = sectionElement.querySelector('.branch-tab:nth-child(1)');
                        const secondTab = sectionElement.querySelector('.branch-tab:nth-child(2)');
                        if (firstTab && !firstTab.classList.contains('active')) {
                            firstTab.classList.add('active');
                            console.log('âœ… [Dashboard Init] ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„');
                        }
                        if (secondTab && secondTab.classList.contains('active')) {
                            secondTab.classList.remove('active');
                        }
                    }, 50);
                }
            } else if (sectionToShow === 'dashboard') {
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø±Ø¶ dashboard-section Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
                const dashboardSection = document.getElementById('dashboard-section');
                if (dashboardSection) {
                    dashboardSection.classList.add('active');
                    dashboardSection.style.display = 'block';
                    
                    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
                    const branchTabs = dashboardSection.querySelector('.branch-tabs');
                    if (branchTabs) {
                        branchTabs.style.display = 'flex';
                    }
                }
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù„Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
            if (sectionToShow === 'dashboard' && !isEmployee) {
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„ Ù†Ø´Ø· Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ dashboard
                setTimeout(() => {
                    const firstBranch = document.querySelector('.dashboard-branch[data-branch="1"]');
                    const secondBranch = document.querySelector('.dashboard-branch[data-branch="2"]');
                    const firstTab = document.querySelector('.branch-tab:nth-child(1)');
                    const secondTab = document.querySelector('.branch-tab:nth-child(2)');
                    
                    if (firstBranch && !firstBranch.classList.contains('active')) {
                        firstBranch.classList.add('active');
                    }
                    if (secondBranch && secondBranch.classList.contains('active')) {
                        secondBranch.classList.remove('active');
                    }
                    if (firstTab && !firstTab.classList.contains('active')) {
                        firstTab.classList.add('active');
                    }
                    if (secondTab && secondTab.classList.contains('active')) {
                        secondTab.classList.remove('active');
                    }
                }, 100);
                
                await loadDashboardData();
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
                setTimeout(async () => {
                    const syncIndicator = document.getElementById('syncIndicator');
                    if (syncIndicator && syncIndicator.style.color === 'var(--danger-color)') {
                        console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…...');
                        await loadDashboardData();
                    }
                }, 3000);
            } else {
                // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
                await updateSectionData(sectionToShow, true);
            }
            
            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
            try {
                if (typeof initializeAutoBackup === 'function') {
                    await initializeAutoBackup();
                }
            } catch (e) {
                console.warn('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ:', e);
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù† Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙØ¶Ù„ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡
            const loadSectionSafely = async (sectionName, loadFunction) => {
                try {
                    // Ù„Ù„Ù‚Ø³Ù… settings Ùˆ profile Ùˆ expenses Ùˆ reportsØŒ Ù†Ø­ØªØ§Ø¬ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ script Ø£ÙˆÙ„Ø§Ù‹
                    if (sectionName === 'settings' && typeof loadFunction !== 'function') {
                        await loadScriptOnDemand('settings-script');
                        // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ script
                        if (typeof loadSettingsSection === 'function') {
                            await loadSettingsSection();
                            // âœ… ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ø£Ù† Ø§Ù„Ù‚Ø³Ù… ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡
                            const sectionElement = document.getElementById(`${sectionName}-section`);
                            if (sectionElement) {
                                sectionElement.dataset.loaded = 'true';
                            }
                        } else {
                            console.warn(`Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ ${sectionName} ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ script`);
                        }
                    } else if (sectionName === 'profile' && typeof loadFunction !== 'function') {
                        await loadScriptOnDemand('profile-script');
                        // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ script
                        if (typeof loadProfileSection === 'function') {
                            await loadProfileSection();
                        } else {
                            console.warn(`Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ ${sectionName} ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ script`);
                        }
                    } else if (sectionName === 'expenses' && typeof loadFunction !== 'function') {
                        // ğŸ”§ Ø§Ù„Ø­Ù„: ØªØ­Ù…ÙŠÙ„ expenses.js Ù‚Ø¨Ù„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ loadExpensesSection
                        await loadScriptOnDemand('expenses-script');
                        // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ script
                        if (typeof loadExpensesSection === 'function') {
                            await loadExpensesSection();
                        } else {
                            console.warn(`Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ ${sectionName} ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ script`);
                        }
                    } else if (sectionName === 'reports' && typeof loadFunction !== 'function') {
                        // ğŸ”§ Ø§Ù„Ø­Ù„: ØªØ­Ù…ÙŠÙ„ reports.js Ù‚Ø¨Ù„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ loadReportsSection
                        try {
                            await loadScriptOnDemand('reports-script');
                            // Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø©
                            let attempts = 0;
                            const maxAttempts = 15;
                            while (attempts < maxAttempts && typeof loadReportsSection !== 'function') {
                                await new Promise(resolve => setTimeout(resolve, 100));
                                attempts++;
                            }
                            // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ script
                            if (typeof loadReportsSection === 'function') {
                                await loadReportsSection();
                            } else {
                                console.warn(`Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ ${sectionName} ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø¨Ø¹Ø¯ ${maxAttempts} Ù…Ø­Ø§ÙˆÙ„Ø©`);
                            }
                        } catch (e) {
                            // Ù‚Ø¯ ÙŠÙƒÙˆÙ† ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ù„Ù„Ù…ÙˆØ¸Ù Ø£Ùˆ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                            console.warn(`ØºÙŠØ± Ù…ØªØ§Ø­ ØªØ­Ù…ÙŠÙ„ ${sectionName}:`, e.message);
                        }
                    } else if (sectionName === 'inventory' && typeof loadFunction !== 'function') {
                        // ğŸ”§ Ø§Ù„Ø­Ù„: inventory.js Ù‡Ùˆ critical scriptØŒ Ù„ÙƒÙ† Ù‚Ø¯ Ù„Ø§ ÙŠÙƒÙˆÙ† Ø¬Ø§Ù‡Ø²Ø§Ù‹ Ø¨Ø¹Ø¯
                        // Ù†Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø«Ù… Ù†ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¯Ø§Ù„Ø©
                        let attempts = 0;
                        const maxAttempts = 20;
                        while (attempts < maxAttempts && typeof loadInventorySection !== 'function') {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            attempts++;
                        }
                        // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ script
                        if (typeof loadInventorySection === 'function') {
                            await loadInventorySection();
                        } else {
                            console.warn(`Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ ${sectionName} ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø¨Ø¹Ø¯ ${maxAttempts} Ù…Ø­Ø§ÙˆÙ„Ø©`);
                        }
                    } else if (typeof loadFunction === 'function') {
                        await loadFunction();
                    } else {
                        // âœ… ØªØ­Ø³ÙŠÙ†: ØªØ­Ø°ÙŠØ± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‚Ø³Ù… Ù†Ø´Ø·Ø§Ù‹ Ø£Ùˆ Ù…Ø·Ù„ÙˆØ¨Ø§Ù‹
                        // Ù„Ø§ Ù†Ø¹Ø±Ø¶ ØªØ­Ø°ÙŠØ± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‚Ø³Ù… ØºÙŠØ± Ù…Ø­Ù…Ù‘Ù„ Ø¨Ø¹Ø¯ (Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©)
                        const sectionElement = document.getElementById(`${sectionName}-section`);
                        if (sectionElement && sectionElement.classList.contains('active')) {
                            console.warn(`âš ï¸ Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ ${sectionName} ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© - Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©`);
                        }
                    }
                    
                    // âœ… ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ø£Ù† Ø§Ù„Ù‚Ø³Ù… ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ù†Ø¬Ø§Ø­
                    const sectionElement = document.getElementById(`${sectionName}-section`);
                    if (sectionElement) {
                        sectionElement.dataset.loaded = 'true';
                    }
                } catch (e) {
                    console.error(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø³Ù… ${sectionName}:`, e);
                    // Ù„Ø§ Ù†ÙˆÙ‚Ù Ø§Ù„ØªÙ†ÙÙŠØ°ØŒ ÙÙ‚Ø· Ù†Ø³Ø¬Ù„ Ø§Ù„Ø®Ø·Ø£
                }
            };
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ø´ÙƒÙ„ Ù…ØªÙˆØ§Ø²ÙŠ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
            // Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ø¹ÙˆØ¯ Ù…Ù† pos.html Ø£Ùˆ chat.htmlØŒ Ù†Ø¶ÙŠÙ ØªØ£Ø®ÙŠØ± Ø¥Ø¶Ø§ÙÙŠ Ù‚Ø¨Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            if (isReturningFromPOS || isReturningFromChat) {
                console.log('â³ Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ scripts Ù‚Ø¨Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…...');
                await new Promise(resolve => setTimeout(resolve, 600));
            }
            
            // âœ… ØªØ­Ø³ÙŠÙ†: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ scripts Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù„
            const loadScriptsFirst = async () => {
                const scriptsToLoad = [
                    { name: 'repairs', script: 'js/repairs.js', func: 'loadRepairsSection' },
                    { name: 'customers', script: 'js/customers.js', func: 'loadCustomersSection' },
                    { name: 'inventory', script: 'js/inventory.js', func: 'loadInventorySection' },
                    { name: 'expenses', script: 'js/expenses.js', func: 'loadExpensesSection' },
                    { name: 'reports', script: 'js/reports.js', func: 'loadReportsSection' },
                    { name: 'settings', script: 'js/settings.js', func: 'loadSettingsSection' }
                ];
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ scripts Ø¨Ø´ÙƒÙ„ Ù…ØªÙˆØ§Ø²ÙŠ
                await Promise.allSettled(
                    scriptsToLoad.map(async ({ name, script, func }) => {
                        try {
                            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù€ script ØºÙŠØ± Ù…Ø­Ù…Ù‘Ù„ Ø¨Ø§Ù„ÙØ¹Ù„
                            if (typeof window[func] === 'function') {
                                return; // Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„
                            }
                            
                            // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ script
                            if (typeof loadCriticalScript === 'function') {
                                await loadCriticalScript(script).catch(() => {});
                            }
                        } catch (e) {
                            // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ - Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ script Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
                        }
                    })
                );
            };
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ scripts Ø£ÙˆÙ„Ø§Ù‹
            await loadScriptsFirst();
            
            // âœ… ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù†Ø´Ø· ÙÙ‚Ø· Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            // savedSection ØªÙ… ØªØ¹Ø±ÙŠÙÙ‡ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø³Ø·Ø± 1982
            console.log('ğŸ“¦ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù†Ø´Ø· ÙÙ‚Ø·:', savedSection);
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù†Ø´Ø· ÙÙ‚Ø·
            if (savedSection && savedSection !== 'dashboard') {
                await loadSectionSafely(savedSection, getLoadFunction(savedSection));
            }
            
            // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
            function getLoadFunction(section) {
                const loadFunctions = {
                    'repairs': typeof loadRepairsSection !== 'undefined' ? loadRepairsSection : undefined,
                    'customers': typeof loadCustomersSection !== 'undefined' ? loadCustomersSection : undefined,
                    'inventory': typeof loadInventorySection !== 'undefined' ? loadInventorySection : undefined,
                    'expenses': typeof loadExpensesSection !== 'undefined' ? loadExpensesSection : undefined,
                    'reports': typeof loadReportsSection !== 'undefined' ? loadReportsSection : undefined,
                    'settings': typeof loadSettingsSection !== 'undefined' ? loadSettingsSection : undefined,
                    'product-returns': typeof loadProductReturnsSection !== 'undefined' ? loadProductReturnsSection : undefined
                };
                return loadFunctions[section];
            }
            
            // Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ø¹ÙˆØ¯ Ù…Ù† pos.html Ø£Ùˆ chat.htmlØŒ Ù†Ø¶ÙŠÙ ØªØ£Ø®ÙŠØ± Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            if (isReturningFromPOS || isReturningFromChat) {
                console.log('â³ Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…...');
                await new Promise(resolve => setTimeout(resolve, 400));
            }
            
            // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            const waitForFunction = (funcName, maxAttempts = 20, delay = 100) => {
                return new Promise((resolve, reject) => {
                    let attempts = 0;
                    const checkFunction = () => {
                        attempts++;
                        if (typeof window[funcName] === 'function') {
                            console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø§Ù„Ø© ${funcName} Ø¨Ø¹Ø¯ ${attempts} Ù…Ø­Ø§ÙˆÙ„Ø©`);
                            resolve();
                        } else if (attempts >= maxAttempts) {
                            console.warn(`âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø§Ù„Ø© ${funcName} Ø¨Ø¹Ø¯ ${maxAttempts} Ù…Ø­Ø§ÙˆÙ„Ø©`);
                            reject(new Error(`Function ${funcName} not found`));
                        } else {
                            setTimeout(checkFunction, delay);
                        }
                    };
                    checkFunction();
                });
            };
            
            // Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            setTimeout(async () => {
                try {
                    // Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ø¹ÙˆØ¯ Ù…Ù† pos.html Ø£Ùˆ chat.htmlØŒ Ù†Ø¶ÙŠÙ ØªØ£Ø®ÙŠØ± Ø¥Ø¶Ø§ÙÙŠ ÙˆÙ†ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù„
                    if (isReturningFromPOS || isReturningFromChat) {
                        console.log('ğŸ”„ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù† POS/Chat - Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ§Ù„...');
                        
                        // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
                        const requiredFunctions = {
                            'repairs': 'loadRepairsSection',
                            'customers': 'loadCustomersSection',
                            'inventory': 'loadInventorySection',
                            'expenses': 'loadExpensesSection',
                            'reports': 'loadReportsSection'
                        };
                        
                        const requiredFunc = requiredFunctions[sectionToShow];
                        if (requiredFunc) {
                            try {
                                await waitForFunction(requiredFunc, 30, 150);
                            } catch (e) {
                                console.warn(`âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ ${requiredFunc}ØŒ Ø³ÙŠØªÙ… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙˆÙ†Ù‡Ø§`);
                            }
                        }
                        
                        // ØªØ£Ø®ÙŠØ± Ø¥Ø¶Ø§ÙÙŠ Ù„Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ DOM
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    
                    // Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø³Ù…
                    showSection(sectionToShow, true); // true = Ø¨Ø¯ÙˆÙ† Ø­ÙØ¸ (Ù„Ø£Ù†Ù†Ø§ Ø§Ø³ØªØ¹Ø¯Ù†Ø§Ù‡Ø§)
                    
                    // âœ… ØªØ­Ø³ÙŠÙ†: Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù† pos.html Ø£Ùˆ chat.html - Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
                    if (isReturningFromPOS || isReturningFromChat) {
                        console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù† POS/Chat...');
                        
                        // ØªØ£Ø®ÙŠØ± Ø¥Ø¶Ø§ÙÙŠ Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·)
                        setTimeout(() => {
                            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‚Ø³Ù… dashboardØŒ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù‚Ø¨Ù„ updateSectionData
                            if (sectionToShow === 'dashboard') {
                                // âœ… Ø¥ØµÙ„Ø§Ø­: Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙÙˆØ±Ø§Ù‹ Ø¨Ø¯ÙˆÙ† ØªØ£Ø®ÙŠØ± Ø¥Ø¶Ø§ÙÙŠ
                                const dashboardSectionEl = document.getElementById('dashboard-section');
                                if (dashboardSectionEl) {
                                    const branchTabs = dashboardSectionEl.querySelector('.branch-tabs');
                                    if (branchTabs) {
                                        branchTabs.style.display = 'flex';
                                        branchTabs.style.visibility = 'visible';
                                        branchTabs.style.opacity = '1';
                                        console.log('âœ… [Returning from POS] ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹ ÙÙˆØ±Ø§Ù‹');
                                    }
                                    
                                    const firstBranch = dashboardSectionEl.querySelector('.dashboard-branch[data-branch="1"]');
                                    const secondBranch = dashboardSectionEl.querySelector('.dashboard-branch[data-branch="2"]');
                                    if (firstBranch) {
                                        if (!firstBranch.classList.contains('active')) {
                                            firstBranch.classList.add('active');
                                        }
                                        firstBranch.style.display = 'block';
                                    }
                                    if (secondBranch) {
                                        if (secondBranch.classList.contains('active')) {
                                            secondBranch.classList.remove('active');
                                        }
                                        secondBranch.style.display = 'none';
                                    }
                                    
                                    const firstTab = dashboardSectionEl.querySelector('.branch-tab:nth-child(1)');
                                    const secondTab = dashboardSectionEl.querySelector('.branch-tab:nth-child(2)');
                                    if (firstTab && !firstTab.classList.contains('active')) {
                                        firstTab.classList.add('active');
                                    }
                                    if (secondTab && secondTab.classList.contains('active')) {
                                        secondTab.classList.remove('active');
                                    }
                                }
                                
                                // âœ… Ø¥ØµÙ„Ø§Ø­: ÙƒÙˆØ¯ Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„Ù„ØªØ£ÙƒØ¯
                                setTimeout(() => {
                                    const dashboardSectionEl = document.getElementById('dashboard-section');
                                    if (dashboardSectionEl) {
                                        const branchTabs = dashboardSectionEl.querySelector('.branch-tabs');
                                        if (branchTabs) {
                                            branchTabs.style.display = 'flex';
                                            branchTabs.style.visibility = 'visible';
                                            branchTabs.style.opacity = '1';
                                            console.log('âœ… [Returning from POS] ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹ (ÙØ­Øµ Ø§Ø­ØªÙŠØ§Ø·ÙŠ)');
                                        }
                                        
                                        const firstBranch = dashboardSectionEl.querySelector('.dashboard-branch[data-branch="1"]');
                                        const secondBranch = dashboardSectionEl.querySelector('.dashboard-branch[data-branch="2"]');
                                        if (firstBranch) {
                                            firstBranch.style.display = 'block';
                                            if (!firstBranch.classList.contains('active')) {
                                                firstBranch.classList.add('active');
                                            }
                                        }
                                        if (secondBranch) {
                                            secondBranch.style.display = 'none';
                                            if (secondBranch.classList.contains('active')) {
                                                secondBranch.classList.remove('active');
                                            }
                                        }
                                        
                                        const firstTab = dashboardSectionEl.querySelector('.branch-tab:nth-child(1)');
                                        const secondTab = dashboardSectionEl.querySelector('.branch-tab:nth-child(2)');
                                        if (firstTab && !firstTab.classList.contains('active')) {
                                            firstTab.classList.add('active');
                                        }
                                        if (secondTab && secondTab.classList.contains('active')) {
                                            secondTab.classList.remove('active');
                                        }
                                    }
                                    
                                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
                                    updateSectionData(sectionToShow, false); // false = Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ÙƒØ§Ù…Ù„Ø©
                                }, 150); // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„Ù„ØªØ£ÙƒØ¯
                            } else {
                                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† dashboardØŒ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
                                updateSectionData(sectionToShow, false);
                            }
                            
                            // âœ… Ø¥Ø²Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙØ§Ø±ØºØ§Ù‹ØŒ Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù‚Ø³Ù…
                        }, 300); // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªØ£Ø®ÙŠØ± Ù…Ù† 500 Ø¥Ù„Ù‰ 300
                    }
                } catch (e) {
                    console.error('Error showing section:', e);
                    // Ø¥Ø°Ø§ ÙØ´Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø³Ù…ØŒ Ø¹Ø±Ø¶ dashboard ÙƒØ¨Ø¯ÙŠÙ„
                    const dashboardSection = document.getElementById('dashboard-section');
                    if (dashboardSection) {
                        dashboardSection.classList.add('active');
                    }
                }
            }, (isReturningFromPOS || isReturningFromChat) ? 800 : 200);
            
            // ğŸ”§ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡: ØªØ£Ø¬ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø­ØªÙ‰ Ø¨Ø¹Ø¯ 30 Ø«Ø§Ù†ÙŠØ© Ø£Ùˆ Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø£ÙˆÙ„
            let syncManagerInitialized = false; // Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
            const initSyncManager = () => {
                if (syncManagerInitialized) return true;
                if (typeof syncManager !== 'undefined' && !syncManager.isInitialized) {
                    console.log('[Dashboard] Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© (Ù…ØªØ£Ø®Ø±)');
                    syncManager.startAutoSync();
                    syncManagerInitialized = true;
                    return true;
                }
                return false;
            };
            
            // ğŸ”§ ØªØ£Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: Ø¥Ù…Ø§ Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø£ÙˆÙ„ Ø£Ùˆ Ø¨Ø¹Ø¯ 30 Ø«Ø§Ù†ÙŠØ©
            let userInteracted = false;
            const triggerSyncOnInteraction = () => {
                if (!userInteracted) {
                    userInteracted = true;
                    // ØªØ£Ø®ÙŠØ± Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„
                    setTimeout(() => {
                        initSyncManager();
                    }, 5000); // ØªØ£Ø®ÙŠØ± 5 Ø«ÙˆØ§Ù†ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„
                }
            };
            
            ['click', 'touchstart', 'keydown'].forEach(event => {
                document.addEventListener(event, triggerSyncOnInteraction, { once: true, passive: true });
            });
            
            // ØªØ£Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø­ØªÙ‰ Ø¨Ø¹Ø¯ 30 Ø«Ø§Ù†ÙŠØ© ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
            setTimeout(() => {
                if (!syncManagerInitialized) {
                    initSyncManager();
                }
            }, 30000); // 30 Ø«Ø§Ù†ÙŠØ©
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© ÙÙˆØ±ÙŠØ©
            if (!initSyncManager()) {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ 1 Ø«Ø§Ù†ÙŠØ©
                setTimeout(() => {
                    if (!initSyncManager()) {
                        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ 2 Ø«Ø§Ù†ÙŠØ©
                        setTimeout(() => {
                            if (!initSyncManager()) {
                                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
                                setTimeout(() => {
                                    if (!initSyncManager()) {
                                        console.warn('[Dashboard] ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ syncManager Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª');
                                        // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹
                                        const syncIndicator = document.getElementById('syncIndicator');
                                        if (syncIndicator) {
                                            syncIndicator.innerHTML = '<i class="bi bi-wifi-off"></i> ØºÙŠØ± Ù…ØªØµÙ„';
                                            syncIndicator.style.color = '#FFA500';
                                        }
                                    }
                                }, 3000);
                            }
                        }, 2000);
                    }
                }, 1000);
            }
            
            // Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ - Ø¯Ø§Ø®Ù„ IIFE Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ syncManagerInitialized
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¹Ù†Ø¯ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
                    if (typeof syncManager !== 'undefined' && syncManager.isInitialized) {
                        console.log('[Dashboard] Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© - Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù…Ø®ÙÙŠ');
                        syncManager.stopAutoSync();
                    }
                } else {
                    // ğŸ”§ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡: Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙØ¹Ù„Ø© (ØªØ£Ø®ÙŠØ± Ø­ØªÙ‰ Ø§Ù„ØªÙØ§Ø¹Ù„)
                    if (typeof syncManager !== 'undefined' && !syncManager.isInitialized && !syncManagerInitialized) {
                        // ØªØ£Ø®ÙŠØ± Ø­ØªÙ‰ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø£Ùˆ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
                        setTimeout(() => {
                            initSyncManager();
                        }, 5000);
                    }
                }
            });
        });

        // Ø¥Ø¯Ø§Ø±Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ - Ø§Ø³ØªØ®Ø¯Ø§Ù… pagehide Ù„ØªØ­Ø³ÙŠÙ† bfcache
        const handlePageUnload = () => {
            // Ø¥ÙŠÙ‚Ø§Ù Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
            if (typeof syncManager !== 'undefined' && syncManager.isInitialized) {
                console.log('[Dashboard] Ø¥ÙŠÙ‚Ø§Ù Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù‚Ø¨Ù„ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ¨ÙˆÙŠØ¨');
                syncManager.stopAutoSync();
            }
            
            // Ø¥ÙŠÙ‚Ø§Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
            if (typeof window.currentCameraStream !== 'undefined' && window.currentCameraStream) {
                window.currentCameraStream.getTracks().forEach(track => track.stop());
                window.currentCameraStream = null;
            }
            
            // Ø¥ÙŠÙ‚Ø§Ù Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØªÙˆØ­Ø§Ù‹
            if (typeof Quagga !== 'undefined') {
                try {
                    Quagga.stop();
                    Quagga.offDetected();
                } catch (e) {
                    console.log('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„');
                }
            }
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
            if (typeof allRepairs !== 'undefined') allRepairs = [];
            if (typeof allCustomers !== 'undefined') allCustomers = [];
            if (typeof allInventory !== 'undefined') allInventory = [];
            if (typeof allExpenses !== 'undefined') allExpenses = [];
            
            // Ø¥Ø²Ø§Ù„Ø© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            window.removeEventListener('online', () => {});
            window.removeEventListener('offline', () => {});
            window.removeEventListener('resize', () => {});
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¸ÙŠÙ Ø¥Ù„Ù‰ Service Worker
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'CLEANUP'
                });
            }
            
            console.log('[Dashboard] ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ù‚Ø¨Ù„ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ¨ÙˆÙŠØ¨');
        };
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… pagehide Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† beforeunload Ù„ØªØ­Ø³ÙŠÙ† bfcache
        window.addEventListener('pagehide', handlePageUnload);
        
        // Fallback Ù„Ù€ beforeunload ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
        window.addEventListener('beforeunload', (event) => {
            // ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©
            if (typeof hasUnsavedChanges !== 'undefined' && hasUnsavedChanges()) {
                event.preventDefault();
                event.returnValue = '';
                return '';
            }
        });

        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            sidebar.classList.toggle('show');
        }

        // âœ… Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±: Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ø¢Ø®Ø± updateSectionData
        let lastUpdateSection = null;
        let lastUpdateTime = 0;
        const UPDATE_SECTION_DEBOUNCE = 500; // 500ms Ø¨ÙŠÙ† Ø§Ù„Ø·Ù„Ø¨Ø§Øª

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
        async function updateSectionData(section, forceReload = false) {
            try {
                // âœ… Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±: Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†ÙØ³ Ø§Ù„Ù‚Ø³Ù… ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ù…Ø¤Ø®Ø±Ø§Ù‹ØŒ ØªØ®Ø·ÙŠÙ‡
                const now = Date.now();
                if (!forceReload && lastUpdateSection === section && (now - lastUpdateTime) < UPDATE_SECTION_DEBOUNCE) {
                    console.log(`â¸ï¸ ØªÙ… ØªØ®Ø·ÙŠ updateSectionData Ù„Ù„Ù‚Ø³Ù… ${section} - ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ù…Ø¤Ø®Ø±Ø§Ù‹`);
                    return;
                }
                
                lastUpdateSection = section;
                lastUpdateTime = now;
                
                // âœ… Ø¥Ø¸Ù‡Ø§Ø± loading overlay Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                if (typeof showLoading === 'function') {
                    showLoading();
                } else if (window.loadingOverlay && typeof window.loadingOverlay.show === 'function') {
                    window.loadingOverlay.show();
                }
                
                // ØªØ£Ø®ÙŠØ± Ø¥Ø¶Ø§ÙÙŠ Ù„Ø¶Ù…Ø§Ù† Ø£Ù† DOM Ø¬Ø§Ù‡Ø² ØªÙ…Ø§Ù…Ø§Ù‹
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù‡Ùˆ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù†Ø´Ø· Ø§Ù„ÙˆØ­ÙŠØ¯
                const targetSection = document.getElementById(`${section}-section`);
                if (targetSection) {
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù‚Ø³Ù… Ù†Ø´Ø·Ø§Ù‹ØŒ ØªÙØ¹ÙŠÙ„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ø®Ø§ØµØ© Ù„Ù„Ù…Ø®Ø²ÙˆÙ†)
                    if (!targetSection.classList.contains('active')) {
                        console.log(`âš ï¸ Ø§Ù„Ù‚Ø³Ù… ${section} ØºÙŠØ± Ù†Ø´Ø·ØŒ Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹`);
                        targetSection.classList.add('active');
                        targetSection.style.display = 'block';
                    }
                    
                    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰
                    document.querySelectorAll('.section').forEach(sec => {
                        if (sec !== targetSection) {
                            sec.classList.remove('active');
                            sec.style.display = 'none';
                        }
                    });
                    
                    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© Ù„Ù„Ù…Ø®Ø²Ù† Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù‡Ùˆ Ø§Ù„Ù…Ø®Ø²Ù†
                    if (section !== 'inventory') {
                        document.querySelectorAll('.inventory-section').forEach(sec => {
                            sec.classList.remove('active');
                            sec.style.display = 'none';
                        });
                    }
                }
                
                switch (section) {
                    case 'dashboard':
                        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙˆØ§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„ Ù‚Ø¨Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                        const dashboardSectionEl = document.getElementById('dashboard-section');
                        if (dashboardSectionEl) {
                            setTimeout(() => {
                                const branchTabs = dashboardSectionEl.querySelector('.branch-tabs');
                                if (branchTabs) {
                                    branchTabs.style.display = 'flex';
                                    branchTabs.style.visibility = 'visible';
                                    branchTabs.style.opacity = '1';
                                    console.log('âœ… [updateSectionData] ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹');
                                }
                                
                                const firstBranch = dashboardSectionEl.querySelector('.dashboard-branch[data-branch="1"]');
                                const secondBranch = dashboardSectionEl.querySelector('.dashboard-branch[data-branch="2"]');
                                if (firstBranch) {
                                    if (!firstBranch.classList.contains('active')) {
                                        firstBranch.classList.add('active');
                                    }
                                    firstBranch.style.display = 'block';
                                }
                                if (secondBranch) {
                                    if (secondBranch.classList.contains('active')) {
                                        secondBranch.classList.remove('active');
                                    }
                                    secondBranch.style.display = 'none';
                                }
                                
                                const firstTab = dashboardSectionEl.querySelector('.branch-tab:nth-child(1)');
                                const secondTab = dashboardSectionEl.querySelector('.branch-tab:nth-child(2)');
                                if (firstTab && !firstTab.classList.contains('active')) {
                                    firstTab.classList.add('active');
                                }
                                if (secondTab && secondTab.classList.contains('active')) {
                                    secondTab.classList.remove('active');
                                }
                            }, 50);
                        }
                        
                        await loadDashboardData();
                        break;
                    case 'repairs':
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø©
                        let attempts = 0;
                        const checkRepairsFunction = async () => {
                            if (typeof loadRepairsSection === 'function') {
                                console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø³Ù… Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©...');
                                const repairsSection = document.getElementById('repairs-section');
                                if (repairsSection) {
                                    repairsSection.classList.add('active');
                                }
                                await loadRepairsSection();
                            } else if (attempts < 10) {
                                attempts++;
                                setTimeout(checkRepairsFunction, 150);
                            } else {
                                console.warn('âš ï¸ loadRepairsSection ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø¨Ø¹Ø¯ 10 Ù…Ø­Ø§ÙˆÙ„Ø§Øª');
                            }
                        };
                        
                        if (forceReload) {
                            await checkRepairsFunction();
                        }
                        break;
                    case 'customers':
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø©
                        let customerAttempts = 0;
                        const checkCustomersFunction = async () => {
                            if (typeof loadCustomersSection === 'function') {
                                console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø³Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...');
                                const customersSection = document.getElementById('customers-section');
                                if (customersSection) {
                                    customersSection.classList.add('active');
                                }
                                await loadCustomersSection();
                            } else if (customerAttempts < 10) {
                                customerAttempts++;
                                setTimeout(checkCustomersFunction, 150);
                            } else {
                                console.warn('âš ï¸ loadCustomersSection ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø¨Ø¹Ø¯ 10 Ù…Ø­Ø§ÙˆÙ„Ø§Øª');
                            }
                        };
                        
                        if (forceReload) {
                            await checkCustomersFunction();
                        }
                        break;
                    case 'inventory':
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø©
                        let inventoryAttempts = 0;
                        const checkInventoryFunction = async () => {
                            if (typeof loadInventorySection === 'function') {
                                console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø³Ù… Ø§Ù„Ù…Ø®Ø²Ù†...');
                                
                                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù‚Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ…Ø±Ø¦ÙŠ
                                const inventorySection = document.getElementById('inventory-section');
                                if (!inventorySection) {
                                    console.warn('âš ï¸ Ù‚Ø³Ù… Ø§Ù„Ù…Ø®Ø²Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                                    return;
                                }
                                
                                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ù‚Ø³Ù… Ø§Ù„Ù…Ø®Ø²Ù† Ø£ÙˆÙ„Ø§Ù‹
                                inventorySection.classList.add('active');
                                inventorySection.style.display = 'block';
                                
                                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰
                                document.querySelectorAll('.section').forEach(sec => {
                                    if (sec !== inventorySection) {
                                        sec.classList.remove('active');
                                        sec.style.display = 'none';
                                    }
                                });
                                
                                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…
                                await loadInventorySection();
                                
                                // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…
                                setTimeout(() => {
                                    const savedTab = localStorage.getItem('current_inventory_tab') || 'spare_parts';
                                    if (typeof switchInventoryTab === 'function') {
                                        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø¹Ù†ØµØ±
                                        const tabElement = document.querySelector(`.inventory-tab[onclick*="'${savedTab}'"]`);
                                        if (tabElement) {
                                            switchInventoryTab(savedTab, tabElement);
                                        } else {
                                            // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ø§Ù„Ø¹Ù†ØµØ±ØŒ Ù†Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø«Ù… Ù†Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                                            setTimeout(() => {
                                                const retryTabElement = document.querySelector(`.inventory-tab[onclick*="'${savedTab}'"]`);
                                                if (retryTabElement) {
                                                    switchInventoryTab(savedTab, retryTabElement);
                                                } else {
                                                    // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                                                    console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø­ÙÙˆØ¸ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©');
                                                    const defaultTab = document.querySelector('.inventory-tab');
                                                    if (defaultTab) {
                                                        switchInventoryTab('spare_parts', defaultTab);
                                                    }
                                                }
                                            }, 500);
                                        }
                                    }
                                }, 500);
                            } else if (inventoryAttempts < 15) {
                                inventoryAttempts++;
                                setTimeout(checkInventoryFunction, 150);
                            } else {
                                console.warn('âš ï¸ loadInventorySection ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø¨Ø¹Ø¯ 15 Ù…Ø­Ø§ÙˆÙ„Ø©ØŒ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ inventory.js...');
                                // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ inventory.js ÙŠØ¯ÙˆÙŠØ§Ù‹
                                const script = document.createElement('script');
                                script.src = 'js/inventory.js';
                                script.defer = true;
                                script.onload = () => {
                                    setTimeout(() => {
                                        if (typeof loadInventorySection === 'function') {
                                            loadInventorySection();
                                        }
                                    }, 200);
                                };
                                document.body.appendChild(script);
                            }
                        };
                        
                        if (forceReload) {
                            checkInventoryFunction();
                        }
                        break;
                    case 'expenses':
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø©
                        let expensesAttempts = 0;
                        const checkExpensesFunction = async () => {
                            if (typeof loadExpensesSection === 'function') {
                                console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª...');
                                const expensesSection = document.getElementById('expenses-section');
                                if (expensesSection) {
                                    expensesSection.classList.add('active');
                                }
                                await loadExpensesSection();
                            } else if (expensesAttempts < 10) {
                                expensesAttempts++;
                                setTimeout(checkExpensesFunction, 150);
                            } else {
                                console.warn('âš ï¸ loadExpensesSection ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø¨Ø¹Ø¯ 10 Ù…Ø­Ø§ÙˆÙ„Ø§Øª');
                            }
                        };
                        
                        if (forceReload) {
                            await checkExpensesFunction();
                        }
                        break;
                    case 'reports':
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø©
                        let reportsAttempts = 0;
                        const checkReportsFunction = async () => {
                            if (typeof loadReportsSection === 'function') {
                                console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø³Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±...');
                                const reportsSection = document.getElementById('reports-section');
                                if (reportsSection) {
                                    reportsSection.classList.add('active');
                                }
                                await loadReportsSection();
                            } else if (reportsAttempts < 10) {
                                reportsAttempts++;
                                setTimeout(checkReportsFunction, 150);
                            } else {
                                console.warn('âš ï¸ loadReportsSection ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø¨Ø¹Ø¯ 10 Ù…Ø­Ø§ÙˆÙ„Ø§Øª');
                            }
                        };
                        
                        if (forceReload) {
                            await checkReportsFunction();
                        }
                        break;
                    case 'settings':
                        // ØªØ­Ù…ÙŠÙ„ settings.js Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø­Ù…Ù„Ø§Ù‹
                        if (typeof loadSettingsSection !== 'function') {
                            console.log('ğŸ“¦ ØªØ­Ù…ÙŠÙ„ settings.js...');
                            await loadScriptOnDemand('settings-script').catch(err => {
                                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ settings.js:', err);
                            });
                            
                            // âœ… Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† ØªÙ†ÙÙŠØ° Ø§Ù„Ù€ script Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                            await new Promise(resolve => setTimeout(resolve, 300));
                            
                            // âœ… Ù…Ø­Ø§ÙˆÙ„Ø© Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø§Ù„Ø©
                            let settingsAttempts = 0;
                            const maxSettingsAttempts = 15;
                            while (typeof loadSettingsSection !== 'function' && settingsAttempts < maxSettingsAttempts) {
                                settingsAttempts++;
                                await new Promise(resolve => setTimeout(resolve, 100));
                            }
                        }
                        
                        if (typeof loadSettingsSection === 'function') {
                            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ù‚Ø³Ù…
                            if (forceReload) {
                                console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª...');
                                try {
                                    await loadSettingsSection();
                                } catch (settingsError) {
                                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:', settingsError);
                                    const settingsSection = document.getElementById('settings-section');
                                    if (settingsSection) {
                                        settingsSection.innerHTML = `
                                            <div style="text-align: center; padding: 40px; color: var(--danger-color);">
                                                <i class="bi bi-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                                                <p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</p>
                                                <p style="font-size: 0.9em; margin-top: 10px; color: #999;">${(settingsError?.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>
                                                <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 20px;">
                                                    <i class="bi bi-arrow-clockwise"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
                                                </button>
                                            </div>
                                        `;
                                    }
                                }
                            }
                        } else {
                            console.error('âŒ loadSettingsSection ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø¨Ø¹Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©');
                            const settingsSection = document.getElementById('settings-section');
                            if (settingsSection) {
                                settingsSection.innerHTML = `
                                    <div style="text-align: center; padding: 40px; color: var(--danger-color);">
                                        <i class="bi bi-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                                        <p>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</p>
                                        <p style="font-size: 0.9em; margin-top: 10px; color: #999;">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¯Ø§Ù„Ø© loadSettingsSection</p>
                                        <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 20px;">
                                            <i class="bi bi-arrow-clockwise"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
                                        </button>
                                    </div>
                                `;
                            }
                        }
                        break;
                    case 'profile':
                        // ØªØ­Ù…ÙŠÙ„ profile.js Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø­Ù…Ù„Ø§Ù‹
                        if (typeof loadProfileSection !== 'function') {
                            console.log('ğŸ“¦ ØªØ­Ù…ÙŠÙ„ profile.js...');
                            await loadScriptOnDemand('profile-script').catch(err => {
                                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ profile.js:', err);
                            });
                        }
                        
                        if (typeof loadProfileSection === 'function') {
                            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ù‚Ø³Ù…
                            if (forceReload) {
                                console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ...');
                                try {
                                    await loadProfileSection();
                                } catch (profileError) {
                                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ:', profileError);
                                    const profileContent = document.getElementById('profile-content');
                                    if (profileContent) {
                                        profileContent.innerHTML = `
                                            <div style="text-align: center; padding: 40px; color: var(--danger-color);">
                                                <i class="bi bi-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                                                <p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</p>
                                                <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 20px;">
                                                    Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
                                                </button>
                                            </div>
                                        `;
                                    }
                                }
                            }
                        } else {
                            console.error('loadProfileSection ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
                            const profileContent = document.getElementById('profile-content');
                            if (profileContent) {
                                profileContent.innerHTML = `
                                    <div style="text-align: center; padding: 40px; color: var(--danger-color);">
                                        <i class="bi bi-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                                        <p>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</p>
                                        <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 20px;">
                                            Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
                                        </button>
                                    </div>
                                `;
                            }
                        }
                        break;
                }
                
                // âœ… Ø¥Ø®ÙØ§Ø¡ loading overlay Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                // Ù†Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ØºÙŠØ± Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©
                setTimeout(() => {
                    if (typeof hideLoading === 'function') {
                        hideLoading();
                    } else if (window.loadingOverlay && typeof window.loadingOverlay.hide === 'function') {
                        window.loadingOverlay.hide();
                    }
                }, 300);
            } catch (error) {
                console.error(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª ${section}:`, error);
                
                // âœ… Ø¥Ø®ÙØ§Ø¡ loading overlay Ø­ØªÙ‰ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
                if (typeof hideLoading === 'function') {
                    hideLoading();
                } else if (window.loadingOverlay && typeof window.loadingOverlay.hide === 'function') {
                    window.loadingOverlay.hide();
                }
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        async function loadDashboardData() {
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù‡ÙŠ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù†Ø´Ø·
            const dashboardSection = document.getElementById('dashboard-section');
            if (!dashboardSection) {
                console.error('âŒ Ù‚Ø³Ù… Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                return;
            }
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù†Ø´Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ
            setTimeout(() => {
                const branchTabs = dashboardSection.querySelector('.branch-tabs');
                console.log('ğŸ” [loadDashboardData] Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹:', branchTabs);
                if (branchTabs) {
                    branchTabs.style.display = 'flex';
                    branchTabs.style.visibility = 'visible';
                    branchTabs.style.opacity = '1';
                    console.log('âœ… [loadDashboardData] ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹');
                } else {
                    console.warn('âš ï¸ [loadDashboardData] Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ÙØ±ÙˆØ¹');
                }
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù†Ø´Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ÙØ±Ø¶ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„)
                const activeBranch = dashboardSection.querySelector('.dashboard-branch.active');
                const firstBranch = dashboardSection.querySelector('.dashboard-branch[data-branch="1"]');
                const secondBranch = dashboardSection.querySelector('.dashboard-branch[data-branch="2"]');
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ÙØ±Ø¹ Ù†Ø´Ø·ØŒ Ø§Ø­ØªÙØ¸ Ø¨Ù‡
                if (activeBranch) {
                    const activeBranchNumber = activeBranch.getAttribute('data-branch');
                    console.log(`âœ… [loadDashboardData] Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù†Ø´Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ: ${activeBranchNumber}`);
                    
                    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹
                    if (firstBranch) firstBranch.style.display = 'none';
                    if (secondBranch) secondBranch.style.display = 'none';
                    
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù†Ø´Ø· ÙÙ‚Ø·
                    activeBranch.style.display = 'block';
                } else {
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ÙØ±Ø¹ Ù†Ø´Ø·ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„ ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ
                    console.log('âš ï¸ [loadDashboardData] Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ±Ø¹ Ù†Ø´Ø·ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„ ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ');
                    if (firstBranch) {
                        firstBranch.classList.add('active');
                        firstBranch.style.display = 'block';
                    }
                    if (secondBranch) {
                        secondBranch.classList.remove('active');
                        secondBranch.style.display = 'none';
                    }
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù†Ø´Ø·
                const firstTab = dashboardSection.querySelector('.branch-tab:nth-child(1)');
                const secondTab = dashboardSection.querySelector('.branch-tab:nth-child(2)');
                
                if (activeBranch) {
                    const activeBranchNumber = activeBranch.getAttribute('data-branch');
                    if (activeBranchNumber === '1') {
                        if (firstTab) firstTab.classList.add('active');
                        if (secondTab) secondTab.classList.remove('active');
                    } else if (activeBranchNumber === '2') {
                        if (firstTab) firstTab.classList.remove('active');
                        if (secondTab) secondTab.classList.add('active');
                    }
                } else {
                    // Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„
                    if (firstTab) firstTab.classList.add('active');
                    if (secondTab) secondTab.classList.remove('active');
                }
            }, 100);
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù‡ÙŠ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù†Ø´Ø· Ø§Ù„ÙˆØ­ÙŠØ¯
            const isActive = dashboardSection.classList.contains('active');
            if (!isActive) {
                console.log('âš ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ØºÙŠØ± Ù†Ø´Ø·Ø©ØŒ Ù„Ù† ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                return;
            }
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰
            document.querySelectorAll('.section').forEach(sec => {
                if (sec !== dashboardSection) {
                    sec.classList.remove('active');
                    sec.style.display = 'none';
                }
            });
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© Ù„Ù„Ù…Ø®Ø²Ù†
            document.querySelectorAll('.inventory-section').forEach(sec => {
                sec.classList.remove('active');
                sec.style.display = 'none';
            });
            
            const syncIndicator = document.getElementById('syncIndicator');
            let hasError = false;
            let errorMessage = '';
            
            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… getTodayDate Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹ Ø£Ùˆ fallback
                const getTodayDateFunc = typeof getTodayDate === 'function' ? getTodayDate : () => {
                    const today = new Date();
                    return today.toISOString().split('T')[0];
                };
                const today = getTodayDateFunc();
                
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… formatCurrency Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹ Ø£Ùˆ fallback (ØªØ¹Ø±ÙŠÙ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·)
                const formatCurrencyFunc = typeof formatCurrency === 'function' ? formatCurrency : (amount) => {
                    return parseFloat(amount || 0).toFixed(2) + ' Ø¬.Ù…';
                };
                
                // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
                if (syncIndicator) {
                    syncIndicator.innerHTML = '<i class="bi bi-arrow-repeat"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
                    syncIndicator.style.color = '';
                }
                
                // ğŸ”§ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨Ø´ÙƒÙ„ Ù…ØªÙˆØ§Ø²ÙŠ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ù…ØªØ³Ù„Ø³Ù„
                let reportData = null;
                let currentRepairs = [];
                
                try {
                    // ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨Ø´ÙƒÙ„ Ù…ØªÙˆØ§Ø²ÙŠ Ù„ØªÙ‚Ù„ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                    const [reportResult, repairsResult] = await Promise.allSettled([
                        API.getReport('daily', today).catch(err => ({ success: false, error: err })),
                        API.getRepairs().catch(err => ({ success: false, error: err }))
                    ]);
                    
                    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                    if (reportResult.status === 'fulfilled' && reportResult.value && reportResult.value.success && reportResult.value.data) {
                        reportData = reportResult.value.data;
                    } else {
                        console.warn('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…:', reportResult.value?.message || reportResult.reason || 'Unknown error');
                        if (reportResult.value?.message) {
                            errorMessage = reportResult.value.message;
                            hasError = true;
                        }
                    }
                    
                    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
                    if (repairsResult.status === 'fulfilled' && repairsResult.value && repairsResult.value.success && repairsResult.value.data) {
                        currentRepairs = repairsResult.value.data.filter(r => 
                            r && (r.status === 'pending' || r.status === 'in_progress' || r.status === 'ready')
                        );
                    } else {
                        console.warn('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª:', repairsResult.value?.message || repairsResult.reason || 'Unknown error');
                        if (repairsResult.value?.message && !errorMessage) {
                            errorMessage = repairsResult.value.message;
                            hasError = true;
                        }
                    }
                    
                    // Ø¬Ù„Ø¨ Ø§Ù„ÙØ±ÙˆØ¹ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙƒÙ„ ÙØ±Ø¹
                    let branches = [];
                    try {
                        const branchesResult = await API.request('branches.php', 'GET');
                        if (branchesResult && branchesResult.success && branchesResult.data && Array.isArray(branchesResult.data)) {
                            branches = branchesResult.data.sort((a, b) => {
                                const dateA = new Date(a.created_at || 0);
                                const dateB = new Date(b.created_at || 0);
                                if (dateA.getTime() !== dateB.getTime()) {
                                    return dateA.getTime() - dateB.getTime();
                                }
                                return (a.id || '').localeCompare(b.id || '');
                            });
                            // Ø­ÙØ¸ Ø§Ù„ÙØ±ÙˆØ¹ ÙÙŠ window Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ getCurrentBranchId
                            window.dashboardBranches = branches;
                        }
                    } catch (error) {
                        console.warn('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙØ±ÙˆØ¹:', error);
                    }
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙƒÙ„ ÙØ±Ø¹
                    for (let branchIndex = 0; branchIndex < 2; branchIndex++) {
                        const branchNumber = branchIndex + 1;
                        const branchId = branches[branchIndex]?.id || null;
                        
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                        const todayRepairsEl = document.getElementById(`todayRepairs${branchNumber}`);
                        const todayRevenueEl = document.getElementById(`todayRevenue${branchNumber}`);
                        const todayExpensesEl = document.getElementById(`todayExpenses${branchNumber}`);
                        const todayProfitEl = document.getElementById(`todayProfit${branchNumber}`);
                        const todaySalesEl = document.getElementById(`todaySales${branchNumber}`);
                        const todayDamagedReturnsEl = document.getElementById(`todayDamagedReturns${branchNumber}`);
                        
                        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯
                        let branchReportData = null;
                        let branchRepairs = [];
                        let todaySalesAmount = 0;
                        
                        // âœ… Ø¥ØµÙ„Ø§Ø­: Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ ÙØ±Ø¹ Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„ ÙˆÙ…Ø³ØªÙ‚Ù„
                        try {
                            if (branchId) {
                                // ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ±Ø¹ Ù…Ø¹ branch_id
                                const branchReportUrl = `reports.php?type=daily&start_date=${today}&end_date=${today}&branch_id=${branchId}`;
                                const branchReportResult = await API.request(branchReportUrl, 'GET').catch(() => ({ success: false }));
                                if (branchReportResult && branchReportResult.success && branchReportResult.data) {
                                    branchReportData = branchReportResult.data;
                                    console.log(`âœ… [Branch ${branchNumber}] ØªÙ… ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ±Ø¹:`, branchReportData);
                                } else {
                                    console.warn(`âš ï¸ [Branch ${branchNumber}] ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ±Ø¹`);
                                }
                                
                                // ØªØ­Ù…ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙØ±Ø¹ Ù…Ø¹ branch_id
                                const branchRepairsResult = await API.getRepairs(branchId).catch(() => ({ success: false }));
                                if (branchRepairsResult && branchRepairsResult.success && branchRepairsResult.data) {
                                    branchRepairs = branchRepairsResult.data.filter(r => 
                                        r && (r.status === 'pending' || r.status === 'in_progress' || r.status === 'ready')
                                    );
                                    console.log(`âœ… [Branch ${branchNumber}] ØªÙ… ØªØ­Ù…ÙŠÙ„ ${branchRepairs.length} Ø¹Ù…Ù„ÙŠØ© Ù„Ù„ÙØ±Ø¹`);
                                }
                            } else {
                                // âœ… Ø¥ØµÙ„Ø§Ø­: Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ branchIdØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ø±ÙŠØ± Ø¹Ø§Ù… Ø¨Ø¯ÙˆÙ† branch_id
                                // Ù„ÙƒÙ† ÙÙ‚Ø· Ù„Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„ ÙƒØ­Ø§Ù„Ø© fallback
                                if (branchIndex === 0) {
                                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… reportData Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹ (Ø¨Ø¯ÙˆÙ† branch_id)
                                    if (reportData) {
                                        branchReportData = reportData;
                                        branchRepairs = currentRepairs;
                                        console.log(`âš ï¸ [Branch ${branchNumber}] Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (Ù„Ø§ ÙŠÙˆØ¬Ø¯ branchId)`);
                                    }
                                } else {
                                    // Ù„Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ branchIdØŒ Ø¹Ø±Ø¶ Ù‚ÙŠÙ… ØµÙØ±
                                    console.warn(`âš ï¸ [Branch ${branchNumber}] Ù„Ø§ ÙŠÙˆØ¬Ø¯ branchId - Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ù‚ÙŠÙ… ØµÙØ±`);
                                    branchReportData = null;
                                    branchRepairs = [];
                                }
                            }
                        } catch (error) {
                            console.error(`âŒ [Branch ${branchNumber}] Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±Ø¹:`, error);
                            branchReportData = null;
                            branchRepairs = [];
                        }
                        
                        // âœ… Ø¥ØµÙ„Ø§Ø­: Ø§Ø³ØªØ®Ø¯Ø§Ù… sales_profit Ù…Ù† branchReportData Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„
                        // sales_profit Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ±Ø¹ Ù…Ù† reports.php
                        if (branchReportData && branchNumber === 1) {
                            // Ù„Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„: Ø§Ø³ØªØ®Ø¯Ø§Ù… sales_profit Ù…Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Ù…Ø­Ø³ÙˆØ¨ Ø¨Ø§Ù„ÙØ¹Ù„ Ù„ÙƒÙ„ ÙØ±Ø¹)
                            todaySalesAmount = parseFloat(branchReportData.total_sales_revenue || 0);
                        } else if (branchNumber === 2) {
                            // Ù„Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª (Ø£Ùˆ 0)
                            todaySalesAmount = 0;
                        }
                        
                        // âœ… Ø¥ØµÙ„Ø§Ø­: Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙƒÙ„ ÙØ±Ø¹ Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„ ÙˆÙ…Ø³ØªÙ‚Ù„
                        if (branchReportData) {
                            // Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
                            if (todayRepairsEl) {
                                todayRepairsEl.textContent = branchReportData.repairs_count || 0;
                            }
                            
                            // Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ… - Ø­Ø³Ø§Ø¨ Ù…Ù†ÙØµÙ„ Ù„ÙƒÙ„ ÙØ±Ø¹
                            if (todayRevenueEl) {
                                if (branchNumber === 1) {
                                    // Ù„Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„: ØµØ§ÙÙŠ Ø±Ø¨Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª + ØµØ§ÙÙŠ Ø±Ø¨Ø­ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ù…Ù† ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ±Ø¹)
                                    const repairProfit = parseFloat(branchReportData.revenue || 0);
                                    const salesProfit = parseFloat(branchReportData.sales_profit || 0);
                                    const totalRevenue = repairProfit + salesProfit;
                                    todayRevenueEl.textContent = formatCurrencyFunc(totalRevenue);
                                    console.log(`âœ… [Branch ${branchNumber}] Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª: ${totalRevenue} (Ø¹Ù…Ù„ÙŠØ§Øª: ${repairProfit}, Ù…Ø¨ÙŠØ¹Ø§Øª: ${salesProfit})`);
                                } else {
                                    // Ù„Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ: ØµØ§ÙÙŠ Ø±Ø¨Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙÙ‚Ø· (Ù…Ù† ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ)
                                    const repairProfit = parseFloat(branchReportData.revenue || 0);
                                    todayRevenueEl.textContent = formatCurrencyFunc(repairProfit);
                                    console.log(`âœ… [Branch ${branchNumber}] Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª: ${repairProfit} (Ø¹Ù…Ù„ÙŠØ§Øª ÙÙ‚Ø·)`);
                                }
                            }
                            
                            // Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…
                            if (todayExpensesEl) {
                                todayExpensesEl.textContent = formatCurrencyFunc(branchReportData.expenses || 0);
                            }
                            
                            // Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„ØªØ§Ù„ÙØ© (Ø¬Ù„Ø¨ Ù…Ù† branch-treasury.php Ø¥Ø°Ø§ ÙƒØ§Ù† branchId Ù…ÙˆØ¬ÙˆØ¯)
                            if (todayDamagedReturnsEl) {
                                if (branchId) {
                                    try {
                                        const treasuryUrl = `branch-treasury.php?branch_id=${branchId}&filter_type=today`;
                                        const treasuryResult = await API.request(treasuryUrl, 'GET').catch(() => ({ success: false }));
                                        if (treasuryResult && treasuryResult.success && treasuryResult.data) {
                                            const damagedReturns = parseFloat(treasuryResult.data.damaged_returns?.total || 0);
                                            todayDamagedReturnsEl.textContent = formatCurrencyFunc(damagedReturns);
                                        } else {
                                            todayDamagedReturnsEl.textContent = formatCurrencyFunc(0);
                                        }
                                    } catch (error) {
                                        console.error(`âŒ [Branch ${branchNumber}] Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„ØªØ§Ù„ÙØ©:`, error);
                                        todayDamagedReturnsEl.textContent = formatCurrencyFunc(0);
                                    }
                                } else {
                                    todayDamagedReturnsEl.textContent = formatCurrencyFunc(0);
                                }
                            }
                            
                            // ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
                            if (todayProfitEl) {
                                todayProfitEl.textContent = formatCurrencyFunc(branchReportData.profit || 0);
                            }
                        } else {
                            console.warn(`âš ï¸ [Branch ${branchNumber}] Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª - Ø¹Ø±Ø¶ Ù‚ÙŠÙ… ØµÙØ±`);
                            if (todayRepairsEl) todayRepairsEl.textContent = '0';
                            if (todayRevenueEl) todayRevenueEl.textContent = formatCurrencyFunc(0);
                            if (todayExpensesEl) todayExpensesEl.textContent = formatCurrencyFunc(0);
                            if (todayProfitEl) todayProfitEl.textContent = formatCurrencyFunc(0);
                            if (todayDamagedReturnsEl) todayDamagedReturnsEl.textContent = formatCurrencyFunc(0);
                        }
                        
                        // Ø¹Ø±Ø¶ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ… (Ù„Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„ ÙÙ‚Ø·)
                        if (todaySalesEl) {
                            if (branchNumber === 1 && branchReportData) {
                                // Ø§Ø³ØªØ®Ø¯Ø§Ù… total_sales_revenue Ù…Ù† ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ±Ø¹ (Ù…Ø­Ø³ÙˆØ¨ Ø¨Ø§Ù„ÙØ¹Ù„ Ù„ÙƒÙ„ ÙØ±Ø¹)
                                todaySalesAmount = parseFloat(branchReportData.total_sales_revenue || 0);
                            } else {
                                // Ù„Ù„ÙØ±Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ: 0 (Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª)
                                todaySalesAmount = 0;
                            }
                            todaySalesEl.textContent = formatCurrencyFunc(todaySalesAmount);
                            console.log(`âœ… [Branch ${branchNumber}] Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ${todaySalesAmount}`);
                        }
                        
                        // ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„ÙÙ†ÙŠÙŠÙ† Ù„Ù„ÙØ±Ø¹
                        if (branchId) {
                            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒÙ‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                            const monthFilter = document.getElementById(`technicianMonthFilter${branchNumber}`);
                            if (monthFilter && !monthFilter.value) {
                                const now = new Date();
                                monthFilter.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                            }
                            loadTechnicians(branchId, branchNumber);
                        }
                    }
                    
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Dashboard:', error);
                    hasError = true;
                    if (error.message && !errorMessage) {
                        errorMessage = error.message;
                    }
                    
                    // Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹
                    for (let branchNumber = 1; branchNumber <= 2; branchNumber++) {
                        const todayRepairsEl = document.getElementById(`todayRepairs${branchNumber}`);
                        const todayRevenueEl = document.getElementById(`todayRevenue${branchNumber}`);
                        const todayExpensesEl = document.getElementById(`todayExpenses${branchNumber}`);
                        const todayProfitEl = document.getElementById(`todayProfit${branchNumber}`);
                        const todaySalesEl = document.getElementById(`todaySales${branchNumber}`);
                        
                        if (todayRepairsEl) todayRepairsEl.textContent = '0';
                        if (todayRevenueEl) todayRevenueEl.textContent = formatCurrencyFunc(0);
                        if (todayExpensesEl) todayExpensesEl.textContent = formatCurrencyFunc(0);
                        if (todayProfitEl) todayProfitEl.textContent = formatCurrencyFunc(0);
                        if (todaySalesEl) todaySalesEl.textContent = formatCurrencyFunc(0);
                        
                        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠÙŠÙ† Ø­ØªÙ‰ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
                        const branchId = branches[branchNumber - 1]?.id || null;
                        if (branchId) {
                            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒÙ‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                            const monthFilter = document.getElementById(`technicianMonthFilter${branchNumber}`);
                            if (monthFilter && !monthFilter.value) {
                                const now = new Date();
                                monthFilter.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                            }
                            loadTechnicians(branchId, branchNumber);
                        }
                    }
                }
                
                // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø©
                if (syncIndicator) {
                    if (hasError) {
                        syncIndicator.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„';
                        syncIndicator.style.color = 'var(--danger-color)';
                        syncIndicator.title = errorMessage || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
                    } else {
                        syncIndicator.innerHTML = '<i class="bi bi-check-circle"></i> Ù…Ø­Ø¯Ø«';
                        syncIndicator.style.color = 'var(--success-color)';
                        syncIndicator.title = 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­';
                        setTimeout(() => {
                            if (syncIndicator) {
                                const now = new Date();
                                const timeStr = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', timeZone: 'Africa/Cairo' });
                                // Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø£ÙŠÙ‚ÙˆÙ†Ø© refresh Ø¯Ø§Ø¦Ù…Ø§Ù‹
                                const isMobile = window.innerWidth <= 575.98;
                                const iconClass = isMobile ? 'bi-arrow-repeat' : 'bi-check-circle';
                                syncIndicator.innerHTML = `<i class="bi ${iconClass}"></i> Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${timeStr}`;
                                syncIndicator.title = `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${timeStr}`;
                            }
                        }, 1000);
                    }
                }
                
                // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø®Ø·Ø£ Ø­Ù‚ÙŠÙ‚ÙŠ
                if (hasError && errorMessage) {
                    // Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù…Ø­Ù…Ù„Ø© (Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø¬Ø²Ø¡ Ù…Ù†Ù‡Ø§)
                    if (!reportData) {
                        showMessage('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + errorMessage, 'error');
                    }
                }
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…:', error);
                
                // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… formatCurrency Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹ Ø£Ùˆ fallback
                const formatCurrencyFunc = typeof formatCurrency === 'function' ? formatCurrency : (amount) => {
                    return parseFloat(amount || 0).toFixed(2) + ' Ø¬.Ù…';
                };
                
                for (let branchNumber = 1; branchNumber <= 2; branchNumber++) {
                    const todayRepairsEl = document.getElementById(`todayRepairs${branchNumber}`);
                    const todayRevenueEl = document.getElementById(`todayRevenue${branchNumber}`);
                    const todayExpensesEl = document.getElementById(`todayExpenses${branchNumber}`);
                    const todayProfitEl = document.getElementById(`todayProfit${branchNumber}`);
                    const todaySalesEl = document.getElementById(`todaySales${branchNumber}`);
                    
                    if (todayRepairsEl) todayRepairsEl.textContent = '0';
                    if (todayRevenueEl) todayRevenueEl.textContent = formatCurrencyFunc(0);
                    if (todayExpensesEl) todayExpensesEl.textContent = formatCurrencyFunc(0);
                    if (todayProfitEl) todayProfitEl.textContent = formatCurrencyFunc(0);
                    if (todaySalesEl) todaySalesEl.textContent = formatCurrencyFunc(0);
                }
                
                // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø®Ø·Ø£
                if (syncIndicator) {
                    syncIndicator.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„';
                    syncIndicator.style.color = 'var(--danger-color)';
                    syncIndicator.title = error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
                }
                
                // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                showMessage('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + (error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'), 'error');
            }
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† ÙØ±ÙˆØ¹ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        function switchDashboardBranch(branchNumber) {
            try {
                console.log(`ğŸ”„ [switchDashboardBranch] Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙØ±Ø¹ ${branchNumber}`);
                
                // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹ ÙˆØ¥Ø²Ø§Ù„Ø© active
                const allBranches = document.querySelectorAll('.dashboard-branch');
                allBranches.forEach(branch => {
                    branch.classList.remove('active');
                    branch.style.display = 'none';
                });
                
                // Ø¥Ø²Ø§Ù„Ø© active Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
                const allTabs = document.querySelectorAll('.branch-tab');
                allTabs.forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯
                const targetBranch = document.querySelector(`.dashboard-branch[data-branch="${branchNumber}"]`);
                if (targetBranch) {
                    targetBranch.classList.add('active');
                    targetBranch.style.display = 'block';
                    console.log(`âœ… [switchDashboardBranch] ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙØ±Ø¹ ${branchNumber}`);
                } else {
                    console.error(`âŒ [switchDashboardBranch] Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙØ±Ø¹ ${branchNumber}`);
                }
                
                // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø­Ø¯Ø¯
                const targetTab = document.querySelector(`.branch-tab:nth-child(${branchNumber})`);
                if (targetTab) {
                    targetTab.classList.add('active');
                    console.log(`âœ… [switchDashboardBranch] ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ ${branchNumber}`);
                } else {
                    console.error(`âŒ [switchDashboardBranch] Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ ${branchNumber}`);
                }
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯
                loadDashboardData();
            } catch (error) {
                console.error('âŒ [switchDashboardBranch] Ø®Ø·Ø£:', error);
            }
        }
        
        // Ø¬Ø¹Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
        window.switchDashboardBranch = switchDashboardBranch;

        // Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        // âœ… Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ branch_id Ù„Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯
        function getCurrentBranchId(branchNumber) {
            try {
                const branches = window.dashboardBranches || [];
                if (branches && branches.length >= branchNumber) {
                    return branches[branchNumber - 1]?.id || null;
                }
                return null;
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ branch_id:', error);
                return null;
            }
        }
        
        // âœ… Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„ÙÙ†ÙŠÙŠÙ†
        async function loadTechnicians(branchId, branchNumber) {
            try {
                const grid = document.getElementById(`techniciansGrid${branchNumber}`);
                if (!grid) {
                    console.warn(`techniciansGrid${branchNumber} element not found`);
                    return;
                }
                
                // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
                grid.innerHTML = `
                    <div class="loading-placeholder">
                        <i class="bi bi-hourglass-split"></i>
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙ†ÙŠÙŠÙ†...</p>
                    </div>
                `;
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
                const monthFilter = document.getElementById(`technicianMonthFilter${branchNumber}`);
                const selectedMonth = monthFilter ? monthFilter.value : '';
                
                // Ø¨Ù†Ø§Ø¡ URL Ù…Ø¹ Ø§Ù„ÙÙ„ØªØ±Ø© - âœ… Ø¥Ø¶Ø§ÙØ© include_admins=true Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† admin Ø£ÙŠØ¶Ø§Ù‹
                let url = `technicians.php?branch_id=${encodeURIComponent(branchId)}&include_admins=true`;
                if (selectedMonth) {
                    url += `&month=${encodeURIComponent(selectedMonth)}`;
                }
                
                // Ø¬Ù„Ø¨ Ø§Ù„ÙÙ†ÙŠÙŠÙ† Ù…Ù† API
                const result = await API.request(url, 'GET');
                
                if (!result || !result.success) {
                    throw new Error(result?.message || 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙÙ†ÙŠÙŠÙ†');
                }
                
                const technicians = result.data || [];
                
                // âœ… Ø¥Ø¶Ø§ÙØ© console.log Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                console.log(`ğŸ” [loadTechnicians] Ø§Ù„ÙØ±Ø¹ ${branchNumber}:`, technicians.length, 'ÙÙ†ÙŠ');
                technicians.forEach((tech, index) => {
                    const techName = (tech.name || tech.username || '').trim();
                    const techRole = tech.role || 'N/A';
                    const techBranch = tech.branch_id || 'N/A';
                    console.log(`  [${index + 1}] ${techName} (ID: ${tech.id}, Role: ${techRole}, Branch: ${techBranch})`);
                    if (techRole === 'admin') {
                        console.log(`    â­ [Admin Found] ÙÙ†ÙŠ admin Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ÙØ±Ø¹ ${branchNumber}!`);
                    }
                });
                
                // Ø¹Ø±Ø¶ Ø§Ù„ÙÙ†ÙŠÙŠÙ†
                displayTechnicians(technicians, branchNumber);
                
            } catch (error) {
                console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠÙŠÙ† Ù„Ù„ÙØ±Ø¹ ${branchNumber}:`, error);
                const grid = document.getElementById(`techniciansGrid${branchNumber}`);
                if (grid) {
                    grid.innerHTML = `
                        <div class="empty-technicians">
                            <i class="bi bi-exclamation-triangle"></i>
                            <p>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙ†ÙŠÙŠÙ†</p>
                        </div>
                    `;
                }
            }
        }
        
        // âœ… Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ÙÙ†ÙŠÙŠÙ†
        function displayTechnicians(technicians, branchNumber) {
            const grid = document.getElementById(`techniciansGrid${branchNumber}`);
            if (!grid) {
                console.warn(`techniciansGrid${branchNumber} element not found`);
                return;
            }
            
            try {
                console.log(`ğŸ” [displayTechnicians] Ø§Ù„ÙØ±Ø¹ ${branchNumber}:`, technicians.length, 'ÙÙ†ÙŠ');
                
                if (!technicians || !Array.isArray(technicians) || technicians.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-technicians">
                            <i class="bi bi-person-x"></i>
                            <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙ†ÙŠÙˆÙ† Ù…Ø±ØªØ¨Ø·ÙˆÙ† Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹</p>
                        </div>
                    `;
                    return;
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø§Ù„Ùƒ
                const currentUser = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
                const isOwner = currentUser && (currentUser.role === 'admin' || currentUser.is_owner === true || currentUser.is_owner === 'true');
                
                // Ø¨Ù†Ø§Ø¡ HTML Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
                const cardsHTML = technicians.map(technician => {
                    const avgRating = parseFloat(technician.avg_rating || 0);
                    const monthlyAvgRating = parseFloat(technician.monthly_avg_rating || 0);
                    const totalRatings = parseInt(technician.total_ratings || 0);
                    const monthlyRatings = parseInt(technician.monthly_ratings || 0);
                    const completedRepairs = parseInt(technician.completed_repairs || 0);
                    const monthlyRepairs = parseInt(technician.monthly_repairs || 0);
                    
                    // âœ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø£Ùˆ Ø§Ù„Ø­Ø±Ù Ø§Ù„Ø£ÙˆÙ„
                    const avatarUrl = technician.avatar || null;
                    const firstLetter = (technician.name || technician.username || 'Ù').charAt(0);
                    const avatarHTML = avatarUrl 
                        ? `<img src="${escapeHtml(avatarUrl)}" alt="${escapeHtml(technician.name || '')}" class="technician-avatar-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                           <div class="technician-avatar-fallback" style="display: none;">${escapeHtml(firstLetter)}</div>`
                        : `<div class="technician-avatar-fallback">${escapeHtml(firstLetter)}</div>`;
                    
                    // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† role Ø§Ù„ÙÙ†ÙŠ - Ø¥Ø°Ø§ ÙƒØ§Ù† "admin" (Ù…Ø§Ù„Ùƒ) ÙˆØ§Ù„ÙØ±Ø¹ Ù‡Ùˆ Ø§Ù„Ø£ÙˆÙ„
                    const isAdmin = technician.role === 'admin';
                    
                    // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ÙØ±Ø¹ Ù‡Ùˆ Ø§Ù„Ø£ÙˆÙ„ (branchNumber === 1)
                    const isFirstBranch = branchNumber === 1;
                    const shouldShowPremiumCard = isAdmin && isFirstBranch;
                    
                    // âœ… Ø¥Ø¶Ø§ÙØ© console.log Ù„Ù„ØªØ­Ù‚Ù‚
                    if (isAdmin) {
                        const technicianName = (technician.name || technician.username || '').trim();
                        console.log(`ğŸ” [Dashboard] ÙÙ†ÙŠ "Ù…Ø§Ù„Ùƒ" (admin) Ù…ÙˆØ¬ÙˆØ¯ - Ø§Ø³Ù…: "${technicianName}", Ø§Ù„ÙØ±Ø¹: ${branchNumber}, isFirstBranch: ${isFirstBranch}, shouldShowPremiumCard: ${shouldShowPremiumCard}`);
                    }
                    
                    // âœ… Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙÙ†ÙŠ "admin" (Ù…Ø§Ù„Ùƒ)ØŒ ÙŠØ¹Ø±Ø¶ 5 Ù†Ø¬ÙˆÙ… Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
                    const displayRating = shouldShowPremiumCard ? 5 : Math.round(avgRating);
                    const displayMonthlyRating = shouldShowPremiumCard ? 5 : Math.round(monthlyAvgRating);
                    
                    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Ø¬ÙˆÙ… Ù„Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ
                    let starsHTML = '';
                    for (let i = 1; i <= 5; i++) {
                        const isFilled = i <= displayRating;
                        starsHTML += `<span class="star ${isFilled ? '' : 'empty'}"><i class="bi bi-star${isFilled ? '-fill' : ''}"></i></span>`;
                    }
                    
                    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Ø¬ÙˆÙ… Ù„Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø´Ù‡Ø±ÙŠ
                    let monthlyStarsHTML = '';
                    for (let i = 1; i <= 5; i++) {
                        const isFilled = i <= displayMonthlyRating;
                        monthlyStarsHTML += `<span class="star ${isFilled ? '' : 'empty'}"><i class="bi bi-star${isFilled ? '-fill' : ''}"></i></span>`;
                    }
                    
                    // âœ… Ø¥Ø¶Ø§ÙØ© class "premium-gold" Ù„Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙÙ†ÙŠ "admin" (Ù…Ø§Ù„Ùƒ) ÙˆØ§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„
                    const cardClass = shouldShowPremiumCard ? 'technician-card premium-gold' : 'technician-card';
                    
                    return `
                        <div class="${cardClass}" data-technician-id="${technician.id}" data-technician-name="${escapeHtml(technician.name || '')}" style="cursor: pointer;">
                            <div class="technician-card-header">
                                <div class="technician-avatar">${avatarHTML}</div>
                                <div class="technician-info">
                                    <div class="technician-name">
                                        <span class="technician-name-text">${escapeHtml(technician.name || '')}</span>
                                        ${shouldShowPremiumCard ? `
                                            <span class="technician-badge-premium" style="
                                                display: inline-block;
                                                padding: 3px 10px;
                                                background: rgba(255, 255, 255, 0.95);
                                                color: #8B4513;
                                                border-radius: 15px;
                                                font-size: 0.7em;
                                                font-weight: 700;
                                                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
                                                border: 1px solid rgba(255, 215, 0, 0.6);
                                                white-space: nowrap;
                                                flex-shrink: 0;
                                            ">â­ ÙÙ†ÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø©</span>
                                        ` : ''}
                                    </div>
                                    <div class="technician-username">@${escapeHtml(technician.username || '')}</div>
                                </div>
                            </div>
                            
                            <div class="technician-rating">
                                <div class="rating-item">
                                    <span class="rating-label">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ:</span>
                                    <div class="rating-value">
                                        <div class="rating-stars">${starsHTML}</div>
                                        <span class="rating-number">${shouldShowPremiumCard ? '5.0' : (avgRating > 0 ? avgRating.toFixed(1) : '0.0')}</span>
                                    </div>
                                </div>
                                ${shouldShowPremiumCard ? `
                                    <div class="rating-count" style="color: #8B4513; font-weight: 600;">â­ ÙÙ†ÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø© - Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£ÙˆÙ„</div>
                                ` : totalRatings > 0 ? `
                                    <div class="rating-count">Ù…Ù† ${totalRatings} ØªÙ‚ÙŠÙŠÙ…${totalRatings > 1 ? 'Ø§Øª' : ''}</div>
                                ` : `
                                    <div class="rating-count" style="color: var(--text-light);">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯</div>
                                `}
                            </div>
                            
                            <div class="technician-monthly-rating" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--light-bg);">
                                <div class="rating-item">
                                    <span class="rating-label" style="font-size: 0.9em;">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø´Ù‡Ø±ÙŠ:</span>
                                    <div class="rating-value">
                                        <div class="rating-stars" style="font-size: 0.9em;">${monthlyStarsHTML}</div>
                                        <span class="rating-number" style="font-size: 0.95em;">${shouldShowPremiumCard ? '5.0' : (monthlyAvgRating > 0 ? monthlyAvgRating.toFixed(1) : '0.0')}</span>
                                    </div>
                                </div>
                                ${shouldShowPremiumCard ? `
                                    <div class="rating-count" style="font-size: 0.85em; color: #8B4513; font-weight: 600;">â­ ÙÙ†ÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø©</div>
                                ` : monthlyRatings > 0 ? `
                                    <div class="rating-count" style="font-size: 0.85em;">Ù…Ù† ${monthlyRatings} ØªÙ‚ÙŠÙŠÙ…${monthlyRatings > 1 ? 'Ø§Øª' : ''}</div>
                                ` : `
                                    <div class="rating-count" style="font-size: 0.85em; color: var(--text-light);">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
                                `}
                            </div>
                            
                            <div class="technician-stats">
                                <div class="technician-stat">
                                    <div class="technician-stat-value">${completedRepairs}</div>
                                    <div class="technician-stat-label">Ø¹Ù…Ù„ÙŠØ§Øª Ù…ÙƒØªÙ…Ù„Ø©</div>
                                </div>
                                <div class="technician-stat">
                                    <div class="technician-stat-value">${monthlyRepairs}</div>
                                    <div class="technician-stat-label">Ø¹Ù…Ù„ÙŠØ§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
                                </div>
                            </div>
                            
                            ${isOwner ? `
                                <div class="technician-card-footer">
                                    <button 
                                        onclick="event.stopPropagation(); showEditTechnicianRatingModal('${technician.id}', '${escapeHtml(technician.name || '')}', ${avgRating})" 
                                        class="btn-edit-rating-footer" 
                                        title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…">
                                        <i class="bi bi-pencil-square"></i>
                                        <span>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</span>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
                
                grid.innerHTML = cardsHTML;
                
                // âœ… Ø¥Ø¶Ø§ÙØ© event delegation Ù„ÙØªØ­ modal Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… event delegation Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ grid Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª
                // Ø¥Ø²Ø§Ù„Ø© event listeners Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
                const existingHandler = grid._technicianCardHandler;
                if (existingHandler) {
                    grid.removeEventListener('click', existingHandler);
                }
                
                // Ø¥Ù†Ø´Ø§Ø¡ handler Ø¬Ø¯ÙŠØ¯
                const technicianCardHandler = function(e) {
                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªÙŠ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„ÙŠÙ‡Ø§
                    const card = e.target.closest('.technician-card[data-technician-id]');
                    if (!card) return;
                    
                    // Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
                    if (e.target.closest('.btn-edit-rating-footer')) {
                        return;
                    }
                    
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const technicianId = card.getAttribute('data-technician-id');
                    const technicianName = card.getAttribute('data-technician-name') || 'Ø§Ù„ÙÙ†ÙŠ';
                    
                    if (technicianId) {
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ØªØ§Ø­Ø©
                        if (typeof window.showTechnicianRatingsModal === 'function') {
                            try {
                                window.showTechnicianRatingsModal(technicianId, technicianName);
                            } catch (error) {
                                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ modal Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª:', error);
                                if (typeof showNotification === 'function') {
                                    showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª', 'error');
                                }
                            }
                        } else {
                            console.error('âŒ showTechnicianRatingsModal ØºÙŠØ± Ù…ØªØ§Ø­Ø©');
                            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„
                            setTimeout(() => {
                                if (typeof window.showTechnicianRatingsModal === 'function') {
                                    window.showTechnicianRatingsModal(technicianId, technicianName);
                                } else {
                                    if (typeof showNotification === 'function') {
                                        showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.', 'error');
                                    }
                                }
                            }, 100);
                        }
                    }
                };
                
                // Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø¬Ø¹ Ù„Ø¥Ø²Ø§Ù„ØªÙ‡ Ù„Ø§Ø­Ù‚Ø§Ù‹
                grid._technicianCardHandler = technicianCardHandler;
                
                // Ø¥Ø¶Ø§ÙØ© event listener
                grid.addEventListener('click', technicianCardHandler);
                
            } catch (error) {
                console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ÙÙ†ÙŠÙŠÙ† Ù„Ù„ÙØ±Ø¹ ${branchNumber}:`, error);
                grid.innerHTML = `
                    <div class="empty-technicians">
                        <i class="bi bi-exclamation-triangle"></i>
                        <p>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙ†ÙŠÙŠÙ†</p>
                    </div>
                `;
            }
        }
        
        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù€ escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // âœ… Ø¯ÙˆØ§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
        let currentEditTechnicianId = null;
        let currentEditTechnicianName = null;
        
        function showEditTechnicianRatingModal(technicianId, technicianName, currentRating) {
            try {
                const currentUser = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
                const isOwner = currentUser && (currentUser.role === 'admin' || currentUser.is_owner === true || currentUser.is_owner === 'true');
                
                if (!isOwner) {
                    if (typeof showMessage === 'function') {
                        showMessage('Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·', 'error');
                    } else {
                        alert('Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·');
                    }
                    return;
                }
                
                currentEditTechnicianId = technicianId;
                currentEditTechnicianName = technicianName;
                
                const modal = document.getElementById('editRatingModal');
                const title = document.getElementById('editRatingModalTitle');
                const technicianIdInput = document.getElementById('editRatingTechnicianId');
                const technicianNameInput = document.getElementById('editRatingTechnicianName');
                
                if (!modal || !title) return;
                
                title.textContent = `ØªØ¹Ø¯ÙŠÙ„ ØªÙ‚ÙŠÙŠÙ…: ${escapeHtml(technicianName)}`;
                if (technicianIdInput) technicianIdInput.value = technicianId;
                if (technicianNameInput) technicianNameInput.value = technicianName;
                
                // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
                const initialRating = Math.round(currentRating) || 0;
                setEditRating(initialRating);
                
                // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£ÙˆÙ„ÙŠ
                const ratingDisplay = document.getElementById('ratingValueDisplay');
                if (ratingDisplay) {
                    ratingDisplay.textContent = initialRating;
                }
                
                // âœ… Ø¥ØµÙ„Ø§Ø­: Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ CSS Ø¨Ø´ÙƒÙ„ Ù‚Ø³Ø±ÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯
                setTimeout(() => {
                    const stylesheet = document.getElementById('main-stylesheet');
                    if (stylesheet) {
                        const href = stylesheet.href.split('?')[0];
                        const newHref = href + '?v=' + (window.APP_VERSION || Date.now()) + '&t=' + Date.now() + '&force=' + Date.now();
                        if (stylesheet.href !== newHref) {
                            stylesheet.href = newHref;
                            console.log('ğŸ”„ [Cache Bust] ØªÙ… ØªØ­Ø¯ÙŠØ« CSS Ø¹Ù†Ø¯ ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:', newHref);
                        }
                    }
                }, 100);
                
                modal.style.display = 'flex';
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ modal ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:', error);
                if (typeof showMessage === 'function') {
                    showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„', 'error');
                }
            }
        }
        
        function closeEditTechnicianRatingModal() {
            const modal = document.getElementById('editRatingModal');
            if (modal) {
                modal.style.display = 'none';
            }
            currentEditTechnicianId = null;
            currentEditTechnicianName = null;
        }
        
        function setEditRating(rating) {
            try {
                const stars = document.querySelectorAll('#editRatingStars .star-edit');
                const ratingInput = document.getElementById('editRatingValue');
                const errorMsg = document.getElementById('editRatingError');
                
                if (!stars || !ratingInput) return;
                
                // Ø§Ù„Ù†Ø¬ÙˆÙ… Ø§Ù„Ø¢Ù† Ù…Ø±ØªØ¨Ø© Ù…Ù† 5 Ø¥Ù„Ù‰ 1 (RTL)
                stars.forEach((star) => {
                    const starRating = parseInt(star.getAttribute('data-rating'));
                    if (starRating <= rating) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });
                
                ratingInput.value = rating;
                
                // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
                const ratingDisplay = document.getElementById('ratingValueDisplay');
                if (ratingDisplay) {
                    ratingDisplay.textContent = rating;
                }
                
                if (errorMsg) {
                    errorMsg.style.display = 'none';
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:', error);
            }
        }
        
        async function saveRatingEdit(event) {
            event.preventDefault();
            
            try {
                const rating = parseInt(document.getElementById('editRatingValue').value);
                const note = document.getElementById('editRatingNote').value.trim();
                
                if (!rating || rating < 1 || rating > 5) {
                    document.getElementById('editRatingError').style.display = 'block';
                    return;
                }
                
                if (!currentEditTechnicianId) {
                    if (typeof showMessage === 'function') {
                        showMessage('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙÙ†ÙŠ', 'error');
                    }
                    return;
                }
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
                if (window.loadingOverlay && typeof window.loadingOverlay.show === 'function') {
                    window.loadingOverlay.show();
                }
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ API
                const result = await API.request('technician-ratings.php', 'POST', {
                    technician_id: currentEditTechnicianId,
                    rating: rating,
                    note: note,
                    action: 'update_manual'
                });
                
                // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
                if (window.loadingOverlay && typeof window.loadingOverlay.hide === 'function') {
                    window.loadingOverlay.hide();
                }
                
                if (result && result.success) {
                    if (typeof showMessage === 'function') {
                        showMessage('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­');
                    }
                    closeEditTechnicianRatingModal();
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠÙŠÙ†
                    const branchId = getCurrentBranchId(1) || getCurrentBranchId(2);
                    const branchNumber = getCurrentBranchId(1) ? 1 : 2;
                    if (branchId) {
                        await loadTechnicians(branchId, branchNumber);
                    }
                } else {
                    if (typeof showMessage === 'function') {
                        showMessage(result?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…', 'error');
                    }
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:', error);
                if (window.loadingOverlay && typeof window.loadingOverlay.hide === 'function') {
                    window.loadingOverlay.hide();
                }
                if (typeof showMessage === 'function') {
                    showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…', 'error');
                }
            }
        }
        
        // ØªØµØ¯ÙŠØ± Ø§Ù„Ø¯ÙˆØ§Ù„
        window.showEditTechnicianRatingModal = showEditTechnicianRatingModal;
        window.closeEditTechnicianRatingModal = closeEditTechnicianRatingModal;
        window.setEditRating = setEditRating;
        window.saveRatingEdit = saveRatingEdit;
        window.loadTechnicians = loadTechnicians;
        window.getCurrentBranchId = getCurrentBranchId;
        
        function displayCurrentRepairs(repairs, branchNumber = 1) {
            const tbody = document.getElementById(`currentRepairsBody${branchNumber}`);
            if (!tbody) {
                console.warn(`currentRepairsBody${branchNumber} element not found`);
                return;
            }
            
            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (!repairs || !Array.isArray(repairs) || repairs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: var(--text-light);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø­Ø§Ù„ÙŠØ©</td></tr>';
                    return;
                }
                
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØªØ§Ø­Ø© Ø£Ùˆ fallback
                const formatDateFunc = typeof formatDate === 'function' ? formatDate : (date) => {
                    if (!date) return '-';
                    try {
                        return new Date(date).toLocaleDateString('ar-EG', { timeZone: 'Africa/Cairo' });
                    } catch (e) {
                        return '-';
                    }
                };
                const getStatusColorFunc = typeof getStatusColor === 'function' ? getStatusColor : (status) => {
                    const colors = {
                        'pending': '#FFA500',
                        'in_progress': '#2196F3',
                        'ready': '#4CAF50',
                        'delivered': '#4CAF50',
                        'cancelled': '#f44336'
                    };
                    return colors[status] || '#999';
                };
                const getStatusTextFunc = typeof getStatusText === 'function' ? getStatusText : (status) => {
                    const statuses = {
                        'pending': 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
                        'in_progress': 'Ù‚ÙŠØ¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­',
                        'ready': 'Ø¬Ø§Ù‡Ø²',
                        'delivered': 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…',
                        'cancelled': 'Ù…Ù„ØºÙŠ'
                    };
                    return statuses[status] || status || '-';
                };
                
                // Ø¨Ù†Ø§Ø¡ HTML Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
                const rows = repairs.slice(0, 10)
                    .filter(repair => repair && typeof repair === 'object')
                    .map(repair => {
                        try {
                            const repairNumber = (repair.repair_number || '-').toString().trim();
                            const customerName = (repair.customer_name || '-').toString().trim();
                            const deviceType = (repair.device_type || '').toString().trim();
                            const deviceModel = (repair.device_model || '').toString().trim();
                            const deviceInfo = (deviceType + ' ' + deviceModel).trim() || '-';
                            const status = repair.status || '';
                            const statusColor = getStatusColorFunc(status);
                            const statusText = getStatusTextFunc(status);
                            const date = formatDateFunc(repair.created_at || repair.created_date);
                            
                            return `
                                <tr>
                                    <td>${repairNumber}</td>
                                    <td>${customerName}</td>
                                    <td>${deviceInfo}</td>
                                    <td><span class="status-badge" style="background: ${statusColor}">${statusText}</span></td>
                                    <td>${date}</td>
                                </tr>
                            `;
                        } catch (rowError) {
                            console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© ØµÙ:', rowError, repair);
                            return '';
                        }
                    })
                    .filter(row => row && row.trim().length > 0);
                
                if (rows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: var(--text-light);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø­Ø§Ù„ÙŠØ©</td></tr>';
                } else {
                    tbody.innerHTML = rows.join('');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª:', error);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: var(--danger-color);">Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function showNotifications() {
            showMessage('Ù‚Ø±ÙŠØ¨Ø§Ù‹: Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', 'info');
        }

        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªÙ†Ù‚Ù„Ø©
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const mobileMenuBtn = document.getElementById('mobileMenuBtn') || document.querySelector('.btn-menu');
            
            if (!sidebar || !mobileMenuBtn) return;
            
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                mobileMenuBtn.innerHTML = '<i class="bi bi-list"></i>';
            } else {
                sidebar.classList.add('open');
                mobileMenuBtn.innerHTML = '<i class="bi bi-x"></i>';
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ navbar Ø§Ù„Ø¹Ø§Ø¦Ù… Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØªØ¨ÙˆÙŠØ¨
        function updateMobileNavbar(activeSection) {
            const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
            mobileNavItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('href') === '#' + activeSection) {
                    item.classList.add('active');
                }
            });
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const mobileMenuBtn = document.getElementById('mobileMenuBtn') || document.querySelector('.btn-menu');
            
            if (!sidebar || !mobileMenuBtn) return;
            
            if (window.innerWidth <= 575.98) {
                if (!sidebar.contains(event.target) && !mobileMenuBtn.contains(event.target)) {
                    sidebar.classList.remove('open');
                    if (mobileMenuBtn) {
                        mobileMenuBtn.innerHTML = '<i class="bi bi-list"></i>';
                    }
                }
            }
        });

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø©
        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('sidebar');
            const mobileMenuBtn = document.getElementById('mobileMenuBtn') || document.querySelector('.btn-menu');
            
            if (!sidebar || !mobileMenuBtn) return;
            
            if (window.innerWidth > 575.98) {
                sidebar.classList.remove('open');
                mobileMenuBtn.innerHTML = '<i class="bi bi-list"></i>';
            }
        });

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Ù…Ø«Ù„ Ø§Ù„Ø´Ø§Øª)
        let notifications = [];
        
        // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ dashboard
        function addDashboardNotification(notification) {
            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø±
                const existingIndex = notifications.findIndex(n => n.id === notification.id);
                if (existingIndex !== -1) {
                    console.log('âš ï¸ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„:', notification.id);
                    return;
                }
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
                notifications.unshift(notification);
                
                // Ø­ÙØ¸ ÙÙ‚Ø· Ø¢Ø®Ø± 50 Ø¥Ø´Ø¹Ø§Ø±
                notifications = notifications.slice(0, 50);
                
                // Ø­ÙØ¸ ÙÙŠ localStorage
                try {
                    localStorage.setItem('chat_notifications', JSON.stringify(notifications));
                } catch (e) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:', e);
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø©
                updateNotificationBadge();
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ÙØªÙˆØ­Ø©ØŒ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
                const notificationsList = document.getElementById('notificationsList');
                if (notificationsList && notificationsList.style.display !== 'none') {
                    renderNotificationsList();
                }
                
                console.log('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¥Ù„Ù‰ dashboard:', notification.id);
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¥Ù„Ù‰ dashboard:', error);
            }
        }
        
        // ØªØµØ¯ÙŠØ± Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù† global-notifications.js
        window.addDashboardNotification = addDashboardNotification;
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† localStorage Ù…Ø¹ Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
        function loadNotifications() {
            try {
                const stored = localStorage.getItem('chat_notifications');
                if (stored) {
                    const allNotifications = JSON.parse(stored);
                    const deleted = getDeletedNotifications();
                    
                    // ØªØµÙÙŠØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
                    notifications = allNotifications.filter(n => !deleted.includes(n.id));
                    
                    // Ø¥Ø°Ø§ ØªÙ…Øª ØªØµÙÙŠØ© Ø¥Ø´Ø¹Ø§Ø±Ø§ØªØŒ Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
                    if (notifications.length !== allNotifications.length) {
                        localStorage.setItem('chat_notifications', JSON.stringify(notifications));
                    }
                }
            } catch (e) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:', e);
                notifications = [];
            }
            updateNotificationBadge();
        }
        
        function toggleNotificationsList() {
            const notificationsList = document.getElementById('notificationsList');
            if (!notificationsList) return;
            
            const isVisible = notificationsList.style.display !== 'none';
            notificationsList.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                renderNotificationsList();
            }
        }
        
        function renderNotificationsList() {
            const notificationsList = document.getElementById('notificationsList');
            if (!notificationsList) return;
            
            const list = notificationsList.querySelector('.notifications-items');
            if (!list) return;
            
            list.innerHTML = '';
            
            // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… - Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹ (Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª)
            const controlButtons = document.createElement('div');
            controlButtons.style.cssText = 'display: flex; gap: 10px; padding: 10px 15px; border-bottom: 1px solid var(--border-color); background: var(--light-bg); flex-wrap: wrap;';
            
            // Ø²Ø± "Ø­Ø°Ù Ø§Ù„ÙƒÙ„"
            const deleteAllBtn = document.createElement('button');
            deleteAllBtn.textContent = 'Ø­Ø°Ù Ø§Ù„ÙƒÙ„';
            deleteAllBtn.style.cssText = 'flex: 1; min-width: 150px; padding: 10px 15px; background: var(--danger-color); color: var(--white); border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;';
            // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            if (notifications.length === 0) {
                deleteAllBtn.disabled = true;
                deleteAllBtn.style.opacity = '0.5';
                deleteAllBtn.style.cursor = 'not-allowed';
            } else {
                deleteAllBtn.disabled = false;
                deleteAllBtn.style.opacity = '1';
                deleteAllBtn.style.cursor = 'pointer';
            }
            deleteAllBtn.onmouseenter = function() {
                if (!this.disabled) {
                    this.style.background = '#D32F2F';
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 4px 12px rgba(244, 67, 54, 0.3)';
                }
            };
            deleteAllBtn.onmouseleave = function() {
                if (!this.disabled) {
                    this.style.background = 'var(--danger-color)';
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'none';
                }
            };
            deleteAllBtn.onclick = () => {
                if (notifications.length === 0) {
                    return; // Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¦Ø§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                }
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§ØªØŸ')) {
                    deleteAllNotifications();
                }
            };
            controlButtons.appendChild(deleteAllBtn);
            
            // Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ list
            list.appendChild(controlButtons);
            
            // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¥Ø´Ø¹Ø§Ø±Ø§ØªØŒ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø©
            if (notifications.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.style.cssText = 'text-align: center; color: var(--text-light); padding: 40px 20px; font-size: 16px;';
                emptyMessage.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª';
                list.appendChild(emptyMessage);
                updateNotificationBadge();
                return;
            }
            
            const fragment = document.createDocumentFragment();
            
            notifications.forEach(notification => {
                const item = document.createElement('div');
                item.className = 'notification-item';
                item.style.cssText = 'display: flex; align-items: center; gap: 10px; padding: 12px 15px; border-bottom: 1px solid var(--border-color); transition: background 0.2s;';
                
                const content = document.createElement('div');
                content.className = 'notification-content';
                content.style.cssText = 'flex: 1; min-width: 0;';
                
                const username = document.createElement('div');
                username.className = 'notification-username';
                username.style.cssText = 'font-size: 13px; font-weight: 600; color: var(--text-dark); margin-bottom: 4px;';
                username.textContent = notification.username || 'Ù…Ø³ØªØ®Ø¯Ù…';
                
                const message = document.createElement('div');
                message.className = 'notification-message';
                message.style.cssText = 'font-size: 12px; color: var(--text-light); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-bottom: 4px;';
                message.textContent = notification.message || '';
                
                const time = document.createElement('div');
                time.className = 'notification-time';
                time.style.cssText = 'font-size: 11px; color: var(--text-light); opacity: 0.7;';
                
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… formatTime Ù…Ù† chat.js Ø£Ùˆ formatDateTime Ù…Ù† utils.js
                if (typeof formatTime === 'function') {
                    time.textContent = formatTime(notification.timestamp);
                } else if (typeof formatDateTime === 'function') {
                    time.textContent = formatDateTime(notification.timestamp);
                } else {
                    time.textContent = new Date(notification.timestamp).toLocaleString('ar-EG', { timeZone: 'Africa/Cairo' });
                }
                
                content.appendChild(username);
                content.appendChild(message);
                content.appendChild(time);
                
                item.appendChild(content);
                
                // Ø²Ø± Ø§Ù„Ø­Ø°Ù
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'notification-delete';
                deleteBtn.style.cssText = 'background: none; border: none; color: var(--text-light); cursor: pointer; padding: 5px; font-size: 16px; opacity: 0.5; transition: opacity 0.2s;';
                deleteBtn.innerHTML = 'Ã—';
                deleteBtn.onclick = () => deleteNotification(notification.id);
                deleteBtn.onmouseenter = () => deleteBtn.style.opacity = '1';
                deleteBtn.onmouseleave = () => deleteBtn.style.opacity = '0.5';
                
                item.appendChild(deleteBtn);
                fragment.appendChild(item);
            });
            
            list.appendChild(fragment);
            updateNotificationBadge();
        }
        
        // Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
        function getDeletedNotifications() {
            try {
                const deleted = localStorage.getItem('deleted_notifications');
                return deleted ? JSON.parse(deleted) : [];
            } catch (e) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©:', e);
                return [];
            }
        }
        
        // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø± Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
        function addToDeletedNotifications(notificationId) {
            try {
                const deleted = getDeletedNotifications();
                if (!deleted.includes(notificationId)) {
                    deleted.push(notificationId);
                    // Ø­ÙØ¸ ÙÙ‚Ø· Ø¢Ø®Ø± 1000 Ø¥Ø´Ø¹Ø§Ø± Ù…Ø­Ø°ÙˆÙ (Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù…ØªÙ„Ø§Ø¡ localStorage)
                    const trimmedDeleted = deleted.slice(-1000);
                    localStorage.setItem('deleted_notifications', JSON.stringify(trimmedDeleted));
                }
            } catch (e) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø­Ø°ÙˆÙ:', e);
            }
        }
        
        function deleteNotification(notificationId) {
            // Ø¥Ø¶Ø§ÙØ© ID Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù
            addToDeletedNotifications(notificationId);
            
            notifications = notifications.filter(n => n.id !== notificationId);
            
            try {
                localStorage.setItem('chat_notifications', JSON.stringify(notifications));
            } catch (e) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:', e);
            }
            
            renderNotificationsList();
        }
        
        // Ø¯Ø§Ù„Ø© Ù„Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function deleteAllNotifications() {
            try {
                // Ø¥Ø¶Ø§ÙØ© Ø¬Ù…ÙŠØ¹ IDs Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
                notifications.forEach(notification => {
                    addToDeletedNotifications(notification.id);
                });
                
                notifications = [];
                localStorage.setItem('chat_notifications', JSON.stringify([]));
                updateNotificationBadge();
                renderNotificationsList();
                
                // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
                if (typeof showMessage === 'function') {
                    showMessage('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', 'success');
                } else {
                    alert('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
                }
            } catch (e) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:', e);
                if (typeof showMessage === 'function') {
                    showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', 'error');
                } else {
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
                }
            }
        }
        
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                if (notifications.length > 0) {
                    badge.textContent = notifications.length > 99 ? '99+' : notifications.length;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadNotifications);
        } else {
            loadNotifications();
        }
        
        // Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
        document.addEventListener('click', function(event) {
            const notificationsList = document.getElementById('notificationsList');
            const notificationsBtn = document.getElementById('notificationsBtn');
            
            if (!notificationsList || !notificationsBtn) return;
            
            if (!notificationsList.contains(event.target) && !notificationsBtn.contains(event.target)) {
                notificationsList.style.display = 'none';
            }
        });

    </script>
    <!-- Fallback script Ù„ØªØ­Ù…ÙŠÙ„ CSS Ø¨Ø´ÙƒÙ„ async Ù„Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© -->
    <script>
        /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
        (function(w){
            "use strict";
            var loadCSS = function(href, before, media, attributes){
                var doc = w.document;
                var ss = doc.createElement("link");
                var ref;
                if(before){
                    ref = before;
                } else {
                    var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
                    ref = refs[refs.length - 1];
                }
                var sheets = doc.styleSheets;
                ss.rel = "stylesheet";
                ss.href = href;
                if(attributes){
                    for(var attributeName in attributes){
                        if(attributes.hasOwnProperty(attributeName)){
                            ss.setAttribute(attributeName, attributes[attributeName]);
                        }
                    }
                }
                ss.media = "only x";
                function ready(cb){
                    if(doc.body){
                        return cb();
                    }
                    setTimeout(function(){
                        ready(cb);
                    });
                }
                ready(function(){
                    ref.parentNode.insertBefore(ss, (before ? ref : ref.nextSibling));
                });
                var onloadcssdefined = function(cb){
                    var resolvedHref = ss.href;
                    var i = sheets.length;
                    while(i--){
                        if(sheets[i].href === resolvedHref){
                            return cb();
                        }
                    }
                    setTimeout(function(){
                        onloadcssdefined(cb);
                    });
                };
                function loadCB(){
                    if(ss.addEventListener){
                        ss.removeEventListener("load", loadCB);
                    }
                    ss.media = media || "all";
                }
                if(ss.addEventListener){
                    ss.addEventListener("load", loadCB);
                }
                ss.onloadcssdefined = onloadcssdefined;
                onloadcssdefined(loadCB);
                return ss;
            };
            if(typeof exports !== "undefined"){
                exports.loadCSS = loadCSS;
            }
            else {
                w.loadCSS = loadCSS;
            }
        }(typeof global !== "undefined" ? global : this));
    </script>
    <!-- Modal ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… -->
    <div id="editRatingModal" class="modal technician-rating-modal" style="display: none;" dir="rtl">
        <div class="modal-content modal-sm technician-rating-modal-content">
            <div class="modal-header technician-rating-header">
                <div class="technician-rating-header-content">
                    <div class="technician-rating-icon">
                        <i class="bi bi-star-fill"></i>
                    </div>
                    <h3 id="editRatingModalTitle">ØªØ¹Ø¯ÙŠÙ„ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙÙ†ÙŠ</h3>
                </div>
                <button onclick="closeEditTechnicianRatingModal()" class="btn-close technician-rating-close" title="Ø¥ØºÙ„Ø§Ù‚">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <form id="editRatingForm" onsubmit="saveRatingEdit(event)">
                <input type="hidden" id="editRatingTechnicianId">
                <input type="hidden" id="editRatingTechnicianName">
                
                <div class="technician-rating-body">
                    <div class="form-group technician-rating-group">
                        <label class="technician-rating-label">
                            <i class="bi bi-star"></i>
                            Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ (1-5) *
                        </label>
                        <div class="star-rating-edit-container">
                            <div class="star-rating-edit" id="editRatingStars" dir="rtl">
                                <span class="star-edit" data-rating="5" onclick="setEditRating(5)" title="5 Ù†Ø¬ÙˆÙ…">
                                    <i class="bi bi-star"></i>
                                </span>
                                <span class="star-edit" data-rating="4" onclick="setEditRating(4)" title="4 Ù†Ø¬ÙˆÙ…">
                                    <i class="bi bi-star"></i>
                                </span>
                                <span class="star-edit" data-rating="3" onclick="setEditRating(3)" title="3 Ù†Ø¬ÙˆÙ…">
                                    <i class="bi bi-star"></i>
                                </span>
                                <span class="star-edit" data-rating="2" onclick="setEditRating(2)" title="2 Ù†Ø¬ÙˆÙ…">
                                    <i class="bi bi-star"></i>
                                </span>
                                <span class="star-edit" data-rating="1" onclick="setEditRating(1)" title="1 Ù†Ø¬Ù…Ø©">
                                    <i class="bi bi-star"></i>
                                </span>
                            </div>
                            <div class="star-rating-display" id="starRatingDisplay">
                                <span class="rating-value" id="ratingValueDisplay">0</span>
                                <span class="rating-max">/ 5</span>
                            </div>
                        </div>
                        <input type="hidden" id="editRatingValue" name="rating" value="0" required>
                        <span class="rating-error" id="editRatingError" style="display: none;">
                            <i class="bi bi-exclamation-circle"></i>
                            ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªÙ‚ÙŠÙŠÙ…
                        </span>
                    </div>
                    
                    <div class="form-group technician-note-group">
                        <label for="editRatingNote" class="technician-rating-label">
                            <i class="bi bi-chat-left-text"></i>
                            Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                        </label>
                        <textarea 
                            id="editRatingNote" 
                            name="note" 
                            rows="4" 
                            placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø© Ø­ÙˆÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ù…Ø«Ø§Ù„: Ø£Ø¯Ø§Ø¡ Ù…Ù…ØªØ§Ø²ØŒ ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ† ÙÙŠ Ø§Ù„ØªÙˆØ§ØµÙ„...)"
                            class="technician-note-textarea"></textarea>
                    </div>
                </div>
                
                <div class="modal-footer technician-rating-footer">
                    <button type="button" onclick="closeEditTechnicianRatingModal()" class="btn btn-secondary">
                        <i class="bi bi-x-circle"></i>
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i>
                        Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø± -->
    <div id="versionModal" class="modal" style="display: none;" dir="rtl">
        <div class="modal-content version-modal-content" style="max-width: 650px;">
            <div class="modal-header version-modal-header">
                <h3>
                    <i class="bi bi-rocket-takeoff"></i>
                    Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø±
                </h3>
                <button onclick="closeVersionModal()" class="btn-close" title="Ø¥ØºÙ„Ø§Ù‚">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body version-modal-body" id="versionModalBody">
                <div style="text-align: center; padding: 40px 20px;">
                    <i class="bi bi-arrow-repeat" style="font-size: 2.5em; color: var(--primary-color); margin-bottom: 20px; display: block;"></i>
                    <p style="margin-top: 15px; color: var(--text-light); font-size: 1.05em;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø±...</p>
                </div>
            </div>
            <div class="modal-footer" style="padding: 20px 30px; border-top: 1px solid var(--border-color); background: var(--white);">
                <button onclick="closeVersionModal()" class="btn btn-primary" style="padding: 12px 30px; font-size: 1em; border-radius: 8px; font-weight: 500;">
                    <i class="bi bi-check-circle"></i>
                    Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>

    <!-- Modal ØªÙ‚ÙŠÙŠÙ…Ø§Øª ÙˆØ¢Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù„Ù„ÙÙ†ÙŠ -->
    <div id="technicianRatingsModal" class="modal" style="display: none;" dir="rtl">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="technicianRatingsModalTitle">
                    <i class="bi bi-star-fill"></i>
                    ØªÙ‚ÙŠÙŠÙ…Ø§Øª ÙˆØ¢Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
                </h3>
                <button onclick="closeTechnicianRatingsModal()" class="btn-close" title="Ø¥ØºÙ„Ø§Ù‚">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body" id="technicianRatingsModalBody" style="max-height: 70vh; overflow-y: auto;">
                <div style="text-align: center; padding: 40px 20px;">
                    <i class="bi bi-arrow-repeat" style="font-size: 2.5em; color: var(--primary-color); margin-bottom: 20px; display: block; animation: spin 1s linear infinite;"></i>
                    <p style="margin-top: 15px; color: var(--text-light); font-size: 1.05em;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª...</p>
                </div>
            </div>
            <div class="modal-footer" style="padding: 20px 30px; border-top: 1px solid var(--border-color); background: var(--white);">
                <button onclick="closeTechnicianRatingsModal()" class="btn btn-primary" style="padding: 12px 30px; font-size: 1em; border-radius: 8px; font-weight: 500;">
                    <i class="bi bi-check-circle"></i>
                    Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>

    <script>
        // Ø¹Ø±Ø¶ modal ØªÙ‚ÙŠÙŠÙ…Ø§Øª ÙˆØ¢Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù„Ù„ÙÙ†ÙŠ
        async function showTechnicianRatingsModal(technicianId, technicianName) {
            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
                if (!technicianId) {
                    console.error('âŒ technicianId ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
                    return;
                }
                
                // Ø¥Ù†Ø´Ø§Ø¡ modal Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                let modal = document.getElementById('technicianRatingsModal');
                if (!modal) {
                    // Ø¥Ù†Ø´Ø§Ø¡ modal Ø¬Ø¯ÙŠØ¯
                    modal = document.createElement('div');
                    modal.id = 'technicianRatingsModal';
                    modal.className = 'modal';
                    modal.style.display = 'none';
                    modal.setAttribute('dir', 'rtl');
                    modal.innerHTML = `
                        <div class="modal-content ratings-modal-content-wrapper">
                            <div class="modal-header">
                                <h3 id="technicianRatingsModalTitle">
                                    <i class="bi bi-star-fill"></i>
                                    ØªÙ‚ÙŠÙŠÙ…Ø§Øª ÙˆØ¢Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
                                </h3>
                                <button onclick="closeTechnicianRatingsModal()" class="btn-close" title="Ø¥ØºÙ„Ø§Ù‚">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            <div class="modal-body" id="technicianRatingsModalBody">
                                <div style="text-align: center; padding: 40px 20px;">
                                    <i class="bi bi-arrow-repeat" style="font-size: 2.5em; color: var(--primary-color); margin-bottom: 20px; display: block; animation: spin 1s linear infinite;"></i>
                                    <p style="margin-top: 15px; color: var(--text-light); font-size: 1.05em;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª...</p>
                                </div>
                            </div>
                            <div class="modal-footer" style="padding: 20px 30px; border-top: 1px solid var(--border-color); background: var(--white);">
                                <button onclick="closeTechnicianRatingsModal()" class="btn btn-primary" style="padding: 12px 30px; font-size: 1em; border-radius: 8px; font-weight: 500;">
                                    <i class="bi bi-check-circle"></i>
                                    Ø¥ØºÙ„Ø§Ù‚
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                
                const title = document.getElementById('technicianRatingsModalTitle');
                const body = document.getElementById('technicianRatingsModalBody');
                
                if (!modal || !title || !body) {
                    console.error('âŒ Ø¹Ù†Ø§ØµØ± modal ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    return;
                }
                
                title.innerHTML = `<i class="bi bi-star-fill"></i> ØªÙ‚ÙŠÙŠÙ…Ø§Øª ÙˆØ¢Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - ${escapeHtml(technicianName)}`;
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
                body.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <i class="bi bi-arrow-repeat" style="font-size: 2.5em; color: var(--primary-color); margin-bottom: 20px; display: block; animation: spin 1s linear infinite;"></i>
                        <p style="margin-top: 15px; color: var(--text-light); font-size: 1.05em;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª...</p>
                    </div>
                `;
                
                modal.style.display = 'flex';
                
                // Ø¬Ù„Ø¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© Ù…Ù† API (Ù…Ø¹ detailed=true)
                try {
                    const result = await API.request(`repair-ratings.php?technician_id=${encodeURIComponent(technicianId)}&detailed=true`, 'GET');
                    
                    if (!result || !result.success) {
                        throw new Error(result?.message || 'ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª');
                    }
                    
                    const ratings = result.data || [];
                    
                    if (ratings.length === 0) {
                        body.innerHTML = `
                            <div style="text-align: center; padding: 60px 20px;">
                                <i class="bi bi-inbox" style="font-size: 4em; color: var(--text-light); margin-bottom: 20px; display: block;"></i>
                                <p style="color: var(--text-light); font-size: 1.1em; margin: 0;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ù…Ø­Ø³Ù‘Ù†
                    let ratingsHTML = `
                        <div class="ratings-table-container">
                            <table class="ratings-table">
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                        <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                                        <th>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØµÙŠØ§Ù†Ø©</th>
                                        <th>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙÙ†ÙŠ</th>
                                        <th>Ø±Ø£ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    ratings.forEach((rating, index) => {
                        const repairRating = parseInt(rating.repair_rating || 0);
                        const technicianRating = parseInt(rating.technician_rating || 0);
                        const comment = rating.comment || '';
                        const repairNumber = rating.repair_number || '';
                        const customerName = rating.customer_name || 'Ø¹Ù…ÙŠÙ„';
                        const createdAt = rating.created_at || '';
                        
                        // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Ø¬ÙˆÙ… Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØµÙŠØ§Ù†Ø©
                        let repairStarsHTML = '';
                        for (let i = 1; i <= 5; i++) {
                            const isFilled = i <= repairRating;
                            repairStarsHTML += `<span class="star ${isFilled ? '' : 'empty'}"><i class="bi bi-star${isFilled ? '-fill' : ''}"></i></span>`;
                        }
                        
                        // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Ø¬ÙˆÙ… Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙÙ†ÙŠ
                        let techStarsHTML = '';
                        for (let i = 1; i <= 5; i++) {
                            const isFilled = i <= technicianRating;
                            techStarsHTML += `<span class="star ${isFilled ? '' : 'empty'}"><i class="bi bi-star${isFilled ? '-fill' : ''}"></i></span>`;
                        }
                        
                        ratingsHTML += `
                            <tr>
                                <td class="customer-name-cell">
                                    <div class="customer-name">${escapeHtml(customerName)}</div>
                                </td>
                                <td class="repair-number-cell">
                                    <span class="repair-number-badge">#${escapeHtml(repairNumber)}</span>
                                </td>
                                <td class="rating-cell">
                                    <div class="rating-display">
                                        <div class="rating-stars-inline">${repairStarsHTML}</div>
                                        <span class="rating-number-badge">${repairRating}/5</span>
                                    </div>
                                </td>
                                <td class="rating-cell">
                                    <div class="rating-display">
                                        <div class="rating-stars-inline">${techStarsHTML}</div>
                                        <span class="rating-number-badge">${technicianRating}/5</span>
                                    </div>
                                </td>
                                <td class="comment-cell">
                                    ${comment ? `
                                        <div class="comment-content" title="${escapeHtml(comment)}">
                                            <i class="bi bi-chat-left-text"></i>
                                            ${escapeHtml(comment.length > 50 ? comment.substring(0, 50) + '...' : comment)}
                                        </div>
                                    ` : '<span class="no-comment">-</span>'}
                                </td>
                                <td class="date-cell">
                                    ${createdAt ? `<span class="date-text"><i class="bi bi-calendar"></i> ${formatArabicDate(createdAt)}</span>` : '-'}
                                </td>
                            </tr>
                        `;
                    });
                    
                    ratingsHTML += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    ratingsHTML += '</div>';
                    body.innerHTML = ratingsHTML;
                    
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª:', error);
                    body.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <i class="bi bi-exclamation-triangle" style="font-size: 4em; color: var(--danger-color); margin-bottom: 20px; display: block;"></i>
                            <p style="color: var(--danger-color); font-size: 1.1em; margin: 0;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</p>
                            <p style="color: var(--text-light); font-size: 0.9em; margin-top: 10px;">${escapeHtml(error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')}</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ modal Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª:', error);
                if (typeof showMessage === 'function') {
                    showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª', 'error');
                }
            }
        }
        
        function closeTechnicianRatingsModal() {
            const modal = document.getElementById('technicianRatingsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // âœ… Ø¥Ø¶Ø§ÙØ© event listener Ù„Ø¥ØºÙ„Ø§Ù‚ modal Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('technicianRatingsModal');
            if (modal && modal.style.display === 'flex') {
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent && !modalContent.contains(e.target) && e.target === modal) {
                    closeTechnicianRatingsModal();
                }
            }
        });
        
        // âœ… Ø¥Ø¶Ø§ÙØ© event listener Ù„Ø¥ØºÙ„Ø§Ù‚ modal Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('technicianRatingsModal');
                if (modal && modal.style.display === 'flex') {
                    closeTechnicianRatingsModal();
                }
            }
        });
        
        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
        function formatArabicDate(dateString) {
            try {
                if (!dateString) return '';
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                const months = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
                const day = date.getDate();
                const month = months[date.getMonth()];
                const year = date.getFullYear();
                return `${day} ${month} ${year}`;
            } catch (error) {
                return dateString;
            }
        }
        
        // ØªØµØ¯ÙŠØ± Ø§Ù„Ø¯ÙˆØ§Ù„
        window.showTechnicianRatingsModal = showTechnicianRatingsModal;
        window.closeTechnicianRatingsModal = closeTechnicianRatingsModal;

        // Ø¹Ø±Ø¶ modal Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø±
        async function showVersionModal() {
            try {
                const modal = document.getElementById('versionModal');
                const modalBody = document.getElementById('versionModalBody');
                
                if (!modal || !modalBody) {
                    console.error('âŒ Modal elements not found');
                    return;
                }
                
                // Ø¥Ø¸Ù‡Ø§Ø± modal
                modal.style.display = 'flex';
                
                // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø±
                try {
                    const response = await fetch('version.json');
                    if (!response.ok) {
                        throw new Error('Failed to fetch version.json');
                    }
                    
                    const versionData = await response.json();
                    renderVersionInfo(versionData, modalBody);
                } catch (error) {
                    console.error('âŒ Error loading version data:', error);
                    modalBody.innerHTML = `
                        <div class="version-empty-state" style="color: var(--danger-color);">
                            <i class="bi bi-exclamation-circle"></i>
                            <p style="font-size: 1.1em; font-weight: 500; margin-bottom: 10px;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø±</p>
                            <p style="font-size: 0.9em; color: var(--text-light);">${error.message}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('âŒ Error showing version modal:', error);
            }
        }
        
        // Ø¥ØºÙ„Ø§Ù‚ modal Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø±
        function closeVersionModal() {
            const modal = document.getElementById('versionModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø±
        function renderVersionInfo(versionData, container) {
            try {
                const changelog = versionData.changelog || {};
                
                let html = '';
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø¥ØµØ¯Ø§Ø±Ø§Øª Ø§Ù„Ù€ changelog ÙˆØªØ±ØªÙŠØ¨Ù‡Ø§
                const changelogEntries = Object.keys(changelog);
                
                if (changelogEntries.length === 0) {
                    html += `
                        <div class="version-empty-state">
                            <i class="bi bi-info-circle"></i>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªÙØµÙŠÙ„ÙŠØ© Ù…ØªØ§Ø­Ø©</p>
                        </div>
                    `;
                } else {
                    // Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø¥ØµØ¯Ø§Ø±Ø§Øª Ø§Ù„Ù€ changelog
                    changelogEntries.forEach(changelogVersion => {
                        const changelogEntry = changelog[changelogVersion];
                        if (!changelogEntry) return;
                        
                        // Ø¹Ø±Ø¶ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥ØµØ¯Ø§Ø±
                        const entryDate = changelogEntry.date ? new Date(changelogEntry.date).toLocaleDateString('ar-EG', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        }) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                        
                        html += `
                            <div class="version-changelog-entry" style="margin-top: 30px; padding-top: 30px; border-top: 2px solid var(--border-color);">
                                <div class="version-entry-header" style="margin-bottom: 20px;">
                                    <h3 style="margin: 0; font-size: 1.3em; color: var(--primary-color); display: flex; align-items: center; gap: 10px;">
                                        <i class="bi bi-tag-fill"></i>
                                        Ø§Ù„Ø¥ØµØ¯Ø§Ø± ${changelogVersion}
                                    </h3>
                                    <div style="margin-top: 8px; font-size: 0.9em; color: var(--text-light); display: flex; align-items: center; gap: 5px;">
                                        <i class="bi bi-calendar3"></i>
                                        <span>${entryDate}</span>
                                    </div>
                                </div>
                        `;
                        
                        // Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                        if (changelogEntry.features && changelogEntry.features.length > 0) {
                            html += `
                                <div class="version-info-section">
                                    <h4>
                                        <i class="bi bi-star-fill" style="color: var(--success-color);"></i>
                                        Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                                    </h4>
                                    <ul class="version-list">
                                        ${changelogEntry.features.map(feature => `
                                            <li>
                                                <i class="bi bi-check-circle-fill"></i>
                                                <span>${feature}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            `;
                        }
                        
                        // Ø¹Ø±Ø¶ Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª
                        if (changelogEntry.fixes && changelogEntry.fixes.length > 0) {
                            html += `
                                <div class="version-info-section">
                                    <h4>
                                        <i class="bi bi-tools" style="color: var(--warning-color);"></i>
                                        Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª
                                    </h4>
                                    <ul class="version-list">
                                        ${changelogEntry.fixes.map(fix => `
                                            <li>
                                                <i class="bi bi-wrench-adjustable"></i>
                                                <span>${fix}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            `;
                        }
                        
                        // Ø¹Ø±Ø¶ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª
                        if (changelogEntry.improvements && changelogEntry.improvements.length > 0) {
                            html += `
                                <div class="version-info-section">
                                    <h4>
                                        <i class="bi bi-graph-up-arrow" style="color: var(--primary-color);"></i>
                                        Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª
                                    </h4>
                                    <ul class="version-list">
                                        ${changelogEntry.improvements.map(improvement => `
                                            <li>
                                                <i class="bi bi-arrow-up-circle"></i>
                                                <span>${improvement}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            `;
                        }
                        
                        html += `</div>`;
                    });
                }
                
                container.innerHTML = html;
            } catch (error) {
                console.error('âŒ Error rendering version info:', error);
                container.innerHTML = `
                    <div class="version-empty-state" style="color: var(--danger-color);">
                        <i class="bi bi-exclamation-circle"></i>
                        <p style="font-size: 1.1em; font-weight: 500; margin-bottom: 10px;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø±</p>
                        <p style="font-size: 0.9em; color: var(--text-light);">${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Ø¥ØºÙ„Ø§Ù‚ modal Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
        document.addEventListener('DOMContentLoaded', function() {
            const versionModal = document.getElementById('versionModal');
            if (versionModal) {
                versionModal.addEventListener('click', function(e) {
                    if (e.target === versionModal) {
                        closeVersionModal();
                    }
                });
            }
            
            // Ø¥ØºÙ„Ø§Ù‚ modal Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const versionModal = document.getElementById('versionModal');
                    if (versionModal && versionModal.style.display === 'flex') {
                        closeVersionModal();
                    }
                }
            });
        });
    </script>

    <!-- Floating Chat Modal JavaScript (Desktop Only) -->
    <script>
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø©
        function isDesktop() {
            return window.innerWidth >= 768;
        }

        // Ø¯ÙˆØ§Ù„ ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¹Ø§Ø¦Ù…
        function openFloatingChat() {
            if (!isDesktop()) {
                // Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ØŒ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ chat.html Ù…Ø¨Ø§Ø´Ø±Ø©
                window.location.href = 'chat.html';
                return;
            }

            const modal = document.getElementById('floatingChatModal');
            const overlay = document.getElementById('floatingChatOverlay');
            
            if (modal && overlay) {
                modal.style.display = 'flex';
                overlay.style.display = 'block';
                setTimeout(() => {
                    overlay.classList.add('active');
                }, 10);
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ iframe Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
                const iframe = document.getElementById('chatIframe');
                if (iframe) {
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ iframe Ù„Ø¶Ù…Ø§Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                    const currentSrc = iframe.src;
                    iframe.src = '';
                    setTimeout(() => {
                        iframe.src = currentSrc || 'chat.html';
                    }, 100);
                }
            }
        }

        function closeFloatingChat() {
            const modal = document.getElementById('floatingChatModal');
            const overlay = document.getElementById('floatingChatOverlay');
            
            if (modal && overlay) {
                overlay.classList.remove('active');
                setTimeout(() => {
                    modal.style.display = 'none';
                    overlay.style.display = 'none';
                }, 300);
            }
        }

        function toggleFloatingChat() {
            const modal = document.getElementById('floatingChatModal');
            if (modal && modal.style.display === 'none') {
                openFloatingChat();
            } else {
                closeFloatingChat();
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ iframe
        function refreshChatIframe() {
            const iframe = document.getElementById('chatIframe');
            const refreshBtn = document.getElementById('floatingChatRefreshBtn');
            
            if (iframe && refreshBtn) {
                // Ø¥Ø¶Ø§ÙØ© class Ù„Ù„Ù€ animation
                refreshBtn.classList.add('refreshing');
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ iframe
                const currentSrc = iframe.src;
                iframe.src = '';
                
                setTimeout(() => {
                    iframe.src = currentSrc || 'chat.html';
                    // Ø¥Ø²Ø§Ù„Ø© class Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                    setTimeout(() => {
                        refreshBtn.classList.remove('refreshing');
                    }, 1000);
                }, 100);
            }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ
        async function checkOwnerPermissions() {
            try {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† API
                if (typeof API !== 'undefined' && typeof API.request === 'function') {
                    const response = await API.request('profile.php', 'GET');
                    if (response && response.success && response.user) {
                        const user = response.user;
                        return user.role === 'admin' || user.is_owner === true || user.is_owner === 'true';
                    }
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† localStorage ÙƒØ¨Ø¯ÙŠÙ„
                try {
                    const savedUser = localStorage.getItem('currentUser');
                    if (savedUser) {
                        const user = JSON.parse(savedUser);
                        return user && (user.role === 'admin' || user.is_owner === true || user.is_owner === 'true');
                    }
                } catch (e) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† localStorage:', e);
                }
                
                return false;
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ:', error);
                return false;
            }
        }

        // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        async function updateDeleteButtonVisibility() {
            const deleteBtn = document.getElementById('floatingChatDeleteBtn');
            if (!deleteBtn) return;
            
            const isOwner = await checkOwnerPermissions();
            if (isOwner) {
                deleteBtn.style.display = 'flex';
                console.log('âœ… Ø²Ø± Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¹Ø±ÙˆØ¶ Ù„Ù„Ù…Ø§Ù„Ùƒ');
            } else {
                deleteBtn.style.display = 'none';
                console.log('ğŸ”’ Ø²Ø± Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ø®ÙÙŠ - Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ Ù…Ø§Ù„ÙƒØ§Ù‹');
            }
        }

        // ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ iframe
        function openDeleteMessagesModal() {
            const iframe = document.getElementById('chatIframe');
            if (iframe && iframe.contentWindow) {
                try {
                    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ iframe Ù„ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
                    iframe.contentWindow.postMessage({
                        type: 'openDeleteMessagesModal'
                    }, '*');
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ iframe:', error);
                    // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„ØŒ ÙŠÙ…ÙƒÙ† ÙØªØ­ ØµÙØ­Ø© chat.html Ù…Ø¨Ø§Ø´Ø±Ø©
                    alert('ÙŠØ±Ø¬Ù‰ ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø´Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„');
                }
            }
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            const chatNavLink = document.getElementById('chatNavLink');
            const closeBtn = document.getElementById('floatingChatCloseBtn');
            const refreshBtn = document.getElementById('floatingChatRefreshBtn');
            const deleteBtn = document.getElementById('floatingChatDeleteBtn');
            const overlay = document.getElementById('floatingChatOverlay');

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ ÙˆØ¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
            updateDeleteButtonVisibility();

            // ØªØ¹Ø¯ÙŠÙ„ Ø³Ù„ÙˆÙƒ Ø²Ø± Ø§Ù„Ø´Ø§Øª ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
            if (chatNavLink) {
                chatNavLink.addEventListener('click', function(e) {
                    if (isDesktop()) {
                        e.preventDefault();
                        e.stopPropagation();
                        openFloatingChat();
                        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø²Ø± Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                        setTimeout(() => {
                            updateDeleteButtonVisibility();
                        }, 500);
                    }
                    // Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ØŒ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (ÙØªØ­ chat.html) Ø³ÙŠØ¹Ù…Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                });
            }

            // Ø²Ø± Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·)
            if (deleteBtn) {
                deleteBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù‚Ø¨Ù„ Ø§Ù„ÙØªØ­
                    const isOwner = await checkOwnerPermissions();
                    if (!isOwner) {
                        alert('Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·');
                        console.warn('âš ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© ÙˆØµÙˆÙ„ ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ù‡Ø§ Ù„Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„');
                        return;
                    }
                    
                    openDeleteMessagesModal();
                });
            }

            // Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« (Refresh)
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    refreshChatIframe();
                });
            }

            // Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
            if (closeBtn) {
                closeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    closeFloatingChat();
                });
            }

            // Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Overlay
            if (overlay) {
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) {
                        closeFloatingChat();
                    }
                });
            }

            // Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('floatingChatModal');
                    if (modal && modal.style.display !== 'none') {
                        closeFloatingChat();
                    }
                }
            });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù„ÙˆÙƒ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø©
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    // Ø¥Ø°Ø§ ØªØ­ÙˆÙ„Ù†Ø§ Ù…Ù† desktop Ø¥Ù„Ù‰ mobileØŒ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                    if (!isDesktop()) {
                        closeFloatingChat();
                    }
                }, 250);
            });
        });

        // ØªØµØ¯ÙŠØ± Ø§Ù„Ø¯ÙˆØ§Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ù…
        window.openFloatingChat = openFloatingChat;
        window.closeFloatingChat = closeFloatingChat;
        window.toggleFloatingChat = toggleFloatingChat;
    </script>

    </body>
</html>


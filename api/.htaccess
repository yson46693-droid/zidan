# إعدادات خاصة بمجلد API

# تفعيل PHP - ضروري لـ LiteSpeed و Apache
AddType application/x-httpd-php .php
AddHandler application/x-httpd-php .php

# ملاحظة: إعدادات CORS والأمان يتم ضبطها من config.php ديناميكياً
# هذا يمنع التعارضات ويضمن عمل credentials بشكل صحيح

# معالجة طلبات OPTIONS (preflight) - نسخة احتياطية
# config.php يتعامل معها أيضاً، لكن نتركها للاستضافات التي قد تحتاجها
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # السماح بجميع طرق HTTP (GET, POST, PUT, DELETE, OPTIONS, PATCH)
    RewriteCond %{REQUEST_METHOD} ^(GET|POST|PUT|DELETE|OPTIONS|PATCH)$
    RewriteRule ^(.*)$ - [L]
    
    # معالجة طلبات OPTIONS بشكل خاص
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ - [R=200,L]
</IfModule>

# إعادة توجيه طلبات PUT/DELETE إلى POST للاستضافات المجانية
<IfModule mod_rewrite.c>
    RewriteCond %{REQUEST_METHOD} ^(PUT|DELETE)$
    RewriteRule ^(.*)$ $1 [L]
</IfModule>

# السماح بملفات API العامة
# استخدام صيغة متوافقة مع Apache 2.2 و 2.4+ و LiteSpeed
<IfModule mod_authz_core.c>
    # Apache 2.4+ و LiteSpeed
    <FilesMatch "\.(php)$">
        Require all granted
    </FilesMatch>
    <Files "auth.php">
        Require all granted
    </Files>
    <DirectoryMatch ".*">
        Require all granted
    </DirectoryMatch>
    # السماح بجميع الطلبات في هذا المجلد
    <Directory ".">
        Require all granted
        Options +ExecCGI +FollowSymLinks
    </Directory>
</IfModule>

<IfModule !mod_authz_core.c>
    # Apache 2.2 (fallback للخوادم القديمة)
    <FilesMatch "\.(php)$">
        Order allow,deny
        Allow from all
    </FilesMatch>
    <Files "auth.php">
        Order allow,deny
        Allow from all
    </Files>
    <DirectoryMatch ".*">
        Order allow,deny
        Allow from all
    </DirectoryMatch>
    # السماح بجميع الطلبات في هذا المجلد
    <Directory ".">
        Order allow,deny
        Allow from all
        Options +ExecCGI +FollowSymLinks
    </Directory>
</IfModule>

# قواعد خاصة لـ LiteSpeed Web Server
<IfModule LiteSpeed>
    # السماح بتنفيذ PHP
    <FilesMatch "\.(php)$">
        SetHandler lsapi
        Require all granted
    </FilesMatch>
    <Files "auth.php">
        SetHandler lsapi
        Require all granted
    </Files>
    # السماح بجميع الطلبات
    Options +ExecCGI
    Options +FollowSymLinks
    # السماح بجميع الطلبات في هذا المجلد
    <Directory ".">
        Require all granted
        Options +ExecCGI +FollowSymLinks
    </Directory>
</IfModule>

# منع عرض محتويات المجلد (الأمان)
Options -Indexes

# السماح بجميع طرق HTTP بشكل صريح - حل مشكلة 403
<IfModule mod_headers.c>
    # إزالة أي قيود على طرق HTTP
    Header unset X-Requested-With
</IfModule>

# السماح بتنفيذ PHP في جميع الملفات
<FilesMatch "\.php$">
    SetHandler application/x-httpd-php
</FilesMatch>

# قواعد إضافية لمنع 403 Forbidden
# السماح بطلبات POST مع Content-Type: application/json
<IfModule mod_headers.c>
    # السماح بجميع أنواع المحتوى في الطلبات
    Header set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, Origin, X-HTTP-Method-Override"
</IfModule>

# محاولة تعطيل قواعد mod_security للطلبات إلى API (قد لا يعمل على جميع الخوادم)
<IfModule mod_security.c>
    SecRuleRemoveById 300013
    SecRuleRemoveById 300014
    SecRuleRemoveById 300015
    SecRuleRemoveById 300016
    SecRuleRemoveById 300017
    SecRuleRemoveById 949110
    SecRuleRemoveById 980130
</IfModule>

# قاعدة خاصة لملف auth.php لمنع 403
<Files "auth.php">
    <IfModule mod_authz_core.c>
        Require all granted
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Allow from all
    </IfModule>
    # السماح بجميع طرق HTTP
    Options +ExecCGI +FollowSymLinks
</Files>

# دليل تنفيذ نظام الدردشة الجماعية

## نظرة عامة
نظام دردشة جماعية متكامل مشابه لتطبيق Signal، يوفر ميزات متقدمة للتواصل الجماعي مع واجهة مستخدم حديثة وتصميم متجاوب يدعم الوضع الليلي/النهاري.

---

## المميزات الرئيسية

### 1. إرسال الرسائل
- إرسال رسائل فورية في غرفة دردشة جماعية واحدة
- دعم الرسائل متعددة الأسطر (Enter + Shift لسطر جديد، Enter فقط للإرسال)
- إشعارات فورية عند وصول رسائل جديدة
- تحديث تلقائي كل 12 ثانية للرسائل الجديدة

### 2. الرد على الرسائل (Reply)
- إمكانية الرد على أي رسالة في المحادثة
- عرض معاينة الرسالة الأصلية في الرد
- الانتقال للرسالة الأصلية عند النقر على المعاينة

### 3. تعديل الرسائل (Edit)
- إمكانية تعديل الرسائل الخاصة بالمستخدم فقط
- عرض علامة "مُعدلة" على الرسائل المعدلة
- منع تعديل الرسائل المحذوفة

### 4. حذف الرسائل (Delete)
- حذف منطقي (Soft Delete) للرسائل
- يمكن للمستخدم حذف رسائله فقط
- عرض رسالة "تم حذف هذه الرسالة" بدلاً من محتوى الرسالة

### 5. حالة القراءة (Read Receipts)
- تتبع عدد المستخدمين الذين قرأوا كل رسالة
- عرض حالة القراءة: ✓ (لم تُقرأ) / ✓✓ (تمت القراءة) / ✓✓ عدد/المجموع
- تحديث تلقائي لحالة القراءة

### 6. حالة المستخدمين (Presence)
- عرض حالة الاتصال/الانقطاع لكل مستخدم
- تحديث الحالة كل 30 ثانية
- عرض آخر ظهور للمستخدمين غير المتصلين
- عداد الأعضاء المتصلين/المجموع في الهيدر

### 7. قائمة الأعضاء (Sidebar)
- قائمة جانبية تعرض جميع الأعضاء النشطين
- عرض صورة المستخدم أو الحروف الأولى من اسمه
- مؤشر حالة الاتصال (أخضر للمتصلين)
- بحث عن الأعضاء
- قائمة قابلة للإخفاء/الإظهار

### 8. التصميم والواجهة
- تصميم متجاوب يدعم جميع الأحجام (Desktop, Tablet, Mobile)
- دعم الوضع الليلي/النهاري مع حفظ التفضيلات في localStorage
- تصميم حديث بظلال وتدرجات لونية
- دعم اللغة العربية والاتجاه من اليمين لليسار (RTL)
- خط Cairo العربي الجميل
- رسوم متحركة سلسة عند إرسال الرسائل

### 9. تجربة المستخدم
- Scroll تلقائي للرسائل الجديدة (فقط عند الاقتراب من الأسفل)
- Toast notifications للإشعارات
- Empty state عند عدم وجود رسائل
- تقسيم الرسائل حسب التاريخ (Day Dividers)
- تمييز الرسائل المرسلة (outgoing) عن الواردة (incoming)
- Highlight للرسائل عند التعديل أو عند الانتقال إليها

### 10. الأمان والأداء
- التحقق من صحة المستخدم قبل كل عملية
- منع المستخدمين من تعديل/حذف رسائل الآخرين
- تنظيف وإزالة التكرار في الرسائل
- تقليل عدد طلبات السيرفر (Polling كل 12 ثانية)

---

## هيكل قاعدة البيانات

### جدول `messages`
```sql
CREATE TABLE IF NOT EXISTS `messages` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `user_id` INT NOT NULL,
  `message_text` LONGTEXT NOT NULL,
  `reply_to` INT DEFAULT NULL,
  `edited` TINYINT(1) NOT NULL DEFAULT 0,
  `deleted` TINYINT(1) NOT NULL DEFAULT 0,
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
  `read_by_count` INT NOT NULL DEFAULT 0,
  PRIMARY KEY (`id`),
  KEY `messages_user_id_idx` (`user_id`),
  KEY `messages_reply_to_idx` (`reply_to`),
  CONSTRAINT `messages_user_fk` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `messages_reply_fk` FOREIGN KEY (`reply_to`) REFERENCES `messages` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### جدول `user_status`
```sql
CREATE TABLE IF NOT EXISTS `user_status` (
  `user_id` INT NOT NULL,
  `last_seen` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `is_online` TINYINT(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (`user_id`),
  CONSTRAINT `user_status_user_fk` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### جدول `message_reads`
```sql
CREATE TABLE IF NOT EXISTS `message_reads` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `message_id` INT NOT NULL,
  `user_id` INT NOT NULL,
  `read_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `message_reads_unique` (`message_id`, `user_id`),
  KEY `message_reads_user_idx` (`user_id`),
  CONSTRAINT `message_reads_message_fk` FOREIGN KEY (`message_id`) REFERENCES `messages` (`id`) ON DELETE CASCADE,
  CONSTRAINT `message_reads_user_fk` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

## هيكل الملفات

```
project/
├── modules/
│   └── chat/
│       └── group_chat.php          # واجهة الدردشة الرئيسية
├── includes/
│   └── chat.php                    # وظائف Backend للدردشة
├── api/
│   └── chat/
│       ├── send_message.php        # API: إرسال رسالة
│       ├── get_messages.php        # API: جلب الرسائل
│       ├── update_message.php      # API: تعديل رسالة
│       ├── delete_message.php      # API: حذف رسالة
│       └── user_status.php         # API: حالة المستخدمين
├── assets/
│   ├── css/
│   │   └── chat.css                # تنسيقات الدردشة
│   └── js/
│       └── chat.js                 # منطق JavaScript للدردشة
```

---

## تفاصيل التنفيذ

### 1. ملف `includes/chat.php` - وظائف Backend

هذا الملف يحتوي على جميع الوظائف الأساسية للدردشة:

#### `ensureChatSchema()`
- تهيئة الجداول تلقائياً إذا لم تكن موجودة
- يجب استدعاؤها في بداية كل ملف API

#### `sendChatMessage($userId, $messageText, $replyTo = null)`
- إرسال رسالة جديدة
- `$userId`: معرف المستخدم المرسل
- `$messageText`: نص الرسالة
- `$replyTo`: معرف الرسالة المراد الرد عليها (اختياري)

#### `getChatMessages($since = null, $limit = 50, $currentUserId = null)`
- جلب الرسائل من قاعدة البيانات
- `$since`: تاريخ للبحث عن الرسائل بعد هذا التاريخ
- `$limit`: عدد الرسائل المطلوبة (افتراضي 50)
- `$currentUserId`: معرف المستخدم الحالي (للتحقق من حالة القراءة)

#### `updateChatMessage($messageId, $userId, $newText)`
- تحديث رسالة موجودة
- يتحقق من أن المستخدم هو صاحب الرسالة

#### `softDeleteChatMessage($messageId, $userId)`
- حذف منطقي للرسالة (تعيين deleted = 1)
- يتحقق من أن المستخدم هو صاحب الرسالة

#### `markMessageAsRead($messageId, $userId)`
- تسجيل قراءة رسالة من قبل مستخدم
- تحديث `read_by_count` في جدول `messages`

#### `updateUserPresence($userId, $isOnline)`
- تحديث حالة المستخدم (متصل/غير متصل)
- تحديث `last_seen` تلقائياً

#### `getActiveUsers()`
- جلب قائمة جميع المستخدمين النشطين مع حالتهم

#### `getLastMessageTimestamp()`
- الحصول على تاريخ آخر رسالة (للمقارنة والتحديث)

---

### 2. ملفات API

جميع ملفات API تتبع نفس الهيكل:

```php
<?php
define('ACCESS_ALLOWED', true);
header('Content-Type: application/json; charset=utf-8');
header('Access-Control-Allow-Origin: *');

// استيراد الملفات المطلوبة
require_once __DIR__ . '/../../includes/config.php';
require_once __DIR__ . '/../../includes/chat.php';

// التحقق من تسجيل الدخول
if (!isLoggedIn()) {
    http_response_code(401);
    echo json_encode(['success' => false, 'error' => 'Unauthorized']);
    exit;
}

try {
    // منطق API هنا
    echo json_encode(['success' => true, 'data' => $result]);
} catch (Throwable $e) {
    error_log('API error: ' . $e->getMessage());
    http_response_code(500);
    echo json_encode(['success' => false, 'error' => 'Internal server error']);
}
```

#### `api/chat/send_message.php`
- **Method**: POST
- **Body**: `{ "message": "نص الرسالة", "reply_to": 123 }`
- **Response**: `{ "success": true, "data": { ...message data... } }`

#### `api/chat/get_messages.php`
- **Method**: GET
- **Query Params**: 
  - `since`: تاريخ للبحث بعد هذا التاريخ
  - `after_id`: معرف الرسالة للبحث بعدها
  - `limit`: عدد الرسائل (1-200)
- **Response**: `{ "success": true, "data": { "messages": [...], "latest_timestamp": "...", "users": [...] } }`

#### `api/chat/update_message.php`
- **Method**: POST
- **Body**: `{ "message_id": 123, "message": "نص جديد" }`
- **Response**: `{ "success": true, "data": { ...updated message... } }`

#### `api/chat/delete_message.php`
- **Method**: POST
- **Body**: `{ "message_id": 123 }`
- **Response**: `{ "success": true, "data": { ...deleted message... } }`

#### `api/chat/user_status.php`
- **Method**: POST (لتحديث الحالة) / GET (للحصول على القائمة)
- **Body (POST)**: `{ "is_online": true }`
- **Response**: `{ "success": true, "data": [...] }`

---

### 3. ملف `modules/chat/group_chat.php` - الواجهة الرئيسية

هذا الملف يحتوي على HTML الرئيسي للدردشة:

#### العناصر المهمة:
- `data-chat-app`: العنصر الرئيسي للدردشة
- `data-chat-messages`: حاوية الرسائل
- `data-chat-input`: حقل إدخال الرسالة
- `data-chat-send`: زر الإرسال
- `data-chat-reply`: شريط الرد/التعديل
- `data-chat-users`: قائمة المستخدمين
- `data-chat-sidebar`: الشريط الجانبي

#### البيانات المطلوبة (data attributes):
```html
<div class="chat-app" 
     data-current-user-id="<?php echo $currentUserId; ?>"
     data-current-user-name="<?php echo $currentUserName; ?>"
     data-current-user-role="<?php echo $currentUserRole; ?>">
```

#### إعداد API Base:
```javascript
window.CHAT_API_BASE = '<?php echo $apiBase; ?>';
```

---

### 4. ملف `assets/js/chat.js` - منطق Frontend

#### المتغيرات المهمة:
- `API_BASE`: رابط API الأساسي
- `POLLING_INTERVAL`: 12000ms (12 ثانية)
- `PRESENCE_INTERVAL`: 30000ms (30 ثانية)

#### الوظائف الرئيسية:

**`init()`**: تهيئة الدردشة
- ربط جميع الأحداث
- جلب الرسائل الأولية
- بدء Polling و Presence updates

**`fetchMessages(initial = false)`**: جلب الرسائل من السيرفر
- استخدام `since` أو `after_id` للحصول على الرسائل الجديدة فقط
- تحديث حالة القراءة تلقائياً

**`sendMessage(message, replyTo)`**: إرسال رسالة
- POST request إلى `send_message.php`
- إضافة الرسالة فوراً للواجهة
- مسح حقل الإدخال

**`updateMessage(messageId, message)`**: تحديث رسالة
- POST request إلى `update_message.php`
- تحديث الرسالة في الواجهة

**`confirmDelete(message)`**: حذف رسالة
- تأكيد من المستخدم
- POST request إلى `delete_message.php`

**`renderMessages()`**: عرض الرسائل
- إنشاء عناصر DOM للرسائل
- إضافة Day Dividers
- تمييز الرسائل المرسلة/الواردة

**`createMessageElement(message, totalUsers)`**: إنشاء عنصر رسالة
- HTML structure للرسالة
- عرض الرد إذا كان موجود
- عرض حالة القراءة
- أزرار الإجراءات (رد/تعديل/حذف)

**`startPolling()`**: بدء التحديث التلقائي
- Interval كل 12 ثانية
- جلب الرسائل الجديدة

**`startPresenceUpdates()`**: تحديث حالة المستخدم
- Interval كل 30 ثانية
- تحديث `is_online = true`

**`updateUserList()`**: تحديث قائمة المستخدمين
- عرض جميع المستخدمين
- تمييز المتصلين
- عرض آخر ظهور

**`toggleTheme()`**: تبديل الوضع الليلي/النهاري
- حفظ التفضيل في localStorage
- إضافة/إزالة class `dark-mode` من body

---

### 5. ملف `assets/css/chat.css` - التنسيقات

#### CSS Variables (Custom Properties):
```css
:root {
  --chat-bg: /* لون الخلفية */
  --chat-accent: /* اللون الرئيسي */
  --chat-text: /* لون النص */
  --chat-muted: /* لون النص الثانوي */
  /* ... المزيد */
}

.dark-mode {
  /* قيم الوضع الليلي */
}
```

#### المكونات الرئيسية:

**`.chat-app`**: الحاوية الرئيسية
- Flexbox layout
- RTL direction
- Border radius و shadow

**`.chat-sidebar`**: الشريط الجانبي
- Fixed width (280px)
- Backdrop filter (glass effect)
- Responsive (يختفي في الموبايل)

**`.chat-messages`**: منطقة الرسائل
- Scrollable container
- Padding و gap بين الرسائل

**`.chat-message`**: رسالة واحدة
- `.outgoing`: الرسائل المرسلة (يمين)
- `.incoming`: الرسائل الواردة (يسار)
- `.deleted`: الرسائل المحذوفة
- `.edited`: الرسائل المعدلة

**`.chat-message-bubble`**: فقاعة الرسالة
- Border radius
- Box shadow
- Hover effects

**`.chat-composer`**: منطقة الإدخال
- Fixed bottom
- Textarea مع auto-resize
- زر الإرسال

#### Responsive Design:
- `@media (max-width: 1100px)`: Tablet
- `@media (max-width: 768px)`: Mobile
- `@media (max-width: 480px)`: Small Mobile

---

## خطوات التنفيذ في مشروع جديد

### الخطوة 1: إعداد قاعدة البيانات
1. تأكد من وجود جدول `users` مع الأعمدة المطلوبة
2. قم بإنشاء الجداول الثلاثة (`messages`, `user_status`, `message_reads`)
3. يمكن استخدام `ensureChatSchema()` لإنشاءها تلقائياً

### الخطوة 2: إنشاء ملفات Backend
1. أنشئ `includes/chat.php` مع جميع الوظائف
2. تأكد من وجود `includes/db.php` و `includes/auth.php`
3. أنشئ مجلد `api/chat/` وملفات API الخمسة

### الخطوة 3: إنشاء ملفات Frontend
1. أنشئ `modules/chat/group_chat.php` (الواجهة)
2. أنشئ `assets/css/chat.css` (التنسيقات)
3. أنشئ `assets/js/chat.js` (المنطق)

### الخطوة 4: التكامل مع المشروع
1. أضف رابط للدردشة في القائمة/اللوحة الرئيسية:
```php
$modulePath = __DIR__ . '/../modules/chat/group_chat.php';
```
2. تأكد من أن المستخدم مسجل دخول
3. قم بتحديد الأدوار المسموح لها بالوصول:
```php
requireRole(['manager', 'admin', 'user']);
```

### الخطوة 5: التخصيص حسب المشروع
1. **الألوان**: عدّل CSS variables في `chat.css` لتتناسب مع تصميم مشروعك
2. **الخطوط**: غيّر `--chat-font-family` إذا كنت تستخدم خطوط مختلفة
3. **اسم الغرفة**: غيّر `$roomName` في `group_chat.php`
4. **الأدوار**: حدّث `requireRole()` حسب أدوار المستخدمين في مشروعك

---

## نصائح للتصميم المتوافق

### 1. استخدام نفس نظام الألوان
- استخدم نفس CSS variables من مشروعك الرئيسي
- أو أنشئ mapping بين متغيرات الدردشة ومتغيرات المشروع

### 2. استخدام نفس الخطوط
- استخدم نفس `font-family` من المشروع الرئيسي
- للحفاظ على التناسق البصري

### 3. نفس نظام التصميم
- استخدم نفس Border radius (مثلاً 12px, 16px, 24px)
- نفس Shadow styles
- نفس Spacing system

### 4. التكامل مع النظام الرئيسي
- استخدم نفس Header/Footer إذا كان موجود
- نفس Navigation structure
- نفس Modal/Dialog styles

### 5. Responsive Design
- تأكد من أن الدردشة تعمل بشكل جيد في جميع الأحجام
- اختبر على Desktop, Tablet, Mobile

---

## مثال على التكامل

```php
// في dashboard/index.php أو أي صفحة رئيسية
<?php
require_once __DIR__ . '/../includes/config.php';
require_once __DIR__ . '/../includes/auth.php';

requireRole(['manager', 'admin', 'user']);

// ... باقي الكود ...

// إضافة رابط للدردشة
echo '<a href="?module=chat">الدردشة الجماعية</a>';

// أو مباشرة:
if (isset($_GET['module']) && $_GET['module'] === 'chat') {
    require_once __DIR__ . '/../modules/chat/group_chat.php';
    exit;
}
?>
```

---

## ملاحظات مهمة

1. **الأمان**: 
   - تأكد من التحقق من صلاحيات المستخدم في كل API call
   - استخدم Prepared Statements دائماً
   - قم بتطهير المدخلات

2. **الأداء**:
   - Polling كل 12 ثانية مناسب لمعظم الحالات
   - يمكن تقليل الفترة إذا كان السيرفر قادراً
   - فكر في استخدام WebSockets للتحديث الفوري (اختياري)

3. **قاعدة البيانات**:
   - استخدم Indexes على الأعمدة المستخدمة في البحث
   - فكر في Archive للرسائل القديمة (اختياري)

4. **التجربة**:
   - اختبر على مختلف المتصفحات
   - اختبر الوضع الليلي/النهاري
   - اختبر على مختلف أحجام الشاشات

---

## خاتمة

هذا النظام يوفر حل متكامل للدردشة الجماعية يمكن دمجه بسهولة في أي مشروع PHP. التركيز الأساسي على:
- **البساطة**: كود واضح وسهل الفهم
- **الأمان**: حماية من الأخطاء والثغرات
- **الأداء**: تحسين الاستعلامات وتقليل الطلبات
- **التصميم**: واجهة عصرية ومتجاوبة
- **التجربة**: سهولة الاستخدام والتفاعل

يمكنك تخصيص وتطوير النظام حسب احتياجات مشروعك الخاص.

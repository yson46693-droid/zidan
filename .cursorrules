# Cursor Rules - Performance & Code Quality Guidelines

## üö® MANDATORY RULES - MUST FOLLOW

### Performance Rules (REQUIRED)
1. **ALWAYS** use `defer` or `async` for script tags
2. **ALWAYS** use debounce/throttle for frequent events (input, scroll, resize)
3. **ALWAYS** use event delegation instead of multiple event listeners
4. **ALWAYS** batch DOM updates using DocumentFragment or string concatenation
5. **ALWAYS** cache API responses and database results when appropriate
6. **NEVER** use `innerHTML` in loops - build string first, then set once
7. **NEVER** create memory leaks - remove event listeners on cleanup
8. **NEVER** load heavy components immediately - use lazy loading

### Code Quality Rules (REQUIRED)
1. **ALWAYS** read `PERFORMANCE_GUIDE.md` before writing code
2. **ALWAYS** use prepared statements for database queries (PHP)
3. **ALWAYS** add indexes for columns used in WHERE/JOIN clauses
4. **ALWAYS** use `SELECT specific_columns` instead of `SELECT *`
5. **ALWAYS** add `LIMIT` to large result sets
6. **ALWAYS** handle errors gracefully without breaking performance
7. **ALWAYS** remove `console.log` from production code

### JavaScript Best Practices (REQUIRED)
```javascript
// ‚úÖ DO: Use debounce for search
const debouncedSearch = debounce(handleSearch, 300);

// ‚úÖ DO: Use event delegation
document.addEventListener('click', (e) => {
    if (e.target.matches('.button')) handleClick(e);
});

// ‚úÖ DO: Batch DOM updates
const fragment = document.createDocumentFragment();
items.forEach(item => fragment.appendChild(createElement(item)));
container.appendChild(fragment);

// ‚ùå DON'T: Multiple innerHTML updates
items.forEach(item => container.innerHTML += `<div>${item}</div>`);

// ‚ùå DON'T: Multiple event listeners
items.forEach(item => item.addEventListener('click', handler));
```

### PHP/API Best Practices (REQUIRED)
```php
// ‚úÖ DO: Use prepared statements
$stmt = $conn->prepare("SELECT * FROM table WHERE id = ?");
$stmt->bind_param("i", $id);

// ‚úÖ DO: Batch queries
$ids = implode(',', array_map('intval', $ids));
$results = dbSelect("SELECT * FROM table WHERE id IN ($ids)");

// ‚ùå DON'T: Multiple queries in loop
foreach ($ids as $id) {
    $result = dbSelect("SELECT * FROM table WHERE id = ?", [$id]);
}
```

### Database Best Practices (REQUIRED)
```sql
-- ‚úÖ DO: Add indexes
CREATE INDEX idx_email ON users(email);

-- ‚úÖ DO: Select specific columns
SELECT id, name, email FROM users;

-- ‚úÖ DO: Use LIMIT
SELECT * FROM repairs ORDER BY created_at DESC LIMIT 50;

-- ‚ùå DON'T: SELECT * without need
SELECT * FROM users;

-- ‚ùå DON'T: No indexes on WHERE columns
SELECT * FROM users WHERE email = 'test@example.com';
```

### HTML/CSS Best Practices (REQUIRED)
```html
<!-- ‚úÖ DO: Lazy load images -->
<img src="image.jpg" loading="lazy" alt="Description">

<!-- ‚úÖ DO: Use defer for scripts -->
<script src="js/file.js" defer></script>

<!-- ‚úÖ DO: Preload critical resources -->
<link rel="preload" href="fonts/font.woff2" as="font">

<!-- ‚ùå DON'T: Blocking scripts in head -->
<script src="js/heavy.js"></script>
```

### Color System Rules (REQUIRED - NO EXCEPTIONS)
**ALWAYS use CSS Variables from the theme - NEVER use random colors**

```css
/* ‚úÖ DO: Use CSS Variables from :root */
:root {
    --primary-color: #2196F3;
    --secondary-color: #64B5F6;
    --success-color: #4CAF50;
    --warning-color: #FFA500;
    --danger-color: #f44336;
    --text-dark: #333;
    --text-light: #666;
    --border-color: #ddd;
    --light-bg: #f5f5f5;
    --white: #ffffff;
    --shadow: 0 2px 10px rgba(0,0,0,0.1);
}

/* ‚úÖ DO: Use variables */
.button {
    background: var(--primary-color);
    color: var(--white);
    border: 1px solid var(--border-color);
}

.card {
    background: var(--white);
    color: var(--text-dark);
    box-shadow: var(--shadow);
}

/* ‚ùå DON'T: Use random/hardcoded colors */
.button {
    background: #ff5733; /* ‚ùå WRONG - Random color */
    color: #00ff00; /* ‚ùå WRONG - Random color */
    border: 1px solid #abc123; /* ‚ùå WRONG - Random color */
}

/* ‚ùå DON'T: Use colors not in the theme */
.header {
    background: #purple; /* ‚ùå WRONG - Not in theme */
    color: #yellow; /* ‚ùå WRONG - Not in theme */
}
```

**Color Usage Guidelines:**
- ‚úÖ **Primary Actions**: Use `var(--primary-color)` (#2196F3 - Blue)
- ‚úÖ **Success/Positive**: Use `var(--success-color)` (#4CAF50 - Green)
- ‚úÖ **Warning/Caution**: Use `var(--warning-color)` (#FFA500 - Orange)
- ‚úÖ **Danger/Error**: Use `var(--danger-color)` (#f44336 - Red)
- ‚úÖ **Secondary Elements**: Use `var(--secondary-color)` (#64B5F6 - Light Blue)
- ‚úÖ **Text**: Use `var(--text-dark)` for primary, `var(--text-light)` for secondary
- ‚úÖ **Backgrounds**: Use `var(--white)`, `var(--light-bg)`, or `var(--dark-bg)` in dark mode
- ‚úÖ **Borders**: Use `var(--border-color)`

### Responsive Design Rules (REQUIRED - ALL SCREENS)
**ALL designs MUST be responsive and work on ALL screen sizes**

```css
/* ‚úÖ DO: Mobile-First Approach */
.container {
    width: 100%;
    padding: 15px;
}

/* ‚úÖ DO: Use Flexbox/Grid for responsive layouts */
.grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.flex {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
}

/* ‚úÖ DO: Always add media queries for different screen sizes */
/* Mobile (< 576px) */
.component {
    padding: 10px;
    font-size: 14px;
}

/* Tablet (576px - 768px) */
@media (min-width: 576px) {
    .component {
        padding: 20px;
        font-size: 16px;
    }
}

/* Desktop (768px - 992px) */
@media (min-width: 768px) {
    .component {
        padding: 30px;
        font-size: 18px;
    }
}

/* Large Desktop (> 992px) */
@media (min-width: 992px) {
    .component {
        padding: 40px;
        max-width: 1200px;
        margin: 0 auto;
    }
}

/* ‚ùå DON'T: Fixed widths without media queries */
.component {
    width: 1200px; /* ‚ùå WRONG - Breaks on mobile */
    padding: 40px; /* ‚ùå WRONG - Too much on mobile */
}

/* ‚ùå DON'T: Forget to test on mobile */
.component {
    display: flex;
    /* ‚ùå Missing: @media (max-width: 768px) { flex-direction: column; } */
}
```

**Responsive Breakpoints (MUST USE):**
- üì± **Mobile**: `max-width: 575.98px` (0px - 575px)
- üì± **Tablet Portrait**: `min-width: 576px and max-width: 767.98px`
- üíª **Tablet Landscape/Desktop**: `min-width: 768px and max-width: 991.98px`
- üñ•Ô∏è **Large Desktop**: `min-width: 992px`

**Responsive Checklist:**
- [ ] Tested on mobile (< 576px)
- [ ] Tested on tablet (576px - 768px)
- [ ] Tested on desktop (768px+)
- [ ] All text is readable on small screens
- [ ] All buttons are tappable (min 44x44px)
- [ ] Images scale properly
- [ ] Forms work on mobile
- [ ] Navigation is accessible on mobile
- [ ] No horizontal scrolling
- [ ] Touch targets are adequate

### Error Handling & System Stability Rules (REQUIRED)
**ALL code MUST NOT break the system - Add proper error handling**

```javascript
// ‚úÖ DO: Try-Catch for async operations
async function fetchData() {
    try {
        const response = await fetch('/api/data');
        if (!response.ok) throw new Error('Network error');
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('Error fetching data:', error);
        showMessage('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ¨ŸÑÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™', 'error');
        return null; // Return safe default
    }
}

// ‚úÖ DO: Validate before operations
function updateUser(userId, data) {
    if (!userId || !data) {
        console.error('Invalid parameters');
        return false;
    }
    
    try {
        // operation
        return true;
    } catch (error) {
        console.error('Update failed:', error);
        return false;
    }
}

// ‚úÖ DO: Defensive programming
function processItem(item) {
    if (!item || typeof item !== 'object') {
        return null; // Safe return
    }
    
    return {
        id: item.id || 0,
        name: item.name || '',
        // Always provide defaults
    };
}

// ‚úÖ DO: Check if element exists before manipulation
function updateElement() {
    const element = document.getElementById('myElement');
    if (!element) {
        console.warn('Element not found');
        return; // Exit safely
    }
    element.textContent = 'Updated';
}

// ‚ùå DON'T: Unhandled errors
async function fetchData() {
    const response = await fetch('/api/data'); /* ‚ùå No try-catch */
    const data = await response.json(); /* ‚ùå Could throw error */
    return data; /* ‚ùå System could break */
}

// ‚ùå DON'T: No validation
function updateUser(userId, data) {
    // Direct operation without checks - ‚ùå Could break system
    database.update(userId, data);
}

// ‚ùå DON'T: Assume elements exist
function updateElement() {
    document.getElementById('myElement').textContent = 'Updated'; 
    /* ‚ùå Could throw error if element doesn't exist */
}
```

**PHP/API Error Handling:**
```php
// ‚úÖ DO: Always handle errors
function getData($id) {
    try {
        $conn = getDBConnection();
        if (!$conn) {
            throw new Exception('Database connection failed');
        }
        
        $stmt = $conn->prepare("SELECT * FROM table WHERE id = ?");
        if (!$stmt) {
            throw new Exception('Query preparation failed');
        }
        
        $stmt->bind_param("i", $id);
        if (!$stmt->execute()) {
            throw new Exception('Query execution failed');
        }
        
        $result = $stmt->get_result();
        return $result->fetch_assoc();
        
    } catch (Exception $e) {
        error_log('Error: ' . $e->getMessage());
        http_response_code(500);
        return ['success' => false, 'message' => 'Internal error'];
    }
}

// ‚ùå DON'T: Unhandled errors
function getData($id) {
    $conn = getDBConnection(); /* ‚ùå Could be null */
    $stmt = $conn->prepare("SELECT * FROM table WHERE id = ?"); /* ‚ùå Could fail */
    $stmt->bind_param("i", $id);
    $stmt->execute(); /* ‚ùå No error handling */
    return $result->fetch_assoc(); /* ‚ùå Could break */
}
```

**Error Handling Checklist:**
- [ ] All async operations have try-catch
- [ ] All API calls have error handling
- [ ] All database operations have error handling
- [ ] All DOM manipulations check if element exists
- [ ] All functions validate input parameters
- [ ] All operations return safe defaults on error
- [ ] Error messages are user-friendly
- [ ] Errors are logged for debugging
- [ ] System continues to work even if one feature fails

## üìã PRE-COMMIT CHECKLIST

Before every commit, verify:

### Performance:
- [ ] No console.log in production code
- [ ] Debounce/throttle applied to frequent events
- [ ] Event listeners removed on cleanup
- [ ] No memory leaks
- [ ] Caching used for repeated operations
- [ ] DOM updates batched
- [ ] Database queries optimized (indexes, LIMIT, specific columns)
- [ ] API responses cached when appropriate
- [ ] Lazy loading for heavy components
- [ ] Lighthouse score > 90

### Colors & Design:
- [ ] **ALL colors use CSS Variables** (no hardcoded colors)
- [ ] Colors match the theme (primary, secondary, success, warning, danger)
- [ ] Dark mode support added (if applicable)
- [ ] No random or theme-breaking colors

### Responsive Design:
- [ ] **Tested on mobile** (< 576px) - all features work
- [ ] **Tested on tablet** (576px - 768px) - layout adapts
- [ ] **Tested on desktop** (768px+) - full functionality
- [ ] All text readable on small screens
- [ ] All buttons tappable (min 44x44px)
- [ ] No horizontal scrolling
- [ ] Images scale properly
- [ ] Forms work on mobile
- [ ] Navigation accessible on all screen sizes

### Error Handling & Stability:
- [ ] **All async operations have try-catch**
- [ ] **All API calls have error handling**
- [ ] **All database operations have error handling**
- [ ] **All DOM manipulations check if element exists**
- [ ] **All functions validate input parameters**
- [ ] Safe defaults returned on errors
- [ ] User-friendly error messages
- [ ] System doesn't break if feature fails
- [ ] Errors logged for debugging

## üéØ Performance Targets

- First Contentful Paint (FCP): < 1.5s
- Largest Contentful Paint (LCP): < 2.5s
- Time to Interactive (TTI): < 3.5s
- Cumulative Layout Shift (CLS): < 0.1
- Total Blocking Time (TBT): < 300ms

## üìö References

- Read `PERFORMANCE_GUIDE.md` for detailed guidelines
- Check existing code patterns in `js/api.js`, `js/auth.js`
- Follow database patterns in `api/database.php`

## ‚ö†Ô∏è WARNINGS

**IF YOU DON'T FOLLOW THESE RULES:**
- Your code will be rejected
- You'll be asked to rewrite
- Performance issues will affect users
- Design inconsistencies will be rejected
- Non-responsive designs will be rejected
- Code that breaks the system will be rejected

**ALWAYS:**
1. Read PERFORMANCE_GUIDE.md first
2. Check existing code patterns
3. **Use ONLY CSS Variables for colors** - Check `css/style.css` for available variables
4. **Test responsive design** on mobile, tablet, and desktop
5. **Add error handling** to all operations
6. Test with Lighthouse before committing
7. Verify no performance regressions
8. Verify system stability (no breaking errors)

## üé® Color Palette Reference

**Available CSS Variables (USE THESE ONLY):**
```css
--primary-color: #2196F3      /* Primary actions, main brand color */
--secondary-color: #64B5F6    /* Secondary elements, highlights */
--success-color: #4CAF50      /* Success messages, positive actions */
--warning-color: #FFA500      /* Warnings, caution messages */
--danger-color: #f44336       /* Errors, delete actions */
--text-dark: #333             /* Primary text color */
--text-light: #666            /* Secondary text color */
--border-color: #ddd          /* Borders, dividers */
--light-bg: #f5f5f5          /* Light backgrounds */
--white: #ffffff              /* White backgrounds, cards */
--dark-bg: #1a1a2e           /* Dark mode background */
--shadow: 0 2px 10px rgba(0,0,0,0.1) /* Standard shadow */
```

**Dark Mode Support:**
- All colors automatically adapt in dark mode via `dark-mode.css`
- Use CSS variables to ensure dark mode compatibility
- Test designs in both light and dark modes

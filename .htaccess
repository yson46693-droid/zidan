# ============================================
# ✅ إعدادات أساسية - Basic Settings
# ============================================

# ✅ CRITICAL: السماح بـ index.html أولاً (قبل أي شيء آخر)
DirectoryIndex index.html index.php index.htm

# ✅ السماح بعرض الملفات
Options -Indexes +FollowSymLinks

# ============================================
# ✅ CRITICAL: السماح بصفحة تسجيل الدخول - MUST BE FIRST
# ============================================

# ✅ السماح بـ index.html بشكل صريح (قبل أي قواعد أخرى)
<Files "index.html">
    <IfModule mod_authz_core.c>
        Require all granted
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Allow from all
    </IfModule>
</Files>

# ✅ السماح بـ index.php بشكل صريح
<Files "index.php">
    <IfModule mod_authz_core.c>
        Require all granted
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Allow from all
    </IfModule>
</Files>

# ============================================
# ✅ السماح بجميع الملفات الموجودة - بدون RewriteEngine
# ============================================

# ✅ السماح بجميع ملفات HTML, CSS, JS, JSON
<FilesMatch "\.(html|htm|css|js|json|xml|txt)$">
    <IfModule mod_authz_core.c>
        Require all granted
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Allow from all
    </IfModule>
</FilesMatch>

# ✅ السماح بجميع الصور
<FilesMatch "\.(jpg|jpeg|png|gif|svg|ico|webp|avif)$">
    <IfModule mod_authz_core.c>
        Require all granted
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Allow from all
    </IfModule>
</FilesMatch>

# ✅ السماح بجميع الخطوط
<FilesMatch "\.(woff|woff2|ttf|eot|otf)$">
    <IfModule mod_authz_core.c>
        Require all granted
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Allow from all
    </IfModule>
</FilesMatch>

# ✅ السماح بجميع ملفات PHP في مجلد api/
<Directory "api">
    <IfModule mod_authz_core.c>
        Require all granted
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Allow from all
    </IfModule>
</Directory>

# ✅ RewriteEngine - فقط إذا كان متاحاً (للطلبات الخاصة)
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # ✅ CRITICAL: السماح بـ index.html مباشرة (قبل أي قواعد أخرى)
    RewriteCond %{REQUEST_FILENAME} -f [OR]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule . - [L]
    
    # ✅ السماح بجميع الطلبات إلى مجلد api/
    RewriteCond %{REQUEST_URI} ^/?api/ [NC]
    RewriteRule ^ - [L]
</IfModule>

# ============================================
# ✅ Service Worker (sw.js) - CRITICAL
# ============================================

<FilesMatch "sw\.js$">
    <IfModule mod_headers.c>
        Header set Content-Type "application/javascript; charset=utf-8"
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
        Header set Service-Worker-Allowed "/"
    </IfModule>
    <IfModule mod_authz_core.c>
        Require all granted
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Allow from all
    </IfModule>
</FilesMatch>

<IfModule mod_rewrite.c>
    RewriteCond %{REQUEST_URI} sw\.js$ [NC]
    RewriteRule . - [E=no-gzip:1,E=dont-vary:1,L,T=application/javascript]
    
    RewriteCond %{REQUEST_URI} sw\.js\.php$ [NC]
    RewriteRule . - [E=no-gzip:1,E=dont-vary:1,L]
</IfModule>

# ============================================
# ✅ السماح بجميع ملفات HTML, CSS, JS (مكرر للتأكيد)
# ============================================

# ============================================
# ✅ MIME Types
# ============================================

<IfModule mod_mime.c>
    AddType text/html .html
    AddType text/css .css
    AddType application/javascript .js
    AddType text/javascript .js
    AddType application/json .json
    AddType application/manifest+json .webmanifest
    AddType application/manifest+json manifest.json
    AddType image/webp .webp
    AddType image/avif .avif
</IfModule>

AddDefaultCharset UTF-8

# ============================================
# ✅ Headers للأمان والأداء
# ============================================

<IfModule mod_headers.c>
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # HTML - لا تخزين
    <FilesMatch "\.(html|htm)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
    
    # CSS و JavaScript - تخزين لمدة شهر
    <FilesMatch "\.(css|js)$">
        Header set Cache-Control "max-age=2592000, public, stale-while-revalidate=86400"
    </FilesMatch>
    
    # الصور والخطوط - تخزين لمدة سنة
    <FilesMatch "\.(jpg|jpeg|png|gif|webp|svg|ico|woff|woff2|ttf|eot)$">
        Header set Cache-Control "max-age=31536000, public, immutable"
    </FilesMatch>
</IfModule>

# ============================================
# ✅ ضغط الملفات - Compression
# ============================================

<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE image/svg+xml
    
    SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|webp|ico)$ no-gzip dont-vary
    SetEnvIfNoCase Request_URI \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
</IfModule>

# ============================================
# ✅ CORS
# ============================================

<IfModule mod_headers.c>
    <FilesMatch "\.(html|css|js)$">
        Header set Access-Control-Allow-Origin "*"
        Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
        Header set Access-Control-Allow-Headers "Content-Type, X-Requested-With"
    </FilesMatch>
</IfModule>

# ============================================
# ✅ إعدادات PHP للجلسات - حل مشكلة open_basedir
# ============================================

<IfModule mod_php.c>
    php_value session.save_path "/tmp"
    php_value soap.wsdl_cache_enabled "0"
    php_value soap.wsdl_cache_dir "/tmp"
    php_value soap.wsdl_cache_ttl "0"
    php_value soap.wsdl_cache_limit "0"
    php_value auto_prepend_file ".auto_prepend.php"
</IfModule>

<IfModule lsapi_module>
    php_value session.save_path "/tmp"
    php_value soap.wsdl_cache_enabled "0"
    php_value soap.wsdl_cache_dir "/tmp"
    php_value soap.wsdl_cache_ttl "0"
    php_value soap.wsdl_cache_limit "0"
    php_value auto_prepend_file ".auto_prepend.php"
</IfModule>

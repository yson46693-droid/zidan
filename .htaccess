# تفعيل معالجة ملفات PHP - يجب أن يكون في البداية
AddType application/x-httpd-php .php

# MIME Types لـ PWA
AddType application/manifest+json .webmanifest
AddType application/manifest+json .json
AddType application/json manifest.json
AddType application/xml browserconfig.xml

# MIME Types لملفات CSS و JS (مهم لمنع CORB)
AddType text/css .css
AddType text/javascript .js
AddType application/javascript .js

# التأكد من أن ملفات CSS/JS تُخدم بشكل صحيح (بدون معالجة كـ PHP)
<FilesMatch "\.(css|js)$">
    SetHandler default-handler
    Header set Cache-Control "public, max-age=31536000"
</FilesMatch>

# استثناء ملفات CSS
<FilesMatch "\.css$">
    SetHandler default-handler
    ForceType text/css
    Header set Content-Type "text/css; charset=utf-8"
</FilesMatch>

# استثناء ملفات JS - يجب أن يكون قبل أي قواعد أخرى
<FilesMatch "\.js$">
    SetHandler default-handler
    ForceType application/javascript
    Header set Content-Type "application/javascript; charset=utf-8"
</FilesMatch>

# إعدادات PHP
<IfModule mod_php.c>
    php_flag display_errors Off
    php_flag log_errors On
    php_value error_log logs/php_errors.log
</IfModule>

# التأكد من معالجة ملفات PHP (لجميع أنواع الخوادم)
<FilesMatch "\.php$">
    SetHandler application/x-httpd-php
</FilesMatch>

# Service Worker - التأكد من عدم معالجته كـ PHP
<Files "sw.js">
    SetHandler default-handler
    ForceType application/javascript
</Files>


# قاعدة خاصة لملف chat.php
<Files "chat.php">
    SetHandler application/x-httpd-php
    Order allow,deny
    Allow from all
</Files>

# إعادة كتابة URL لملفات PHP
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /
    
    # السماح بالوصول المباشر لملفات PHP الموجودة
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteCond %{REQUEST_FILENAME} \.php$
    RewriteRule ^(.*)$ $1 [L]
    
    # منع الوصول المباشر للملفات الحساسة
    <FilesMatch "\.(htaccess|htpasswd|ini|log|sql|bak)$">
        Order Allow,Deny
        Deny from all
    </FilesMatch>
</IfModule>

# إعدادات CORS
<IfModule mod_headers.c>
    Header set Access-Control-Allow-Origin "*"
    Header set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH"
    Header set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, Origin"
    
    # PWA Headers - دعم Service Worker و Manifest
    # Service Worker يجب أن يُخدم من نفس الأصل بدون CORS وبـ Content-Type صحيح
    <FilesMatch "^sw\.js$">
        Header always set Content-Type "application/javascript; charset=utf-8"
        Header always set Service-Worker-Allowed "/"
        Header always set Cache-Control "no-cache, no-store, must-revalidate"
        Header always set Pragma "no-cache"
        Header always set Expires "0"
        Header always set X-Content-Type-Options "nosniff"
    </FilesMatch>
    
    # Manifest يجب أن يُخدم كـ application/manifest+json
    <FilesMatch "manifest\.json$">
        Header set Content-Type "application/manifest+json; charset=utf-8"
        Header set X-Content-Type-Options "nosniff"
    </FilesMatch>
    
    # Browserconfig.xml لـ Windows
    <FilesMatch "browserconfig\.xml$">
        Header set Content-Type "application/xml; charset=utf-8"
    </FilesMatch>
    
    # CSS Files - التأكد من Content-Type الصحيح لمنع CORB
    <FilesMatch "\.css$">
        Header set Content-Type "text/css; charset=utf-8"
        Header set X-Content-Type-Options "nosniff"
        Header append Vary "Accept"
    </FilesMatch>
    
    # JavaScript Files - التأكد من Content-Type الصحيح
    <FilesMatch "\.js$">
        Header set Content-Type "application/javascript; charset=utf-8"
        Header set X-Content-Type-Options "nosniff"
        Header append Vary "Accept"
    </FilesMatch>
</IfModule>

# منع عرض قائمة الملفات
Options -Indexes

# ضغط الملفات
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

# Cache Control للملفات الثابتة (الصور والملفات الثقيلة)
<IfModule mod_expires.c>
    ExpiresActive On
    # الصور - كاش طويل الأمد
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/ico "access plus 1 year"
    # الخطوط
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    # CSS و JS - كاش مع Cache Busting (filemtime في PHP)
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType text/javascript "access plus 1 year"
</IfModule>

# منع Cache لصفحات PHP فقط (HTML الناتج)
<FilesMatch "\.php$">
    <IfModule mod_headers.c>
        Header set Cache-Control "no-cache, no-store, must-revalidate, max-age=0"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </IfModule>
</FilesMatch>

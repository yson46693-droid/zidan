# ============================================
# ✅ إعدادات أساسية
# ============================================

DirectoryIndex index.html index.php index.htm
Options -Indexes +FollowSymLinks

# ============================================
# ✅ السماح بجميع الملفات
# ============================================

<FilesMatch ".*">
    <IfModule mod_authz_core.c>
        Require all granted
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Allow from all
    </IfModule>
</FilesMatch>

# ============================================
# ✅ RewriteEngine
# ============================================

<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # السماح بالوصول للملفات والمجلدات الموجودة
    RewriteCond %{REQUEST_FILENAME} -f [OR]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule . - [L]
</IfModule>

# ============================================
# ✅ Service Worker (sw.js) - CRITICAL
# ============================================

<FilesMatch "sw\.js$">
    <IfModule mod_headers.c>
        Header set Content-Type "application/javascript; charset=utf-8"
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
        Header set Service-Worker-Allowed "/"
    </IfModule>
    <IfModule mod_authz_core.c>
        Require all granted
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Allow from all
    </IfModule>
</FilesMatch>

# ============================================
# ✅ Service Worker PHP (sw.js.php) - CRITICAL
# ============================================

<FilesMatch "sw\.js\.php$">
    # ✅ CRITICAL: Ensure PHP is executed
    <IfModule mod_php.c>
        php_flag display_errors Off
        php_flag output_buffering Off
    </IfModule>
    
    # ✅ CRITICAL: Disable compression for Service Worker
    <IfModule mod_deflate.c>
        SetEnvIfNoCase Request_URI sw\.js\.php$ no-gzip dont-vary
    </IfModule>
    
    # ✅ CRITICAL: Set headers (will be overridden by PHP, but good fallback)
    <IfModule mod_headers.c>
        Header unset Content-Type
        Header set Content-Type "application/javascript; charset=utf-8"
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
        Header set Service-Worker-Allowed "/"
        Header set X-Content-Type-Options "nosniff"
    </IfModule>
    
    # ✅ CRITICAL: Allow access
    <IfModule mod_authz_core.c>
        Require all granted
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Allow from all
    </IfModule>
</FilesMatch>

<IfModule mod_rewrite.c>
    RewriteCond %{REQUEST_URI} sw\.js$ [NC]
    RewriteRule . - [E=no-gzip:1,E=dont-vary:1,L,T=application/javascript]
    
    # ✅ CRITICAL: Ensure sw.js.php is processed by PHP
    RewriteCond %{REQUEST_URI} sw\.js\.php$ [NC]
    RewriteRule . - [E=no-gzip:1,E=dont-vary:1,L]
</IfModule>

# ============================================
# ✅ Icons Directory - CRITICAL
# ============================================
# ملاحظة: يتم التعامل مع إعدادات icons في icons/.htaccess
# القواعد العامة في هذا الملف تسمح بالوصول لجميع الملفات

# ============================================
# ✅ MIME Types
# ============================================

<IfModule mod_mime.c>
    AddType text/html .html
    AddType text/css .css
    AddType application/javascript .js
    AddType text/javascript .js
    AddType application/json .json
    AddType application/manifest+json .webmanifest
    AddType application/manifest+json manifest.json
    AddType image/png .png
    AddType image/jpeg .jpg .jpeg
    AddType image/gif .gif
    AddType image/svg+xml .svg
    AddType image/x-icon .ico
    AddType image/webp .webp
    AddType image/avif .avif
</IfModule>

AddDefaultCharset UTF-8

# ============================================
# ✅ Headers للأمان والأداء
# ============================================

<IfModule mod_headers.c>
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # HTML - لا تخزين
    <FilesMatch "\.(html|htm)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
    
    # CSS و JavaScript - تخزين لمدة شهر
    <FilesMatch "\.(css|js)$">
        Header set Cache-Control "max-age=2592000, public, stale-while-revalidate=86400"
    </FilesMatch>
    
    # الصور والخطوط - تخزين لمدة سنة
    <FilesMatch "\.(jpg|jpeg|png|gif|webp|svg|ico|woff|woff2|ttf|eot)$">
        Header set Cache-Control "max-age=31536000, public, immutable"
    </FilesMatch>
    
    # ✅ CRITICAL: Headers لملفات icons (يتم التعامل معها في icons/.htaccess أيضاً)
</IfModule>

# ============================================
# ✅ ضغط الملفات - Compression
# ============================================

<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE image/svg+xml
    
    SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|webp|ico)$ no-gzip dont-vary
    SetEnvIfNoCase Request_URI \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
</IfModule>

# ============================================
# ✅ CORS
# ============================================

<IfModule mod_headers.c>
    <FilesMatch "\.(html|css|js)$">
        Header set Access-Control-Allow-Origin "*"
        Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
        Header set Access-Control-Allow-Headers "Content-Type, X-Requested-With"
    </FilesMatch>
    
    # ✅ CRITICAL: CORS للأيقونات (يتم التعامل معها في icons/.htaccess)
</IfModule>

# ============================================
# ✅ إعدادات PHP
# ============================================

<IfModule mod_php.c>
    php_value soap.wsdl_cache_enabled "0"
    # ✅ تم إزالة auto_prepend_file - يتم التعامل معه في config.php
    # php_value auto_prepend_file ".auto_prepend.php"
</IfModule>

<IfModule lsapi_module>
    php_value soap.wsdl_cache_enabled "0"
    # ✅ تم إزالة auto_prepend_file - يتم التعامل معه في config.php
    # php_value auto_prepend_file ".auto_prepend.php"
</IfModule>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="نظام نقطة البيع - ALAA ZIDAN - APP ">
    <meta name="theme-color" content="#2196F3">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ALAA ZIDAN">
    
    <!-- Windows Meta Tags -->
    <meta name="msapplication-TileColor" content="#2196F3">
    <meta name="msapplication-TileImage" content="ico/icon-144x144.png">
    <meta name="msapplication-navbutton-color" content="#2196F3">
    <meta name="msapplication-starturl" content="/pos.html">
    <meta name="msapplication-tooltip" content="نقطة البيع - ALAA ZIDAN">
    <meta name="msapplication-window" content="width=1024;height=768">
    <meta name="msapplication-config" content="browserconfig.xml">
    
    <!-- Meta Tags للمتصفحات القديمة -->
    <meta name="application-name" content="ALAA ZIDAN - APP">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Open Graph (للمتصفحات القديمة) -->
    <meta property="og:title" content="نقطة البيع - ALAA ZIDAN">
    <meta property="og:type" content="website">
    <meta property="og:image" content="ico/icon-512x512.png">
    
    <title>نقطة البيع - POS</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons - مع cache busting لضمان الحصول على أحدث نسخة -->
    <link rel="icon" type="image/png" sizes="32x32" href="ico/icon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="ico/icon-72x72.png">
    <link rel="shortcut icon" href="ico/icon-192x192.png">
    
    <!-- Apple Touch Icons - مع cache busting -->
    <link rel="apple-touch-icon" sizes="180x180" href="ico/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="ico/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="ico/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="120x120" href="ico/icon-128x128.png">
    <link rel="apple-touch-icon" sizes="114x114" href="ico/icon-128x128.png">
    <link rel="apple-touch-icon" sizes="76x76" href="ico/icon-96x96.png">
    <link rel="apple-touch-icon" sizes="72x72" href="ico/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="60x60" href="ico/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="57x57" href="ico/icon-72x72.png">
    <link rel="apple-touch-icon" href="ico/icon-192x192.png">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- Arabic Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&family=Tajawal:wght@300;400;500;700;800&family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dark-mode.css">
    <link rel="stylesheet" href="css/pos.css">
    <link rel="stylesheet" href="css/print.css" media="print">
    
    <!-- ✅ Resource Checker - التحقق من تحميل الموارد الحرجة -->
    <script src="js/resource-checker.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

</head>
<body>
    <div class="pos-container">
        <!-- Header - Desktop -->
        <header class="pos-header">
            <div class="pos-header-content">
                <button class="btn-header-icon" id="qrHeaderBtn" title="QR Scanner">
                    <i class="bi bi-qr-code-scan"></i>
                </button>
                <h1>نقطة البيع</h1>
                <button class="btn-back" id="backBtn" style="text-decoration: none; border: none; cursor: pointer;">
                    <i class="bi bi-arrow-right"></i> العودة  
                </button>
            </div>
        </header>

        <!-- Header - Mobile -->
        <header class="pos-header-mobile">
            <div class="pos-header-mobile-content">
                <button class="btn-header-icon-mobile" id="qrHeaderBtnMobile" title="QR Scanner">
                    <i class="bi bi-qr-code-scan"></i>
                </button>
                <h1 class="pos-header-mobile-title">نقطة البيع</h1>
                <button class="btn-back-mobile" id="backBtnMobile" style="text-decoration: none; border: none; cursor: pointer;">
                    <i class="bi bi-arrow-right"></i> العودة  
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="pos-main">
            <!-- Left Side - Products -->
            <div class="pos-products-section">
                <!-- QR Scanner Section (Mobile Only) -->
                <div class="pos-qr-scanner-mobile" id="posQrScannerMobile">
                    <div class="pos-qr-scanner-box-mobile" id="pos-qr-reader-mobile" style="position: relative; width: 100%; min-height: 250px; background: var(--light-bg); border-radius: 10px; overflow: hidden;">
                        <div id="pos-scanner-loading-mobile" class="pos-scanner-loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; text-align: center; color: var(--text-dark);">
                            <i class="bi bi-camera" style="font-size: 2em; color: var(--primary-color); margin-bottom: 10px; display: block; animation: pulse 2s infinite;"></i>
                            <p style="font-size: 0.9em; font-weight: 600; color: var(--text-dark);">جاري تحميل قارئ QR Code...</p>
                            <p class="scanner-hint" style="font-size: 0.75em; color: var(--text-light); margin-top: 5px;">يرجى السماح بالوصول إلى الكاميرا</p>
                        </div>
                        <div id="pos-scanner-error-mobile" class="pos-scanner-error" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; text-align: center; color: var(--danger-color);">
                            <i class="bi bi-exclamation-triangle" style="font-size: 2em; margin-bottom: 10px; display: block;"></i>
                            <p id="pos-scanner-error-message-mobile" style="font-size: 0.85em; font-weight: 600;">خطأ في تحميل الكاميرا</p>
                        </div>
                        <div id="pos-scanner-overlay-mobile" class="pos-scanner-overlay scanner-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5;">
                            <div class="scanner-frame" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 75%; height: 75%; max-width: 250px; max-height: 250px; border: 4px solid var(--primary-color); border-radius: 15px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.6), 0 0 40px rgba(33, 150, 243, 0.6); background: rgba(255,255,255,0.05); pointer-events: none;"></div>
                            <div class="scanner-corners" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 75%; height: 75%; max-width: 250px; max-height: 250px; pointer-events: none;">
                                <div class="corner corner-tl" style="position: absolute; top: 0; left: 0; width: 35px; height: 35px; border-top: 5px solid var(--success-color); border-left: 5px solid var(--success-color); border-radius: 8px 0 0 0; box-shadow: 0 0 10px rgba(76, 175, 80, 0.6);"></div>
                                <div class="corner corner-tr" style="position: absolute; top: 0; right: 0; width: 35px; height: 35px; border-top: 5px solid var(--success-color); border-right: 5px solid var(--success-color); border-radius: 0 8px 0 0; box-shadow: 0 0 10px rgba(76, 175, 80, 0.6);"></div>
                                <div class="corner corner-bl" style="position: absolute; bottom: 0; left: 0; width: 35px; height: 35px; border-bottom: 5px solid var(--success-color); border-left: 5px solid var(--success-color); border-radius: 0 0 0 8px; box-shadow: 0 0 10px rgba(76, 175, 80, 0.6);"></div>
                                <div class="corner corner-br" style="position: absolute; bottom: 0; right: 0; width: 35px; height: 35px; border-bottom: 5px solid var(--success-color); border-right: 5px solid var(--success-color); border-radius: 0 0 8px 0; box-shadow: 0 0 10px rgba(76, 175, 80, 0.6);"></div>
                            </div>
                            <!-- نص إرشادي للقارئ المدمج -->
                            <div style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); text-align: center; color: var(--white); background: rgba(0,0,0,0.75); padding: 6px 12px; border-radius: 15px; font-size: 0.7em; font-weight: 600; white-space: nowrap; box-shadow: 0 4px 15px rgba(0,0,0,0.4); z-index: 10; pointer-events: none;">
                                <i class="bi bi-arrows-move" style="margin-left: 4px; font-size: 0.9em;"></i>
                                ضع الباركود داخل الإطار
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search Bar -->
                <div class="pos-search-bar">
                    <input type="text" id="searchInput" placeholder="ابحث عن المنتجات..." autocomplete="off">
                </div>

                <!-- Category Tabs -->
                <div class="pos-tabs">
                    <button class="pos-tab active" data-category="all">
                        الكل
                    </button>
                    <button class="pos-tab" data-category="spare_parts">
                        قطع غيار
                    </button>
                    <button class="pos-tab" data-category="accessories">
                        اكسسوار
                    </button>
                    <button class="pos-tab" data-category="phones">
                        هواتف
                    </button>
                </div>

                <!-- Products Grid -->
                <div class="pos-products-grid" id="productsGrid">
                    <div class="pos-loading">
                        <i class="bi bi-arrow-repeat"></i> جاري التحميل...
                    </div>
                </div>
            </div>

            <!-- Right Side - Cart -->
            <div class="pos-cart-section">
                <div class="pos-cart-header">
                    <h3><i class="bi bi-cart"></i> سلة التسوق</h3>
                    <button class="btn-clear-cart" id="clearCartBtn" title="مسح السلة">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>

                <!-- Cart Items -->
                <div class="pos-cart-items" id="cartItems">
                    <div class="pos-cart-empty">
                        <i class="bi bi-cart-x"></i>
                        <p>السلة فارغة</p>
                    </div>
                </div>

                <!-- Cart Summary -->
                <div class="pos-cart-summary">
                    <div class="summary-row">
                        <label>
                            <span>الخصم:</span>
                            <input type="number" id="discountInput" value="0" min="0" step="0.01">
                        </label>
                        <div class="summary-values">
                            <span class="summary-label">المجموع الفرعي:</span>
                            <span id="subtotal" class="summary-value">0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Pay Button with Total -->
                <div class="pos-pay-section">
                    <div class="total-display">
                        <span class="total-label">الإجمالي:</span>
                        <span id="totalAmount" class="total-value">0.00</span>
                    </div>
                    <button class="btn-pay" id="payBtn" disabled>
                        <i class="bi bi-credit-card"></i> الدفع الآن
                    </button>
                </div>

                <!-- QR Scanner Box -->
                <div class="pos-qr-scanner-container" id="posQrScannerContainer">
                    <div class="pos-qr-scanner-box" id="pos-qr-reader">
                        <div id="pos-scanner-loading" class="pos-scanner-loading">
                            <i class="bi bi-camera"></i>
                            <p>جاري تحميل قارئ QR Code...</p>
                            <p class="scanner-hint">يرجى السماح بالوصول إلى الكاميرا</p>
                        </div>
                        <div id="pos-scanner-error" class="pos-scanner-error" style="display: none;">
                            <i class="bi bi-exclamation-triangle"></i>
                            <p id="pos-scanner-error-message">خطأ في تحميل الكاميرا</p>
                        </div>
                        <div id="pos-scanner-overlay" class="pos-scanner-overlay">
                            <div class="scanner-frame"></div>
                            <div class="scanner-corners">
                                <div class="corner corner-tl"></div>
                                <div class="corner corner-tr"></div>
                                <div class="corner corner-bl"></div>
                                <div class="corner corner-br"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Action Bar (Mobile Only) -->
        <div class="pos-bottom-action-bar" id="bottomActionBar">
            <button class="btn-complete-sale" id="completeSaleBtn" disabled>
                إتمام البيع
            </button>
            <div class="bottom-action-info">
                <div class="bottom-total">
                    <span id="bottomTotalAmount">0.00</span>
                    <span class="bottom-currency">.ج.</span>
                </div>
                <div class="bottom-items-count">
                    <span id="bottomItemsCount">0</span>
                    <span>عناصر</span>
                </div>
                <div class="bottom-cart-icon">
                    <i class="bi bi-cart"></i>
                    <span class="cart-badge" id="bottomCartBadge">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="pos-modal" id="paymentModal">
        <div class="pos-modal-content">
            <div class="pos-modal-header">
                <button class="btn-close-modal-left" id="closePaymentModalLeft">
                    <i class="bi bi-x"></i>
                </button>
                <h3>تأكيد البيع</h3>
                <div style="width: 40px;"></div>
            </div>
            <div class="pos-modal-body">
                <!-- Items List -->
                <div class="confirm-sale-items-section">
                    <h4 class="confirm-sale-section-title">العناصر (<span id="confirmSaleItemsCount">0</span>)</h4>
                    <div class="confirm-sale-items-list" id="confirmSaleItemsList">
                        <!-- Items will be populated here -->
                    </div>
                </div>

                <!-- Discount Section -->
                <div class="form-group confirm-sale-discount">
                    <label>الخصم.</label>
                    <div class="discount-input-wrapper">
                        <i class="bi bi-receipt"></i>
                        <input type="number" id="confirmSaleDiscountInput" value="0" min="0" step="0.01" placeholder="0.00">
                        <span class="currency-label">.ج.</span>
                    </div>
                </div>

                <!-- Customer Type Selection -->
                <div class="form-group">
                    <label>نوع العميل <span style="color: var(--danger-color);">*</span>:</label>
                    <div class="customer-type-selector" style="display: flex; gap: 10px; margin-top: 8px;">
                        <button type="button" class="btn-customer-type active" data-type="retail" onclick="selectCustomerType('retail')">
                            <i class="bi bi-person"></i> عميل محل
                        </button>
                        <button type="button" class="btn-customer-type" data-type="commercial" onclick="selectCustomerType('commercial')">
                            <i class="bi bi-shop"></i> عميل تجاري
                        </button>
                    </div>
                </div>
                
                <!-- Existing Customers -->
                <div class="form-group" id="existingCustomersGroup" style="display: none;">
                    <label>اختر عميل موجود:</label>
                    <select id="existingCustomerSelect" class="form-control" onchange="selectExistingCustomer(this.value)" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; margin-top: 8px;">
                        <option value="">-- اختر عميل --</option>
                    </select>
                    <div style="text-align: center; margin-top: 10px;">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="showNewCustomerForm()">إضافة عميل جديد</button>
                    </div>
                </div>
                
                <!-- New Customer Form -->
                <div id="newCustomerForm">
                    <div class="form-group">
                        <label>اسم العميل <span style="color: var(--danger-color);">*</span>:</label>
                        <div class="input-with-icon">
                            <i class="bi bi-person"></i>
                            <input type="text" id="customerNameInput" placeholder="اسم العميل" required autocomplete="name">
                        </div>
                    </div>
                    <div class="form-group" id="shopNameGroup" style="display: none;">
                        <label>اسم المحل <span style="color: var(--danger-color);">*</span>:</label>
                        <input type="text" id="shopNameInput" placeholder="اسم المحل">
                    </div>
                    <div class="form-group">
                        <label>رقم الهاتف <span style="color: var(--danger-color);">*</span>:</label>
                        <div class="input-with-icon">
                            <i class="bi bi-telephone"></i>
                            <input type="tel" id="customerPhoneInput" placeholder="رقم الهاتف" required autocomplete="tel" pattern="[0-9]{8,}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>العنوان:</label>
                        <textarea id="customerAddressInput" rows="2" placeholder="العنوان (اختياري)"></textarea>
                    </div>
                </div>
                
                <!-- Payment Amount Section (for commercial customers only) -->
                <div class="form-group" id="paymentAmountGroup" style="display: none;">
                    <label>المبلغ المدفوع <span style="color: var(--danger-color);">*</span>:</label>
                    <input type="number" id="paidAmountInput" placeholder="المبلغ المدفوع" min="0" step="0.01" oninput="updatePaymentAmount()">
                    <div style="margin-top: 8px; font-size: 0.9em; color: var(--text-light);">
                        <span>المتبقي: <strong id="remainingAmountDisplay">0.00</strong></span>
                    </div>
                </div>

                <!-- Total Section -->
                <div class="confirm-sale-total">
                    <span class="confirm-sale-total-label">الإجملي :</span>
                    <span id="confirmSaleTotal" class="confirm-sale-total-value">0.00</span>
                    <span class="currency-label">.ج.</span>
                </div>
            </div>
            <div class="pos-modal-footer">
                <button class="btn btn-primary btn-confirm-pay" id="confirmPaymentBtn">
                    تأكيد و دفع
                </button>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div class="pos-modal" id="invoiceModal">
        <div class="pos-modal-content pos-invoice-content">
            <div class="pos-modal-header">
                <h3>فاتورة البيع</h3>
                <div class="invoice-actions">
                    <button class="btn-print" id="printInvoiceBtn">
                        <i class="bi bi-printer"></i> طباعة
                    </button>
                    <button class="btn-close-modal" id="closeInvoiceModal">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            </div>
            <div class="pos-invoice-body" id="invoiceBody">
                <!-- Invoice content will be generated here -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- مكتبة QR Code الحقيقية - مع آلية احتياطية -->
    <script>
        // Load QRCode library with fallback mechanism
        (function() {
            // استخدام CDN مباشرة (الملف المحلي غير موجود)
            const cdnUrls = [
                'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js',
                'https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js'
            ];

            let loaded = false;
            let currentIndex = 0;
            const allUrls = [...cdnUrls];

            function loadScript(url) {
                return new Promise((resolve, reject) => {
                    if (loaded || (typeof QRCode !== 'undefined')) {
                        loaded = true;
                        return resolve();
                    }

                    const script = document.createElement('script');
                    script.src = url;
                    script.async = true;
                    
                    // Set timeout for script loading (5 seconds)
                    const timeout = setTimeout(() => {
                        script.onload = null;
                        script.onerror = null;
                        document.head.removeChild(script);
                        reject(new Error('Script load timeout'));
                    }, 5000);
                    
                    script.onload = () => {
                        clearTimeout(timeout);
                        // Wait a bit for the library to initialize
                        setTimeout(() => {
                            if (typeof QRCode !== 'undefined') {
                                loaded = true;
                                console.log('✅ QRCode library loaded from:', url);
                                resolve();
                            } else {
                                reject(new Error('QRCode not defined'));
                            }
                        }, 100);
                    };
                    script.onerror = () => {
                        clearTimeout(timeout);
                        reject(new Error('Failed to load script'));
                    };
                    document.head.appendChild(script);
                });
            }

            async function tryLoadNext() {
                if (loaded || currentIndex >= allUrls.length) {
                    if (!loaded && typeof QRCode === 'undefined') {
                        console.log('ℹ️ QRCode library will use API fallback method for QR code generation.');
                    }
                    return;
                }

                try {
                    await loadScript(allUrls[currentIndex]);
                } catch (error) {
                    // Log warnings for CDN failures
                    console.debug(`QRCode CDN attempt ${currentIndex} failed, trying next...`);
                    currentIndex++;
                    tryLoadNext();
                }
            }

            tryLoadNext();
        })();
    </script>
    <!-- مكتبة Quagga لقراءة الباركود -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <!-- مكتبة html5-qrcode لقراءة QR Code -->
    <script>
        // Load html5-qrcode library for QR Code scanning
        window.loadHtml5Qrcode = function() {
            return new Promise((resolve, reject) => {
                if (window.html5QrcodeLoaded) return resolve();
                
                // Check if already loaded
                if (typeof Html5Qrcode !== 'undefined') {
                    window.html5QrcodeLoaded = true;
                    return resolve();
                }
                
                const script = document.createElement('script');
                // استخدام jsDelivr CDN الموثوق بدلاً من unpkg
                script.src = 'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js';
                script.async = true;
                script.onload = () => {
                    window.html5QrcodeLoaded = true;
                    resolve();
                };
                script.onerror = () => reject(new Error('Failed to load html5-qrcode'));
                document.head.appendChild(script);
            });
        };
    </script>
    <!-- تحميل ملف الإصدارات أولاً -->
    <script src="js/version.js"></script>
    <script src="js/api.js" defer></script>
    <script src="js/utils.js" defer></script>
    <script src="js/auth.js" defer></script>
    <script src="js/permissions.js" defer></script>
    <script src="js/indexeddb-cache.js" defer></script>
    <script src="js/barcode.js" defer></script>
    <script src="js/pos.js" defer></script>
    <script src="js/global-notifications.js" defer></script>
    
    <!-- زر الرجوع للصفحة السابقة -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // دالة للرجوع
            function handleBackClick(e) {
                e.preventDefault();
                e.stopPropagation();
                
                try {
                    // التحقق من وجود referrer وليس نفس الصفحة
                    const referrer = document.referrer;
                    const currentUrl = window.location.href;
                    
                    if (referrer && referrer !== currentUrl) {
                        const referrerUrl = new URL(referrer);
                        const currentUrlObj = new URL(currentUrl);
                        
                        // إذا كان referrer من نفس الموقع، استخدم history.back()
                        if (referrerUrl.origin === currentUrlObj.origin) {
                            // التحقق من أن الصفحة السابقة ليست pos.html
                            if (!referrer.includes('pos.html')) {
                                window.history.back();
                                return;
                            }
                        }
                    }
                    
                    // إذا كان هناك تاريخ متاح، استخدم history.back()
                    if (window.history.length > 1) {
                        window.history.back();
                        return;
                    }
                    
                    // Fallback: الانتقال إلى dashboard.html أو index.html
                    window.location.href = 'dashboard.html';
                } catch (error) {
                    console.error('خطأ في الرجوع:', error);
                    // Fallback: الانتقال إلى dashboard.html
                    window.location.href = 'dashboard.html';
                }
            }

            // ربط زر العودة في الهيدر العادي
            const backBtn = document.getElementById('backBtn');
            if (backBtn) {
                backBtn.addEventListener('click', handleBackClick);
            }

            // ربط زر العودة في الهيدر الموبايل
            const backBtnMobile = document.getElementById('backBtnMobile');
            if (backBtnMobile) {
                backBtnMobile.addEventListener('click', handleBackClick);
            }

            // ربط زر QR في الهيدر الموبايل بفتح/إغلاق جزء الكاميرا على الهواتف
            const qrHeaderBtn = document.getElementById('qrHeaderBtn');
            const qrHeaderBtnMobile = document.getElementById('qrHeaderBtnMobile');
            const posQrScannerMobile = document.getElementById('posQrScannerMobile');
            
            // دالة لفتح/إغلاق جزء الكاميرا على الهواتف
            function toggleMobileQRScanner() {
                if (!posQrScannerMobile) return;
                
                const isActive = posQrScannerMobile.classList.contains('active');
                
                if (isActive) {
                    // إغلاق جزء الكاميرا
                    posQrScannerMobile.classList.remove('active');
                    // إيقاف الماسح إذا كان يعمل
                    if (window.stopPOSQRCodeScannerMobile) {
                        window.stopPOSQRCodeScannerMobile();
                    }
                } else {
                    // فتح جزء الكاميرا
                    posQrScannerMobile.classList.add('active');
                    // تهيئة الماسح بعد تأخير لضمان ظهور العنصر
                    setTimeout(() => {
                        if (window.initializePOSQRCodeScannerAuto) {
                            window.initializePOSQRCodeScannerAuto();
                        } else {
                            // انتظار تحميل الدالة
                            let attempts = 0;
                            const checkFunction = setInterval(() => {
                                attempts++;
                                if (window.initializePOSQRCodeScannerAuto) {
                                    clearInterval(checkFunction);
                                    window.initializePOSQRCodeScannerAuto();
                                } else if (attempts > 50) {
                                    clearInterval(checkFunction);
                                    console.error('Failed to load scanner function');
                                }
                            }, 100);
                        }
                    }, 200);
                }
            }
            
            if (qrHeaderBtnMobile && posQrScannerMobile) {
                // على الهواتف: فتح/إغلاق جزء الكاميرا المدمج
                qrHeaderBtnMobile.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // التحقق من أننا على هاتف
                    if (window.innerWidth <= 767.98) {
                        toggleMobileQRScanner();
                    } else {
                        // على سطح المكتب: استخدام السلوك العادي (فتح modal)
                        if (qrHeaderBtn) {
                            qrHeaderBtn.click();
                        }
                    }
                });
            } else if (qrHeaderBtn && qrHeaderBtnMobile) {
                // Fallback: استخدام السلوك العادي إذا لم يوجد جزء الكاميرا المدمج
                qrHeaderBtnMobile.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    qrHeaderBtn.click();
                });
            }
            
            // جعل الدالة متاحة عالمياً
            window.toggleMobileQRScanner = toggleMobileQRScanner;
        });
    </script>
    
    <!-- حماية الصفحة - فحص تسجيل الدخول فوراً -->
    <script>
        (async function protectPage() {
            try {
                // الانتظار حتى يتم تحميل API و auth
                let retries = 0;
                while ((typeof API === 'undefined' || typeof checkLogin !== 'function') && retries < 20) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    retries++;
                }
                
                if (typeof API === 'undefined' || typeof checkLogin !== 'function') {
                    console.error('❌ فشل تحميل ملفات المصادقة - إعادة التوجيه...');
                    window.location.href = 'index.html';
                    return;
                }
                
                // فحص تسجيل الدخول
                const user = await checkLogin();
                if (!user) {
                    console.log('❌ المستخدم غير مسجل دخول - إعادة التوجيه...');
                    window.location.href = 'index.html';
                    return;
                }
                
                console.log('✅ تم التحقق من تسجيل الدخول بنجاح');
            } catch (error) {
                console.error('❌ خطأ في فحص تسجيل الدخول:', error);
                window.location.href = 'index.html';
            }
        })();
    </script>
    
    <script>
        // تحميل الوضع الليلي فوراً - قبل أي شيء آخر
        (function loadDarkModeEarly() {
            try {
                const darkMode = localStorage.getItem('darkMode');
                if (darkMode === 'enabled') {
                    document.body.classList.add('dark-mode');
                }
            } catch (error) {
                console.error('خطأ في تحميل الوضع الليلي:', error);
            }
        })();
        
        // فحص المصادقة عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', async function() {
            // ✅ تحميل الوضع الليلي مرة أخرى للتأكد
            if (typeof loadDarkMode === 'function') {
                loadDarkMode();
            } else {
                const darkMode = localStorage.getItem('darkMode');
                if (darkMode === 'enabled') {
                    document.body.classList.add('dark-mode');
                }
            }
            // انتظار تحميل API و auth.js
            let attempts = 0;
            const maxAttempts = 50; // 5 ثواني كحد أقصى
            
            const checkAuth = async () => {
                if (typeof API === 'undefined' || typeof checkLogin === 'undefined') {
                    attempts++;
                    if (attempts < maxAttempts) {
                        setTimeout(checkAuth, 100);
                        return;
                    } else {
                        console.error('فشل تحميل ملفات المصادقة');
                        window.location.href = 'index.html';
                        return;
                    }
                }
                
                // التحقق من تسجيل الدخول
                const user = await checkLogin();
                if (!user) {
                    // إذا لم يكن مسجل الدخول، التوجيه لصفحة تسجيل الدخول
                    window.location.href = 'index.html';
                    return;
                }
                
                // ✅ إصلاح CSS و Bootstrap Icons عند تحميل الصفحة
                if (typeof ensureCSSAndIconsLoaded === 'function') {
                    ensureCSSAndIconsLoaded();
                }
            };
            
            checkAuth();
        });
        
        // دالة للعودة إلى لوحة التحكم مع تحديد علامة
        function returnToDashboard() {
            // تحديد علامة في sessionStorage للإشارة إلى أننا نعود من pos.html
            sessionStorage.setItem('returning_from_pos', 'true');
            // الانتقال إلى dashboard.html
            window.location.href = 'dashboard.html';
        }
        
        // تسجيل Service Worker لدعم PWA
        const registerServiceWorker = async () => {
            if ('serviceWorker' in navigator) {
                try {
                    // ✅ تحديد المسار الأساسي - Service Worker دائماً في الجذر
                    const getBasePath = () => {
                        try {
                            const pathname = window.location.pathname;
                            // ✅ الحل: إذا كان المسار يحتوي على .html، نستخدم الجذر
                            // لأن Service Worker دائماً في الجذر وليس في مجلد الصفحة
                            if (pathname.includes('.html')) {
                                return ''; // استخدام الجذر
                            }
                            // فقط إذا كان المسار مثل /zidan15/ نستخدمه
                            const match = pathname.match(/^\/([^\/]+)\//);
                            if (match && match[1] && !match[1].includes('.')) {
                                return '/' + match[1];
                            }
                            return ''; // استخدام الجذر دائماً
                        } catch (e) {
                            return ''; // في حالة الخطأ، نستخدم الجذر
                        }
                    };
                    const basePath = getBasePath();
                    // ✅ إصلاح: scope يجب أن ينتهي بـ / دائماً
                    const scope = basePath ? `${basePath}/` : '/';
                    
                    // ✅ محاولة استخدام sw.js.php أولاً، ثم sw.js كبديل
                    let swUrl = basePath ? `${basePath}/sw.js.php` : '/sw.js.php';
                    let registration;
                    
                    try {
                        registration = await navigator.serviceWorker.register(swUrl, {
                            scope: scope,
                            updateViaCache: 'none'
                        });
                        console.log('✅ Service Worker registered in POS (sw.js.php):', registration.scope);
                    } catch (phpError) {
                        // ✅ Fallback: استخدام sw.js مباشرة
                        console.warn('⚠️ sw.js.php failed, trying sw.js as fallback:', phpError.message);
                        swUrl = basePath ? `${basePath}/sw.js` : '/sw.js';
                        registration = await navigator.serviceWorker.register(swUrl, {
                            scope: scope,
                            updateViaCache: 'none'
                        });
                        console.log('✅ Service Worker registered in POS (sw.js fallback):', registration.scope);
                    }
                } catch (error) {
                    console.warn('Service Worker registration failed:', error.message || error);
                }
            }
        };
        
        // تسجيل Service Worker فوراً
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(registerServiceWorker, 100);
            });
        } else {
            setTimeout(registerServiceWorker, 100);
        }
    </script>
</body>
</html>
